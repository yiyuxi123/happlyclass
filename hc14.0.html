<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿«ä¹è¯¾å ‚ - æ——èˆ°ä¼˜åŒ–ç‰ˆ V14.0 (å…¨é¢å¢å¼º)</title>
    <style>
        /* =========================================
           1. CSS æ ¸å¿ƒæ ·å¼ (V14 å¢å¼ºç‰ˆ)
           ========================================= */
        :root {
            --primary-blue: #4facfe;
            --primary-green: #43e97b;
            --primary-yellow: #f6d365;
            --primary-orange: #fda085;
            --primary-purple: #a18cd1;
            --primary-red: #ff758c;
            --text-color: #2d3436;
            --bg-color: #f0f4f8;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            --font-stack: 'PingFang SC', 'Microsoft YaHei', 'Comic Sans MS', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(79, 172, 254, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(67, 233, 123, 0.1) 0%, transparent 20%);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            min-height: 100vh;
        }

        /* --- äº¤äº’ç»„ä»¶ --- */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .btn:not(:disabled):active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        /* æŒ‰é’®å˜ä½“ */
        .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #5a4a00; }
        .btn-danger { background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%); color: white; }
        .btn-purple { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: white; }
        .btn-outline { background: white; border: 2px solid #eee; color: #666; }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        
        /* è¾“å…¥æ¡† */
        select, input, textarea {
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #eee;
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        /* --- å¸ƒå±€ç»“æ„ --- */
        header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        #app {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            padding-bottom: 80px; /* ä¸ºæ‚¬æµ®æŒ‰é’®ç•™ç©º */
        }

        /* --- å¯¼èˆª Tab --- */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            position: relative;
        }

        /* V14æ–°å¢ï¼šéšæœºæ¸¸æˆæŒ‰é’® */
        .random-game-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.3);
        }
        .random-game-btn:hover {
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 6px 15px rgba(255, 154, 158, 0.4);
        }

        .nav-tab {
            padding: 12px 30px;
            border-radius: 50px;
            background: white;
            color: #888;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 2px solid transparent;
        }

        .nav-tab.active {
            background: var(--primary-blue);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3);
        }
        
        .nav-tab.tool-tab.active { background: var(--primary-purple); box-shadow: 0 8px 20px rgba(161, 140, 209, 0.3); }

        /* --- æ¸¸æˆå¡ç‰‡ç½‘æ ¼ --- */
        .game-grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            animation: fadeIn 0.4s ease-out;
        }

        .game-grid.active { display: grid; }

        .game-card {
            background: white;
            border-radius: 24px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .game-card.highlight {
            animation: pulse-highlight 1s infinite;
            border-color: var(--primary-purple);
            box-shadow: 0 15px 30px rgba(161, 140, 209, 0.3);
        }

        @keyframes pulse-highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .game-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--hover-shadow);
            border-color: rgba(79, 172, 254, 0.2);
        }

        .game-card .icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            display: inline-block;
            transition: transform 0.3s;
        }
        
        .game-card:hover .icon { transform: scale(1.2) rotate(5deg); }
        .game-card .icon[data-icon="ğŸ¢"] { color: #1abc9c; }
        .game-card .icon[data-icon="ğŸŒ€"] { color: #9b59b6; }

        .game-card h3 { margin: 10px 0 5px; color: #333; }
        .game-card p { color: #888; font-size: 0.9rem; margin: 0; }

        /* --- æ¸¸æˆè¿è¡Œç•Œé¢ --- */
        .game-screen {
            display: none;
            background: white;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            min-height: 500px;
        }

        .game-screen.active { display: block; }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px dashed #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .screen-header h2 { margin: 0; font-size: 1.8rem; color: #333; display: flex; align-items: center; gap: 10px; }

        /* --- ç§¯åˆ†ä¸è¯„ä»·æ¨¡æ€æ¡† (V14) --- */
        .score-float-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 10px 25px rgba(253, 160, 133, 0.5);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }
        .score-float-btn:hover { transform: scale(1.1) rotate(10deg); }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }

        .modal-card {
            background: white;
            width: 90%;
            max-width: 1000px;
            height: 85vh;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-card { transform: scale(1); }

        .eval-layout { display: flex; height: 100%; overflow: hidden; }
        
        .eval-sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .eval-main { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 12px;
            overflow-y: auto;
            padding: 5px;
        }

        .student-item {
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        .student-item.selected {
            background: #e3f2fd;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            font-weight: bold;
        }
        .student-item .badge {
            position: absolute;
            top: -6px; right: -6px;
            background: var(--primary-orange);
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tag-group {
            margin-bottom: 25px;
            position: relative;
        }

        .tag-group h4 { 
            margin: 0 0 10px; 
            color: #888; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* V14æ–°å¢ï¼šæ·»åŠ æ ‡ç­¾æŒ‰é’®æ ·å¼ */
        .add-tag-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-green);
            color: white;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .add-tag-btn:hover {
            transform: scale(1.1);
            background: #2ecc71;
        }

        .tag-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 10px;
        }

        .tag-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #eee;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tag-btn:hover { transform: translateY(-2px); }
        .tag-btn.pos { color: #2ecc71; border-color: #2ecc71; }
        .tag-btn.pos:hover { background: #e8f5e9; }
        .tag-btn.neg { color: #ff7675; border-color: #ff7675; }
        .tag-btn.neg:hover { background: #ffeaea; }
        
        /* V14æ–°å¢ï¼šæ ‡ç­¾ç¼–è¾‘æ¨¡å¼ */
        .tag-btn.edit-mode {
            background: #f8f9fa;
            border-style: dashed;
        }
        
        .tag-btn .delete-tag-btn {
            background: none;
            border: none;
            color: #ff7675;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tag-btn .delete-tag-btn:hover {
            background: #ff7675;
            color: white;
        }

        /* --- åŠ¨ç”»å…³é”®å¸§ --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.9; } 100% { opacity: 1; } }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-20px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(10px); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

        /* æµ·é¾Ÿæ±¤ä¸è„‘ç­‹æ€¥è½¬å¼¯ç‰¹æœ‰æ ·å¼ */
        #soupStory {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        #soupStory:hover { transform: translateY(-5px); }
        #teaserQuestion { text-shadow: 2px 2px 4px rgba(0,0,0,0.1); animation: pulse 2s infinite; }

        /* --- åŠ è½½åŠ¨ç”» --- */
        .loading-spinner {
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* --- æ–°å¢ç»„ä»¶æ ·å¼ (V14) --- */
        .add-question-btn { font-size: 0.8rem; padding: 4px 10px; }
        .soup-question-item:hover { transform: translateX(5px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .bomb-player-select { transition: all 0.2s; }
        .bomb-player-select:hover { background: #e3f2fd !important; transform: translateY(-2px); }
        
        .player-card {
            background: white; border-radius: 20px; padding: 25px; min-width: 180px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: all 0.3s; border: 3px solid transparent;
        }
        .player-card.active {
            border-color: var(--primary-blue); transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(79, 172, 254, 0.3);
        }
        .player-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .player-score { font-size: 3rem; color: var(--primary-blue); margin-bottom: 10px; }
        .player-status { font-size: 1rem; color: #888; }

        /* --- è¾…åŠ©åŠŸèƒ½ --- */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
        }

        /* --- ä¸‹è¯¾ç»“ç®—ç³»ç»Ÿæ ·å¼ (V14 å¢å¼º) --- */
        .settlement-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        .settlement-tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background: #f0f7ff;
        }

        .ranking-list {
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px;
        }
        .ranking-item {
            display: flex; align-items: center; background: white; border-radius: 15px; padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .ranking-item:hover { transform: translateX(5px); }
        .rank-badge {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; margin-right: 15px;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #856404; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #495057; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #e6b17e 100%); color: #664d03; }
        .rank-other { background: #f8f9fa; color: #666; }

        /* V14ä¼˜åŒ–ï¼šå¥–å“åˆ—è¡¨ç®¡ç†æ ·å¼ */
        .prize-list-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid #eee;
            transition: all 0.2s;
        }
        
        .prize-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .prize-item .prize-text {
            flex: 1;
            font-weight: 500;
        }
        
        .prize-item .delete-prize-btn {
            background: none;
            border: none;
            color: #ff7675;
            font-size: 1.2rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .prize-item .delete-prize-btn:hover {
            background: #ff7675;
            color: white;
        }

        .lottery-area {
            display: flex; flex-direction: column; align-items: center; gap: 25px; padding: 20px;
            background: #f8f9fa; border-radius: 15px; margin-bottom: 30px;
        }
        .lottery-display {
            width: 300px; height: 100px; background: white; border: 3px dashed var(--primary-purple);
            border-radius: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: bold; color: var(--primary-purple); transition: all 0.3s;
        }
        .lottery-display.spinning { animation: pulse 0.5s infinite; border-color: var(--primary-orange); }
        .lottery-result {
            background: #e8f5e9; border: 2px solid #2ecc71; border-radius: 10px; padding: 15px;
            margin-top: 15px; display: none;
        }
        .lottery-result.show { display: block; animation: slideUp 0.3s ease-out; }

        .report-summary {
            background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .report-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;
        }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary-blue); margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 0.9rem; }

        /* --- è™šæ‹Ÿé”®ç›˜æ ·å¼ (V14 å®Œå…¨é‡æ„) --- */
        .virtual-keyboard {
            display: grid;
            gap: 5px;
            padding: 10px;
            background: #f0f4f8;
            border-radius: 12px;
            margin-top: 5px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .keyboard-key {
            padding: 12px 0;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
            transition: all 0.1s;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .keyboard-key:active { transform: translateY(2px); box-shadow: none; background: #f0f0f0; }
        .keyboard-key.wide { grid-column: span 2; }
        .keyboard-key.action { background: var(--primary-blue); color: white; }
        .keyboard-key.action:active { background: #3d9ff7; }
        .keyboard-key.operator { background: #dfe6e9; }
        .keyboard-key.clear { background: #ff7675; color: white; }
        .keyboard-key.clear:active { background: #ff5c5c; }
        .keyboard-key.submit { background: #2ecc71; color: white; }
        .keyboard-key.submit:active { background: #27ae60; }
        
        .keyboard-title {
            font-size: 0.9rem; color: #666; margin-bottom: 5px; 
            text-align: center; font-weight: bold;
        }

        /* æ•°å­¦é”®ç›˜ä¸“ç”¨å¸ƒå±€ */
        .math-keyboard {
            grid-template-columns: repeat(5, 1fr) !important;
        }
        
        /* æ‹¼å†™é”®ç›˜ä¸“ç”¨å¸ƒå±€ - V14ä¼˜åŒ–æ”¯æŒå¤šç‚¹è§¦æ§ */
        .spelling-keyboard {
            grid-template-columns: repeat(10, 1fr) !important;
            touch-action: manipulation;
        }
        
        .spelling-keyboard .keyboard-key {
            touch-action: manipulation;
            pointer-events: auto;
        }

        /* --- å•è¯æ‹¼å†™æŒ–ç©ºæ ·å¼ (V14 ä¼˜åŒ–) --- */
        .blank-char {
            display: inline-block; width: 35px; 
            border-bottom: 3px solid var(--primary-blue);
            margin: 0 3px; text-align: center; 
            font-size: 2rem; font-weight: bold;
            color: transparent;
            transition: all 0.3s;
        }
        .blank-char.filled {
            color: var(--primary-green);
            border-bottom-color: var(--primary-green);
        }

        /* --- æ¶ˆæ¯ç³»ç»Ÿæ ·å¼ (V14 ä¼˜åŒ–) --- */
        #message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            pointer-events: none;
        }
        .message {
            background: #74b9ff;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease-out;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .message-success { background: #2ecc71; }
        .message-error { background: #ff7675; }
        .message-warning { background: #fdcb6e; }
        .message-info { background: #74b9ff; }
        .message-question { background: #a29bfe; }

        /* --- æ‰¹é‡å¯¼å…¥å¯¹è¯æ¡†æ ·å¼ - V14ä¿®å¤ --- */
        .bulk-import-dialog {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s;
        }

        /* V14ä¿®å¤ï¼šå•é€‰æ¡†æ ‡ç­¾æ°´å¹³æ’åˆ— */
        .format-radio-group {
            display: flex !important;
            gap: 15px !important;
            flex-wrap: nowrap !important;
            white-space: nowrap !important;
        }
        
        .format-radio-group label {
            display: flex !important;
            align-items: center !important;
            gap: 5px !important;
            white-space: nowrap !important;
        }

        /* --- éšè—æ¸¸æˆæ ·å¼ --- */
        .game-card.hidden {
            opacity: 0.5;
            filter: grayscale(50%);
        }

        /* --- å¯å¤åˆ¶æ–‡æœ¬æ ·å¼ --- */
        .copyable-text {
            user-select: text;
            cursor: text;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        /* --- æŠ½å¥–ç»“æœæ ·å¼ --- */
        .lottery-result-item {
            animation: slideUp 0.5s ease-out;
            margin-bottom: 10px;
        }

        /* --- æ•°å­—é”®ç›˜æ ·å¼ --- */
        .numeric-keyboard {
            grid-template-columns: repeat(4, 1fr) !important;
        }

        /* --- ä½ ç”»æˆ‘çŒœå¸¸é©»æç¤ºé¢æ¿ (V14 å¢å¼º) --- */
        .draw-permanent-hint {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 300px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1001;
            border-left: 5px solid var(--primary-purple);
            animation: slideInRight 0.3s ease-out;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .draw-permanent-hint h4 {
            margin-top: 0;
            color: var(--primary-purple);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .hint-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .hint-item.locked {
            opacity: 0.5;
            filter: blur(5px);
        }
        .hint-item.unlocked {
            background: #e3f2fd;
            border-left: 3px solid var(--primary-blue);
        }
        .hint-label {
            font-weight: bold;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }
        .hint-content {
            font-weight: bold;
            color: #333;
        }
        .hint-timer {
            margin-top: 10px;
            padding: 8px;
            background: #ffeaa7;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: #d63031;
        }

        /* --- å“åº”å¼é€‚é… --- */
        @media (max-width: 768px) {
            .eval-layout { flex-direction: column; }
            .eval-sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #eee; }
            .game-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .game-card { padding: 15px; }
            .game-card .icon { font-size: 2.5rem; }
            .nav-tab { padding: 8px 15px; font-size: 0.9rem; }
            .score-float-btn { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 1.5rem; }
            .player-card { min-width: 140px; padding: 15px; }
            .player-score { font-size: 2rem; }
            .virtual-keyboard { gap: 3px; padding: 5px; }
            .keyboard-key { padding: 10px 0; font-size: 1rem; }
            .blank-char { width: 25px; font-size: 1.5rem; }
            .draw-permanent-hint {
                top: 80px;
                right: 15px;
                width: 250px;
                padding: 15px;
            }
            .math-keyboard {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            .spelling-keyboard {
                grid-template-columns: repeat(6, 1fr) !important;
            }
            .format-radio-group {
                flex-direction: column !important;
                gap: 10px !important;
            }
        }
        
        /* --- é¢˜åº“æŸ¥çœ‹é¡µé¢æ ·å¼ --- */
        .question-bank-container {
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .question-category {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .question-category h3 {
            margin-top: 0;
            color: var(--primary-blue);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .question-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary-blue);
        }
        .question-item .question-text {
            font-weight: 500;
            margin-bottom: 5px;
        }
        .question-item .answer-text {
            color: #666;
            font-size: 0.9rem;
            padding-left: 10px;
            border-left: 2px solid #ddd;
        }
        .question-count {
            display: inline-block;
            background: var(--primary-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        /* --- è®¾ç½®é¡µé¢æ ·å¼ä¼˜åŒ– (V14 é‡æ–°è®¾è®¡) --- */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .settings-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        .settings-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-blue);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .settings-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }
        .settings-checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            transition: all 0.2s;
            border: 2px solid #eee;
        }
        .settings-checkbox-item:hover {
            background: #f0f4f8;
            border-color: var(--primary-blue);
        }
        .settings-checkbox-item:last-child {
            margin-bottom: 0;
        }
        .settings-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .settings-checkbox-item label {
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }
        
        /* --- è§„åˆ™è¯´æ˜æ¨¡æ€æ¡†æ ·å¼ (V14 æ–°å¢) --- */
        .rules-container {
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }
        .rules-category {
            margin-bottom: 25px;
        }
        .rules-category h4 {
            color: var(--primary-blue);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }
        .rules-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-green);
        }
        .rules-item.negative {
            border-left-color: var(--primary-red);
        }
        .rules-point {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }
        .rules-desc {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* --- ç”»ç¬”åé¦ˆæ ·å¼ - V14æ–°å¢æ©¡çš®æ“¦ --- */
        .color-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .color-btn:hover {
            transform: scale(1.1);
        }
        .color-btn.active {
            border-color: var(--primary-blue);
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }
        
        .color-btn.eraser {
            background: white;
            color: #333;
            border: 2px solid #ddd;
        }
        
        .color-btn.eraser.active {
            border-color: var(--primary-red);
            background: #ffeaea;
        }
        
        /* --- é¢˜åº“å¯¼å…¥æ ‡ç­¾æ ·å¼ --- */
        .import-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .import-tag-draw { background: #ffeaa7; color: #d63031; }
        .import-tag-soup { background: #81ecec; color: #0984e3; }
        .import-tag-teaser { background: #fab1a0; color: #e17055; }
        .import-tag-math { background: #a29bfe; color: #6c5ce7; }
        .import-tag-spelling { background: #55efc4; color: #00b894; }
        
        /* --- é¢˜åº“ç±»å‹é€‰æ‹©å™¨æ ·å¼ --- */
        .import-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .import-type-btn {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .import-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .import-type-btn.selected {
            border-color: var(--primary-blue);
            background: #e3f2fd;
        }
        
        /* --- æŠ½å¥–è‡ªå®šä¹‰å¥–å“è¾“å…¥æ ·å¼ --- */
        .custom-prize-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 1rem;
        }
        .custom-prize-btn {
            margin-top: 10px;
            width: 100%;
        }
        
        /* --- åˆ†æ•°æ˜¾ç¤ºç»Ÿä¸€ç²¾åº¦æ ·å¼ --- */
        .score-display {
            font-weight: bold;
            color: var(--primary-blue);
        }
        .score-display::after {
            content: attr(data-decimal);
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        /* V14æ–°å¢ï¼šçœ¼ç–¾æ‰‹å¿«é€‰æ‰‹åå•å¼¹çª— */
        .players-confirm-dialog {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .players-confirm-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .players-list {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-confirm-item {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary-blue);
        }
        
        /* V14æ–°å¢ï¼šæµ·é¾Ÿæ±¤çº¿ç´¢æ ·å¼ */
        .soup-clues {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .clue-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid var(--primary-purple);
            display: none;
        }
        
        .clue-item.unlocked {
            display: block;
            animation: slideUp 0.5s ease-out;
        }
        
        .clue-label {
            font-weight: bold;
            color: var(--primary-purple);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* V14æ–°å¢ï¼šè¯„ä»·æ ‡ç­¾ç®¡ç†å¼¹çª— */
        .tag-manager-dialog {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .tag-manager-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .tag-manager-section {
            margin-bottom: 25px;
        }
        
        .tag-edit-mode-btn {
            margin-left: 10px;
            padding: 4px 10px;
            font-size: 0.8rem;
            background: var(--primary-yellow);
            color: #5a4a00;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- æ¶ˆæ¯å®¹å™¨ -->
<div id="message-container"></div>

<!-- ä½ ç”»æˆ‘çŒœå¸¸é©»æç¤ºé¢æ¿ -->
<div id="drawPermanentHint" class="draw-permanent-hint" style="display: none;">
    <h4>ğŸ’¡ æœ¬è½®æç¤º</h4>
    <div class="hint-item locked" id="hintType">
        <div class="hint-label">åˆ†ç±»</div>
        <div class="hint-content">å‰©ä½™50ç§’è§£é”</div>
    </div>
    <div class="hint-item locked" id="hintLength">
        <div class="hint-label">å­—æ•°</div>
        <div class="hint-content">å‰©ä½™40ç§’è§£é”</div>
    </div>
    <div class="hint-item locked" id="hintRandomChar">
        <div class="hint-label">åŒ…å«çš„å­—</div>
        <div class="hint-content">å‰©ä½™30ç§’è§£é”</div>
    </div>
    <div class="hint-timer">
        å‰©ä½™æ—¶é—´: <span id="drawPermanentTimer">60</span>ç§’
    </div>
</div>

<!-- è¯„ä»·æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="scoreModal">
    <div class="modal-card">
        <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
            <h3 style="margin:0;">ğŸ“ ç­çº§è¯„ä»·ä¸­å¿ƒ</h3>
            <div>
                <button class="btn btn-sm btn-warning" onclick="scoreSys.toggleTagEditMode()" id="tagEditModeBtn">ç®¡ç†æ ‡ç­¾</button>
                <button class="btn btn-sm btn-outline" onclick="scoreSys.close()">å…³é—­</button>
            </div>
        </div>
        
        <div class="eval-layout">
            <div class="eval-sidebar">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-weight:bold; color:#666;">å­¦ç”Ÿåå•</span>
                    <div style="font-size:0.8rem;">
                        <a href="javascript:;" onclick="scoreSys.selectAll()" style="color:var(--primary-blue)">å…¨é€‰</a> / 
                        <a href="javascript:;" onclick="scoreSys.deselectAll()" style="color:#999">å–æ¶ˆ</a>
                    </div>
                </div>
                <div class="student-grid" id="studentGrid"></div>
            </div>

            <div class="eval-main">
                <div class="tag-group">
                    <h4>ğŸ‘ ç§¯æè¡¨ç° (+1~+3) <button class="add-tag-btn" onclick="scoreSys.showAddTagDialog('positive')">+</button></h4>
                    <div class="tag-list" id="positiveTags">
                        <!-- åŠ¨æ€ç”Ÿæˆæ ‡ç­¾ -->
                    </div>
                </div>

                <div class="tag-group">
                    <h4>âš ï¸ å¾…æ”¹è¿› (-1) <button class="add-tag-btn" onclick="scoreSys.showAddTagDialog('negative')">+</button></h4>
                    <div class="tag-list" id="negativeTags">
                        <!-- åŠ¨æ€ç”Ÿæˆæ ‡ç­¾ -->
                    </div>
                </div>
                
                <div class="tag-group">
                    <h4>ğŸŒŸ ç‰¹åˆ«é¼“åŠ± (+2~+3) <button class="add-tag-btn" onclick="scoreSys.showAddTagDialog('special')">+</button></h4>
                    <div class="tag-list" id="specialTags">
                        <!-- åŠ¨æ€ç”Ÿæˆæ ‡ç­¾ -->
                    </div>
                </div>

                <div style="margin-top: auto; border-top: 1px solid #eee; padding-top: 20px;">
                    <h4 style="margin-bottom:10px;">ğŸ› ï¸ æ‰¹é‡æ“ä½œä¸æ•°æ®ç®¡ç†</h4>
                    <div style="display:flex; gap: 10px; margin-bottom: 15px;">
                        <input type="number" id="customScore" placeholder="åˆ†å€¼" step="0.5" min="-10" max="10" style="width: 100px;">
                        <input type="text" id="customReason" placeholder="è‡ªå®šä¹‰ç†ç”±..." style="flex:2;" maxlength="50">
                        <button class="btn btn-primary" onclick="scoreSys.applyCustom()">æäº¤</button>
                    </div>
                    <div style="display:flex; gap: 10px;">
                        <button class="btn btn-purple" style="flex:1" onclick="GameStats.exportReport()">ğŸ“Š ç”ŸæˆæŠ¥è¡¨</button>
                        <button class="btn btn-outline" style="flex:1" onclick="DataManager.exportData()">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
                        <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('importFile').click()">ğŸ“‚ æ¢å¤æ•°æ®</button>
                        <input type="file" id="importFile" style="display:none" onchange="DataManager.importData(this)">
                        <button class="btn btn-outline" style="flex:1" onclick="QuestionManager.showBulkImportMenu()">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button>
                    </div>
                    <div style="margin-top: 10px; text-align: right;">
                        <button class="btn btn-danger btn-sm" onclick="scoreSys.resetAllScores()">ğŸ”„ é‡ç½®åˆ†æ•°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä¸‹è¯¾ç»“ç®—æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="settlementModal">
    <div class="modal-card" style="max-width: 800px; height: 90vh;">
        <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
            <h3 style="margin:0;">ğŸ† ä¸‹è¯¾ç»“ç®—ä¸­å¿ƒ</h3>
            <button class="btn btn-sm btn-outline" onclick="SettlementSystem.close()">å…³é—­</button>
        </div>
        
        <div style="display: flex; flex-direction: column; height: calc(100% - 60px); padding: 0;">
            <div style="display: flex; border-bottom: 1px solid #eee;">
                <button class="settlement-tab active" onclick="SettlementSystem.switchTab('ranking')">ğŸ“Š æˆç»©æ’å</button>
                <button class="settlement-tab" onclick="SettlementSystem.switchTab('lottery')">ğŸ å‰ä¸‰æŠ½å¥–</button>
                <button class="settlement-tab" onclick="SettlementSystem.switchTab('report')">ğŸ“‹ è¯¾å ‚æŠ¥å‘Š</button>
                <button class="settlement-tab" onclick="SettlementSystem.switchTab('questionBank')">ğŸ“š æŸ¥çœ‹é¢˜åº“</button>
            </div>
            
            <div id="settlementContent" style="flex: 1; overflow-y: auto; padding: 20px;"></div>
            
            <div style="border-top: 1px solid #eee; padding: 15px 20px; background: #f8f9fa; display: flex; justify-content: space-between;">
                <button class="btn btn-outline" onclick="GameStats.exportFullReport()">ğŸ“„ å¯¼å‡ºè¯¦ç»†æŠ¥è¡¨</button>
                <button class="btn btn-primary" onclick="SettlementSystem.copyClassSummary()" id="copySummaryBtn">
                    ğŸ“‹ ä¸€é”®å¤åˆ¶è¯¾å ‚æƒ…å†µ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è®¾ç½®æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="settingsModal">
    <div class="modal-card" style="max-width: 600px;">
        <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
            <button class="btn btn-sm btn-outline" onclick="document.getElementById('settingsModal').style.display='none'">å…³é—­</button>
        </div>
        <div style="padding: 20px;">
            <div class="settings-grid">
                <div class="settings-section">
                    <h4>æ¸¸æˆæ˜¾ç¤ºè®¾ç½®</h4>
                    <div class="settings-checkbox-group">
                        <div class="settings-checkbox-item">
                            <input type="checkbox" id="hideRiddleSoup" onchange="GameApp.toggleGameVisibility('riddleSoup', this.checked)">
                            <label for="hideRiddleSoup">éšè—æµ·é¾Ÿæ±¤æ¸¸æˆ</label>
                        </div>
                        <div class="settings-checkbox-item">
                            <input type="checkbox" id="hideBrainTeaser" onchange="GameApp.toggleGameVisibility('brainTeaser', this.checked)">
                            <label for="hideBrainTeaser">éšè—è„‘ç­‹æ€¥è½¬å¼¯æ¸¸æˆ</label>
                        </div>
                        <div class="settings-checkbox-item">
                            <input type="checkbox" id="hideDrawGuess" onchange="GameApp.toggleGameVisibility('drawGuess', this.checked)">
                            <label for="hideDrawGuess">éšè—ä½ ç”»æˆ‘çŒœæ¸¸æˆ</label>
                        </div>
                        <div class="settings-checkbox-item">
                            <input type="checkbox" id="hideNumberBomb" onchange="GameApp.toggleGameVisibility('numberBomb', this.checked)">
                            <label for="hideNumberBomb">éšè—æ•°å­—ç‚¸å¼¹æ¸¸æˆ</label>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4>é¢˜åº“è®¾ç½®</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" onclick="QuestionManager.importFromFile()">
                            ğŸ“ å¯¼å…¥é¢˜åº“æ–‡ä»¶
                        </button>
                        <button class="btn btn-outline" onclick="QuestionManager.showQuestionBank()">
                            ğŸ“š æŸ¥çœ‹é¢˜åº“
                        </button>
                        <button class="btn btn-outline" onclick="RulesManager.showRules()">
                            ğŸ“– æŸ¥çœ‹å¾—åˆ†è§„åˆ™
                        </button>
                        <p style="color:#666; font-size:0.9rem; margin-top:10px;">
                            æ”¯æŒJSONæ ¼å¼é¢˜åº“æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰æ¸¸æˆæ¨¡å¼çš„é¢˜ç›®
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é¢˜åº“æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="questionBankModal">
    <div class="modal-card" style="max-width: 900px; height: 90vh;">
        <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
            <h3 style="margin:0;">ğŸ“š é¢˜åº“æ€»è§ˆ</h3>
            <button class="btn btn-sm btn-outline" onclick="document.getElementById('questionBankModal').style.display='none'">å…³é—­</button>
        </div>
        <div id="questionBankContent" class="question-bank-container">
            <!-- é¢˜åº“å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- å¾—åˆ†è§„åˆ™è¯´æ˜æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="rulesModal">
    <div class="modal-card" style="max-width: 700px; height: 80vh;">
        <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
            <h3 style="margin:0;">ğŸ“– å¾—åˆ†è§„åˆ™è¯´æ˜</h3>
            <button class="btn btn-sm btn-outline" onclick="document.getElementById('rulesModal').style.display='none'">å…³é—­</button>
        </div>
        <div id="rulesContent" class="rules-container">
            <!-- è§„åˆ™å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- æ‚¬æµ®æŒ‰é’® -->
<div class="score-float-btn" onclick="scoreSys.open()" aria-label="æ‰“å¼€è¯„åˆ†é¢æ¿" style="z-index: 1002;">ğŸ†</div>
<div class="score-float-btn" onclick="SettlementSystem.open()" aria-label="æ‰“å¼€ç»“ç®—é¢æ¿" style="bottom: 110px; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); z-index: 1001;">ğŸ</div>

<!-- å¤´éƒ¨ -->
<header>
    <h1 class="app-title">ğŸˆ å¿«ä¹è¯¾å ‚ V14.0</h1>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-sm btn-outline" onclick="SoundManager.toggle()" id="soundToggleBtn">ğŸ”Š</button>
        <button class="btn btn-sm btn-primary" onclick="GameApp.showLobby()">ğŸ  å¤§å…</button>
        <button class="btn btn-sm btn-outline" onclick="QuestionManager.showQuestionBank()">ğŸ“š é¢˜åº“</button>
        <button class="btn btn-sm btn-outline" onclick="GameApp.showSettings()">âš™ï¸ è®¾ç½®</button>
    </div>
</header>

<div id="app">
    <!-- å¯¼èˆª -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="GameApp.switchTab('games')">ğŸ® ç»¼åˆæ¸¸æˆ</div>
        <div class="nav-tab" onclick="GameApp.switchTab('academic')">ğŸ“š å­¦ç§‘æ¯”æ‹¼</div>
        <div class="nav-tab tool-tab" onclick="GameApp.switchTab('tools')">ğŸ› ï¸ ç­çº§å·¥å…·</div>
        <!-- V14æ–°å¢ï¼šéšæœºæ¸¸æˆæŒ‰é’® -->
        <button class="random-game-btn" onclick="GameApp.selectRandomGame()">ğŸ² éšæœºæ¸¸æˆ</button>
    </div>

    <!-- 1. ç»¼åˆæ¸¸æˆå¤§å… -->
    <div id="games-lobby" class="game-grid active">
        <div class="game-card" onclick="GameApp.startGame('drawGuess')">
            <span class="icon">ğŸ¨</span>
            <h3>ä½ ç”»æˆ‘çŒœ</h3>
            <p>æ™ºèƒ½æç¤º | äº’åŠ¨ç«çŒœ</p>
        </div>
        <!-- V14æ–°å¢ï¼šåœ¨ç»¼åˆæ¸¸æˆå¤§å…ä¹Ÿæ˜¾ç¤ºæ•°å­¦é€Ÿç®— -->
        <div class="game-card" onclick="GameApp.startGame('math')">
            <span class="icon">ğŸ§®</span>
            <h3>é€Ÿç®—ç«é€Ÿ</h3>
            <p>åŒäººç«æŠ€ | æ•°å­—é”®ç›˜</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('spelling')">
            <span class="icon">ğŸ“</span>
            <h3>å•è¯æ‹¼å†™ç«èµ›</h3>
            <p>æŒ–ç©ºå¡«ç©º | åŒäººç«æŠ€</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('riddleSoup')">
            <span class="icon" data-icon="ğŸ¢">ğŸ¢</span>
            <h3>æµ·é¾Ÿæ±¤æ¨ç†</h3>
            <p>é€»è¾‘æ¨ç† | æé—®èƒ½åŠ›</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('brainTeaser')">
            <span class="icon" data-icon="ğŸŒ€">ğŸŒ€</span>
            <h3>è„‘ç­‹æ€¥è½¬å¼¯</h3>
            <p>æ€ç»´å‘æ•£ | å¿«é€Ÿååº”</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('reflex')">
            <span class="icon">âš¡</span>
            <h3>çœ¼ç–¾æ‰‹å¿«</h3>
            <p>æ¯«ç§’çº§ååº”ç«æŠ€</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('numberBomb')">
            <span class="icon">ğŸ’£</span>
            <h3>æ•°å­—ç‚¸å¼¹</h3>
            <p>å¤šäººè½®æµ | æƒ©ç½šæœºåˆ¶</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('reverseGame')">
            <span class="icon">ğŸ¤ª</span>
            <h3>æ­£è¯åè¯´</h3>
            <p>é€†å‘æ€ç»´æŒ‘æˆ˜</p>
        </div>
    </div>

    <!-- 2. å­¦ç§‘å¤§å… -->
    <div id="academic-lobby" class="game-grid">
        <div class="game-card" onclick="GameApp.startGame('math')">
            <span class="icon">ğŸ§®</span>
            <h3>é€Ÿç®—ç«é€Ÿ</h3>
            <p>åŒäººç«æŠ€ | æ•°å­—é”®ç›˜</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('spelling')">
            <span class="icon">ğŸ“</span>
            <h3>å•è¯æ‹¼å†™ç«èµ›</h3>
            <p>æŒ–ç©ºæ¨¡å¼ | åŒäººç«æŠ€</p>
        </div>
    </div>

    <!-- 3. å·¥å…·å¤§å… -->
    <div id="tools-lobby" class="game-grid">
        <div class="game-card" onclick="GameApp.startGame('namePicker')">
            <span class="icon">ğŸ™‹â€â™‚ï¸</span>
            <h3>éšæœºç‚¹å</h3>
            <p>é…ç½®ç­çº§åå•</p>
        </div>
        <div class="game-card" onclick="GameApp.startGame('lottery')">
            <span class="icon">ğŸ</span>
            <h3>å¹¸è¿æŠ½å¥–</h3>
            <p>å¥–åŠ±ç»“ç®—</p>
        </div>
    </div>

    <!-- ==================== æ¸¸æˆç•Œé¢åŒºåŸŸ ==================== -->

    <!-- æ¸¸æˆ: ä½ ç”»æˆ‘çŒœ -->
    <div id="game-drawGuess" class="game-screen">
        <div class="screen-header">
            <h2>ğŸ¨ ä½ ç”»æˆ‘çŒœ</h2>
            <div>
                <span id="drawTimer" style="font-weight:bold; color:red; font-size:1.5rem; margin-right:15px;">60s</span>
                <button class="btn btn-primary" id="drawStartBtn" onclick="drawGame.enhancedSelectPainter()">ğŸ² æŠ½å–ç”»å®¶</button>
            </div>
        </div>
        
        <div id="drawSetup" style="text-align:center; padding:40px;">
            <h3>ğŸ‘¨â€ğŸ¨ ç”»å®¶æŠ½å–ç¯èŠ‚</h3>
            <div id="painterDisplay" style="font-size:3rem; margin:30px 0; color:var(--primary-blue); font-weight:bold;">???</div>
            <div style="margin-bottom:20px;">
                <p style="color:#666; margin-bottom:20px;">ç”»å®¶è¯·ä¸Šå°ï¼Œå…¶ä»–åŒå­¦è¯·é—­çœ¼ ğŸ‘€</p>
                <button class="btn btn-warning" onclick="drawGame.showWordToPainter()">ğŸ‘ï¸ ç”»å®¶çœ‹é¢˜</button>
            </div>
        </div>
        
        <div id="drawPlay" style="display:none;">
            <div style="display:flex; gap:20px; height:500px;">
                <div style="flex:3; border:3px solid #eee; border-radius:15px; position:relative;">
                    <canvas id="drawCanvas" style="width:100%; height:100%; touch-action:none;"></canvas>
                </div>
                <div style="flex:1; display:flex; flex-direction:column; gap:15px; background:#f9f9f9; padding:15px; border-radius:15px;">
                    <div id="drawWordArea" style="background:#fff; padding:15px; text-align:center; border-radius:10px; border:2px dashed var(--primary-purple);">
                        <small style="color:#999;">é¢˜ç›® (ä»…ç”»å®¶å¯è§)</small>
                        <div id="drawWordText" style="font-size:2rem; font-weight:bold; color:#ff6b6b;">???</div>
                        <button class="btn btn-sm btn-outline" style="margin-top:5px;" onclick="drawGame.toggleWord()">ğŸ‘ï¸ æ˜¾/éš</button>
                    </div>
                    
                    <div id="drawColors" style="display:flex; gap:5px; flex-wrap:wrap; padding:5px; background:#fff; border-radius:10px; border:1px solid #eee;"></div>
                    
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-outline" onclick="drawGame.clear()" style="flex:1">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="btn btn-outline" onclick="drawGame.undo()" style="flex:1">â†©ï¸ æ’¤é”€</button>
                    </div>
                    
                    <div style="margin-top:auto; border-top:1px solid #ddd; padding-top:10px;">
                        <small>è°çŒœå¯¹äº†ï¼Ÿ</small>
                        <select id="drawWinnerSelect" style="width:100%; margin:5px 0;"></select>
                        <button class="btn btn-success" style="width:100%" onclick="drawGame.confirmWin()">âœ… ç¡®è®¤åŠ åˆ†</button>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center; margin-top:20px; padding:15px; background:#e3f2fd; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:1.1rem;">ğŸ¨ å½“å‰ç”»å®¶ï¼š<span id="currentPainter" style="font-weight:bold; color:var(--primary-blue);"></span></span>
                <button class="btn btn-primary" onclick="drawGame.startTimer()">â±ï¸ å¤§å®¶ççœ¼ (å¼€å§‹è®¡æ—¶)</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆ: æµ·é¾Ÿæ±¤ (V14é‡æ„) -->
    <div id="game-riddleSoup" class="game-screen">
        <div class="screen-header">
            <h2>ğŸ¢ æµ·é¾Ÿæ±¤æ¨ç† V14</h2>
            <div>
                <span id="soupQuestionCount" style="color:#666; font-weight:bold;">æé—®: 0</span>
                <button class="btn btn-purple" onclick="riddleSoup.showHint()">ğŸ’¡ æç¤º</button>
            </div>
        </div>
        <div style="text-align:center; padding:10px;">
            <div id="soupStory" style="background:#f8f9fa; padding:25px; border-radius:15px; margin-bottom:20px; border-left:5px solid var(--primary-purple); text-align:left;">
                <h3 style="margin-top:0;">ğŸ“– æ•…äº‹è°œé¢</h3>
                <p id="storyText" style="font-size:1.2rem; line-height:1.6; color:#444;">...</p>
            </div>
            
            <!-- V14æ–°å¢ï¼šçº¿ç´¢æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="soup-clues" id="soupCluesArea">
                <h4 style="margin-top:0; color:var(--primary-purple);">ğŸ” çº¿ç´¢</h4>
                <div class="clue-item" id="clue1">
                    <div class="clue-label"><span>ğŸ’¡</span> çº¿ç´¢ 1</div>
                    <div id="clue1Text">æé—®2ä¸ªé—®é¢˜åè§£é”</div>
                </div>
                <div class="clue-item" id="clue2">
                    <div class="clue-label"><span>ğŸ’¡</span> çº¿ç´¢ 2</div>
                    <div id="clue2Text">æé—®5ä¸ªé—®é¢˜åè§£é”</div>
                </div>
            </div>
            
            <div style="display:flex; gap:15px; justify-content:center; margin-bottom:20px;">
                <button class="btn btn-success" onclick="riddleSoup.markQuestion('æ˜¯')">âœ… æ˜¯</button>
                <button class="btn btn-danger" onclick="riddleSoup.markQuestion('å¦')">âŒ å¦</button>
                <button class="btn btn-outline" onclick="riddleSoup.markQuestion('ä¸æ¡ˆæƒ…æ— å…³')">â– æ— å…³</button>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="soupQuestionInput" placeholder="è¾“å…¥å­¦ç”Ÿçš„é—®é¢˜..." style="flex:1;">
                <button class="btn btn-primary" onclick="riddleSoup.submitQuestion()">ğŸ“ è®°å½•</button>
            </div>

            <div id="soupQuestions" style="height:250px; overflow-y:auto; border:1px solid #eee; border-radius:10px; padding:15px; margin-bottom:20px; text-align:left; background:white;">
                <h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">æé—®è®°å½•ï¼š</h4>
            </div>
            
            <button class="btn btn-primary" onclick="riddleSoup.revealAnswer()">ğŸ” æ­ç¤ºçœŸç›¸</button>
        </div>
    </div>

    <!-- æ¸¸æˆ: è„‘ç­‹æ€¥è½¬å¼¯ -->
    <div id="game-brainTeaser" class="game-screen">
        <div class="screen-header">
            <h2>ğŸŒ€ è„‘ç­‹æ€¥è½¬å¼¯</h2>
            <div>
                <span id="teaserTimer" style="font-weight:bold; color:red; font-size:1.5rem; margin-right:15px;">30s</span>
                <button class="btn btn-warning" onclick="brainTeaser.next()">ğŸ”„ ä¸‹ä¸€é¢˜</button>
            </div>
        </div>
        
        <div style="text-align:center; padding:30px;">
            <div id="teaserQuestion" style="font-size:2.5rem; font-weight:bold; color:var(--primary-purple); margin:30px 0; min-height:120px; display:flex; align-items:center; justify-content:center;">
                é¢˜ç›®åŠ è½½ä¸­...
            </div>
            
            <div style="margin:40px 0;">
                <button class="btn btn-lg btn-primary" onclick="brainTeaser.showAnswer()">ğŸ¤” çœ‹ç­”æ¡ˆ</button>
            </div>
            
            <div id="teaserAnswer" style="display:none; font-size:2rem; color:#2ecc71; margin:20px 0; padding:20px; background:#f8fff9; border-radius:15px; border:2px dashed #2ecc71;">
                <strong>ç­”æ¡ˆï¼š</strong>...
            </div>
            
            <div style="margin-top:40px; border-top:1px solid #eee; padding-top:20px;">
                <div style="display:flex; justify-content:center; gap:10px; align-items:center;">
                    <select id="teaserWinner" style="width:200px;">
                        <option value="">é€‰æ‹©ç­”å¯¹çš„å­¦ç”Ÿ...</option>
                    </select>
                    <button class="btn btn-success" onclick="brainTeaser.awardPoints()">ğŸ† åŠ åˆ†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆ: çœ¼ç–¾æ‰‹å¿« (V14ä¼˜åŒ–) -->
    <div id="game-reflex" class="game-screen">
        <div class="screen-header">
            <h2>âš¡ çœ¼ç–¾æ‰‹å¿«</h2>
            <button class="btn btn-warning" onclick="reflexGame.reset()">ğŸ”„ é‡ç½®æ¯”èµ›</button>
        </div>
        
        <div id="reflexSetup" style="text-align:center; padding:40px;">
            <h3>é€‰æ‹©å‚èµ›äººæ•°</h3>
            <div style="margin-bottom:20px;">
                <label>å‚èµ›äººæ•°: </label>
                <input type="number" id="reflexCount" value="5" min="2" max="10" style="width:80px; text-align:center;">
            </div>
            <button class="btn btn-primary" onclick="reflexGame.prepareWithSelection()">ğŸ² æŠ½å–é€‰æ‰‹</button>
        </div>

        <!-- V14æ–°å¢ï¼šé€‰æ‰‹ç¡®è®¤ç•Œé¢ -->
        <div id="reflexConfirm" style="display:none; text-align:center; padding:40px;">
            <h3>ğŸ¯ å‚èµ›é€‰æ‰‹åå•</h3>
            <div id="selectedPlayersList" class="players-list" style="margin:30px 0; max-height:300px; overflow-y:auto;"></div>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="btn btn-outline" onclick="reflexGame.backToSetup()">â† è¿”å›</button>
                <button class="btn btn-primary" onclick="reflexGame.startWithConfirmedPlayers()">ğŸš€ è¿›å…¥æ¯”èµ›</button>
            </div>
        </div>

        <div id="reflexPlay" style="display:none;">
            <div style="text-align:center; margin-bottom:20px;">
                <h3 id="reflexPlayerName" style="color:var(--primary-blue); font-size:2rem;">å‡†å¤‡...</h3>
                <p id="reflexStatus">Round 1/3</p>
            </div>
            <div id="reflexBox" 
                 style="height:250px; background:#e0e0e0; border-radius:20px; display:flex; align-items:center; justify-content:center; font-size:3rem; color:#fff; cursor:pointer; transition:background 0.1s;"
                 onmousedown="reflexGame.handleClick()" ontouchstart="reflexGame.handleClick()">
                ç‚¹æˆ‘å¼€å§‹
            </div>
        </div>

        <div id="reflexResult" style="margin-top:30px; display:none;">
            <table style="width:100%; text-align:center; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f1f1f1;"><th>æ’å</th><th>å§“å</th><th>å¹³å‡è€—æ—¶</th><th>åŠ åˆ†</th></tr>
                </thead>
                <tbody id="reflexRankBody"></tbody>
            </table>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-danger" onclick="reflexGame.settleScores()">ğŸ† ä¸€é”®é¢å¥–</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆ: æ•°å­—ç‚¸å¼¹ -->
    <div id="game-numberBomb" class="game-screen">
        <div class="screen-header"><h2>ğŸ’£ æ•°å­—ç‚¸å¼¹</h2> <button class="btn btn-outline" onclick="bombGame.init()">é‡ç½®</button></div>
        <div id="bombContent"></div>
    </div>

    <!-- æ¸¸æˆ: æ­£è¯åè¯´ -->
    <div id="game-reverseGame" class="game-screen">
        <div class="screen-header"><h2>ğŸ¤ª æ­£è¯åè¯´</h2></div>
        <div style="text-align:center; padding:40px;">
            <div id="reverseWord" style="font-size:5rem; font-weight:bold; color:var(--primary-purple); margin:40px 0;">å‡†å¤‡</div>
            <button class="btn btn-primary btn-lg" onclick="reverseGame.next()">ğŸ² ä¸‹ä¸€ä¸ªæŒ‡ä»¤</button>
            <div style="margin-top:40px;">
                <button class="btn btn-success" onclick="scoreSys.open()">â• è¡¨ç°å¥½åŠ åˆ†</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆ: æ•°å­¦é€Ÿç®—ç«é€Ÿ -->
    <div id="game-math" class="game-screen">
        <div class="screen-header">
            <h2>ğŸ§® é€Ÿç®—ç«é€Ÿ</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="mathLevel" style="width:auto;" onchange="mathRace.init()">
                    <option value="easy">ç®€å• (1-2å¹´çº§)</option>
                    <option value="medium">ä¸­ç­‰ (3-4å¹´çº§)</option>
                    <option value="hard">å›°éš¾ (5-6å¹´çº§)</option>
                </select>
                <input type="number" id="mathRounds" value="5" min="1" max="20" style="width:60px; text-align:center;" placeholder="è½®æ¬¡">
                <button class="btn btn-primary" onclick="mathRace.start()">å¼€å§‹æ¯”èµ›</button>
            </div>
        </div>
        
        <div id="mathSetup" style="text-align:center; padding:40px;">
            <h3>ğŸ é€Ÿç®—ç«é€Ÿè®¾ç½®</h3>
            <div style="max-width:400px; margin:30px auto; background:#f8f9fa; padding:25px; border-radius:15px;">
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:bold;">é€‰æ‹©é€‰æ‰‹ (2å)</label>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <select id="mathPlayer1" style="flex:1;"></select>
                        <select id="mathPlayer2" style="flex:1;"></select>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="AutoSelector.enhancedSelect(2, [], 'math')" style="margin-top:10px;">âš¡ æ™ºèƒ½æŠ½å–</button>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:bold;">æ¯”èµ›è½®æ¬¡</label>
                    <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                        <button class="btn btn-sm btn-outline" onclick="document.getElementById('mathRounds').value = Math.max(1, parseInt(document.getElementById('mathRounds').value)-1)">-</button>
                        <input type="number" id="mathRounds" value="5" min="1" max="20" style="width:80px; text-align:center;">
                        <button class="btn btn-sm btn-outline" onclick="document.getElementById('mathRounds').value = Math.min(20, parseInt(document.getElementById('mathRounds').value)+1)">+</button>
                    </div>
                </div>
                <button class="btn btn-primary btn-lg" onclick="mathRace.start()">ğŸš€ å¼€å§‹æ¯”èµ›</button>
            </div>
        </div>
        
        <div id="mathRace" style="display:none; text-align:center; padding:30px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; background:#f0f4f8; padding:15px; border-radius:15px;">
                <div>
                    <div style="font-size:0.9rem; color:#666;">å½“å‰è½®æ¬¡</div>
                    <div style="font-size:2rem; font-weight:bold;"><span id="currentRound">0</span>/<span id="totalRounds">5</span></div>
                </div>
                <div id="mathTimer" style="font-size:2rem; font-weight:bold; color:var(--primary-blue);">ä¸é™æ—¶</div>
                <div>
                    <div style="font-size:0.9rem; color:#666;">ä¸‹ä¸€é¢˜å€’è®¡æ—¶</div>
                    <div id="nextQuestionTimer" style="font-size:1.2rem; color:#888;">è‡ªåŠ¨è·³è½¬</div>
                </div>
            </div>
            
            <div style="display:flex; justify-content:center; gap:30px; margin-bottom:30px;">
                <div class="player-card" id="player1Card">
                    <div class="player-name" id="player1Name">é€‰æ‰‹1</div>
                    <div class="player-score" id="player1Score">0.0</div>
                    <div class="player-status" id="player1Status">ç­‰å¾…</div>
                </div>
                <div class="player-card" id="player2Card">
                    <div class="player-name" id="player2Name">é€‰æ‰‹2</div>
                    <div class="player-score" id="player2Score">0.0</div>
                    <div class="player-status" id="player2Status">ç­‰å¾…</div>
                </div>
            </div>
            
            <div id="mathQuestion" style="font-size:4rem; font-family:monospace; margin:20px 0; padding:20px; background:#f8f9fa; border-radius:15px;">
                å‡†å¤‡ä¸­...
            </div>
            
            <!-- åŒäººç‹¬ç«‹è¾“å…¥åŒº -->
            <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                <div style="flex: 1; max-width: 300px;">
                    <div class="keyboard-title">é€‰æ‰‹1é”®ç›˜</div>
                    <input type="text" id="mathInput1" placeholder="é€‰æ‰‹1è¾“å…¥ç­”æ¡ˆ..." readonly style="width:100%; padding:12px; font-size:1.5rem; text-align:center; border-radius:10px; border:2px solid #eee;">
                    <!-- é”®ç›˜å°†é€šè¿‡JavaScriptåŠ¨æ€é™„åŠ åˆ°è¿™é‡Œ -->
                </div>
                <div style="flex: 1; max-width: 300px;">
                    <div class="keyboard-title">é€‰æ‰‹2é”®ç›˜</div>
                    <input type="text" id="mathInput2" placeholder="é€‰æ‰‹2è¾“å…¥ç­”æ¡ˆ..." readonly style="width:100%; padding:12px; font-size:1.5rem; text-align:center; border-radius:10px; border:2px solid #eee;">
                    <!-- é”®ç›˜å°†é€šè¿‡JavaScriptåŠ¨æ€é™„åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <div style="margin-top:30px;">
                <button class="btn btn-success btn-lg" onclick="mathRace.submitAnswer(1)">âœ… é€‰æ‰‹1æäº¤ç­”æ¡ˆ</button>
                <button class="btn btn-danger btn-lg" onclick="Message.show('è·³è¿‡æœ¬é¢˜ï¼', 'error')" style="margin:0 20px;">â­ï¸ è·³è¿‡æœ¬é¢˜</button>
                <button class="btn btn-success btn-lg" onclick="mathRace.submitAnswer(2)">âœ… é€‰æ‰‹2æäº¤ç­”æ¡ˆ</button>
            </div>
            
            <div id="mathAnswer" style="margin-top:20px; font-size:1.5rem; color:#666; min-height:2rem;"></div>
        </div>
        
        <div id="mathResult" style="display:none; text-align:center; padding:40px;">
            <h3>ğŸ† æ¯”èµ›ç»“æœ</h3>
            <div id="mathResultContent" style="max-width:500px; margin:30px auto;"></div>
            <button class="btn btn-primary" onclick="mathRace.restart()">ğŸ”„ é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <!-- æ¸¸æˆ: å•è¯æ‹¼å†™ç«èµ› (V14ä¼˜åŒ–ç‰ˆ) -->
    <div id="game-spelling" class="game-screen">
        <div class="screen-header">
            <h2>ğŸ“ å•è¯æ‹¼å†™ç«èµ›</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="spellingLevel" style="width:auto;" onchange="spellingRace.init()">
                    <option value="easy">ç®€å• (å°å­¦ä½å¹´çº§)</option>
                    <option value="medium">ä¸­ç­‰ (å°å­¦ä¸­å¹´çº§)</option>
                    <option value="hard">å›°éš¾ (å°å­¦é«˜å¹´çº§)</option>
                </select>
                <input type="number" id="spellingRounds" value="5" min="1" max="20" style="width:60px; text-align:center;" placeholder="è½®æ¬¡">
                <button class="btn btn-primary" onclick="spellingRace.start()">å¼€å§‹æ¯”èµ›</button>
            </div>
        </div>
        
        <div id="spellingSetup" style="text-align:center; padding:40px;">
            <h3>ğŸ å•è¯æ‹¼å†™ç«èµ›</h3>
            <div style="max-width:400px; margin:30px auto; background:#f8f9fa; padding:25px; border-radius:15px;">
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:bold;">é€‰æ‹©é€‰æ‰‹ (2å)</label>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <select id="spellingPlayer1" style="flex:1;"></select>
                        <select id="spellingPlayer2" style="flex:1;"></select>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="AutoSelector.enhancedSelect(2, [], 'spelling')" style="margin-top:10px;">âš¡ æ™ºèƒ½æŠ½å–</button>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:bold;">æ¯”èµ›è½®æ¬¡</label>
                    <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                        <button class="btn btn-sm btn-outline" onclick="document.getElementById('spellingRounds').value = Math.max(1, parseInt(document.getElementById('spellingRounds').value)-1)">-</button>
                        <input type="number" id="spellingRounds" value="5" min="1" max="20" style="width:80px; text-align:center;">
                        <button class="btn btn-sm btn-outline" onclick="document.getElementById('spellingRounds').value = Math.min(20, parseInt(document.getElementById('spellingRounds').value)+1)">+</button>
                    </div>
                </div>
                <button class="btn btn-primary btn-lg" onclick="spellingRace.start()">ğŸš€ å¼€å§‹æ¯”èµ›</button>
            </div>
        </div>
        
        <div id="spellingRace" style="display:none; text-align:center; padding:30px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; background:#f0f4f8; padding:15px; border-radius:15px;">
                <div>
                    <div style="font-size:0.9rem; color:#666;">å½“å‰è½®æ¬¡</div>
                    <div style="font-size:2rem; font-weight:bold;"><span id="spellingCurrentRound">0</span>/<span id="spellingTotalRounds">5</span></div>
                </div>
                <div id="spellingTimer" style="font-size:2rem; font-weight:bold; color:var(--primary-blue);">ä¸é™æ—¶</div>
                <div>
                    <div style="font-size:0.9rem; color:#666;">ä¸‹ä¸€é¢˜å€’è®¡æ—¶</div>
                    <div id="spellingNextTimer" style="font-size:1.2rem; color:#888;">è‡ªåŠ¨è·³è½¬</div>
                </div>
            </div>
            
            <div style="display:flex; justify-content:center; gap:30px; margin-bottom:30px;">
                <div class="player-card" id="spellingPlayer1Card">
                    <div class="player-name" id="spellingPlayer1Name">é€‰æ‰‹1</div>
                    <div class="player-score" id="spellingPlayer1Score">0.0</div>
                    <div class="player-status" id="spellingPlayer1Status">ç­‰å¾…</div>
                </div>
                <div class="player-card" id="spellingPlayer2Card">
                    <div class="player-name" id="spellingPlayer2Name">é€‰æ‰‹2</div>
                    <div class="player-score" id="spellingPlayer2Score">0.0</div>
                    <div class="player-status" id="spellingPlayer2Status">ç­‰å¾…</div>
                </div>
            </div>
            
            <!-- æŒ–ç©ºå•è¯æ˜¾ç¤ºåŒº -->
            <div id="spellingQuestion" style="margin:30px 0; padding:20px;">
                <div style="font-size:1.2rem; color:#666; margin-bottom:10px;">è¯·å¡«è¡¥ç©ºç¼ºçš„å­—æ¯ï¼š</div>
                <div style="font-size:2.5rem; font-weight:bold; margin:20px 0; color:var(--primary-purple); letter-spacing:5px;" id="spellingWord">
                    åŠ è½½ä¸­...
                </div>
                <div style="font-size:1.2rem; color:#888; font-style:italic;" id="spellingHint">æç¤ºï¼š...</div>
            </div>
            
            <!-- åŒäººç‹¬ç«‹è¾“å…¥åŒº - V14ä¼˜åŒ–ï¼šæ”¯æŒå¤šç‚¹è§¦æ§ -->
            <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                <div style="flex: 1; max-width: 300px;">
                    <div class="keyboard-title">é€‰æ‰‹1é”®ç›˜</div>
                    <input type="text" id="spellingInput1" placeholder="é€‰æ‰‹1è¾“å…¥å­—æ¯..." readonly style="width:100%; padding:12px; font-size:1.5rem; text-align:center; border-radius:10px; border:2px solid #eee;">
                    <!-- é”®ç›˜å°†é€šè¿‡JavaScriptåŠ¨æ€é™„åŠ åˆ°è¿™é‡Œ -->
                </div>
                <div style="flex: 1; max-width: 300px;">
                    <div class="keyboard-title">é€‰æ‰‹2é”®ç›˜</div>
                    <input type="text" id="spellingInput2" placeholder="é€‰æ‰‹2è¾“å…¥å­—æ¯..." readonly style="width:100%; padding:12px; font-size:1.5rem; text-align:center; border-radius:10px; border:2px solid #eee;">
                    <!-- é”®ç›˜å°†é€šè¿‡JavaScriptåŠ¨æ€é™„åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <div style="margin-top:30px;">
                <button class="btn btn-success btn-lg" onclick="spellingRace.submitAnswer(1)">âœ… é€‰æ‰‹1æäº¤ç­”æ¡ˆ</button>
                <button class="btn btn-danger btn-lg" onclick="spellingRace.giveUp()" style="margin:0 20px;">â­ï¸ è·³è¿‡</button>
                <button class="btn btn-success btn-lg" onclick="spellingRace.submitAnswer(2)">âœ… é€‰æ‰‹2æäº¤ç­”æ¡ˆ</button>
            </div>
            
            <div id="spellingAnswer" style="margin-top:20px; font-size:1.5rem; color:#666; min-height:2rem;"></div>
        </div>
        
        <div id="spellingResult" style="display:none; text-align:center; padding:40px;">
            <h3>ğŸ† æ¯”èµ›ç»“æœ</h3>
            <div id="spellingResultContent" style="max-width:500px; margin:30px auto;"></div>
            <button class="btn btn-primary" onclick="spellingRace.restart()">ğŸ”„ é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <!-- å·¥å…·: éšæœºç‚¹å -->
    <div id="game-namePicker" class="game-screen">
        <div class="screen-header"><h2>ğŸ™‹â€â™‚ï¸ éšæœºç‚¹å</h2></div>
        <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
            <div id="pickerDisplay" style="width:200px; height:200px; border-radius:50%; border:5px solid var(--primary-blue); display:flex; align-items:center; justify-content:center; font-size:2.5rem; font-weight:bold; color:var(--primary-blue);">
                ???
            </div>
            <button id="pickerBtn" class="btn btn-primary btn-lg" onclick="namePicker.toggle()">ğŸ² å¼€å§‹ç‚¹å</button>
        </div>
        <div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
            <h3>ğŸ“‹ ç­çº§åå•è®¾ç½® (è‡ªåŠ¨ä¿å­˜)</h3>
            <textarea id="nameInput" rows="6" placeholder="è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼Œæ¯è¡Œä¸€ä¸ª" onchange="DataManager.saveNames()"></textarea>
            <p style="color:#888; font-size:0.9rem;">æç¤ºï¼šä¿®æ”¹åå•åä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰æ¸¸æˆçš„é€‰äººåˆ—è¡¨ä¸­ã€‚</p>
        </div>
    </div>

    <!-- å·¥å…·: æŠ½å¥– -->
    <div id="game-lottery" class="game-screen">
        <div class="screen-header"><h2>ğŸ å¹¸è¿æŠ½å¥–</h2></div>
        <div style="text-align:center;">
            <div id="lotteryDisplay" style="font-size:4rem; font-weight:bold; color:var(--primary-orange); margin:40px 0; min-height:80px;">å‡†å¤‡æŠ½å¥–</div>
            <button id="lotteryBtn" class="btn btn-danger btn-lg" onclick="lotteryGame.toggle()">ğŸ•¹ï¸ æ»šåŠ¨</button>
        </div>
        <div style="margin-top:40px;">
            <h3>ğŸ å¥–å“/å€™é€‰åå•</h3>
            <textarea id="prizeInput" rows="4" onchange="DataManager.savePrizes()">é“…ç¬”\næ©¡çš®\nä½œä¸šæœ¬å…å†™åˆ¸\nç³–æœ</textarea>
        </div>
    </div>
</div>

<script>
/* ==========================================================================
   æ ¸å¿ƒå·¥å…·ç±» & é…ç½® (Utils & Config) - V14.0
   ========================================================================== */

// å…¨å±€é…ç½®å¸¸é‡
const GameConfigs = {
    TIMERS: {
        DRAW_GUESS: 60,
        BRAIN_TEASER: 30,
        MATH_RACE: 10,
        SPELLING: 15,
        NEXT_QUESTION: 3
    },
    SCORES: {
        WIN: 2,
        LOSS: -1,
        BONUS: 3,
        MATH_CORRECT: 0.2,  // æ•°å­¦é€Ÿç®—æ¯ç­”å¯¹ä¸€é¢˜å¾—0.2åˆ†
        SPELLING_CORRECT: 0.2, // å•è¯æ‹¼å†™æ¯å¡«å¯¹ä¸€ä¸ªå­—æ¯å¾—0.2åˆ†
        SPELLING_WRONG: -0.1   // å•è¯æ‹¼å†™å¡«é”™æ‰£0.1åˆ†
    },
    AUTO_SELECT: {
        ENABLED: true
    }
};

// å·¥å…·å‡½æ•°ï¼šé˜²æŠ–
const debounce = (fn, delay) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
    };
};

// å·¥å…·å‡½æ•°ï¼šXSS è¿‡æ»¤
const sanitizeInput = (input) => {
    if (typeof input !== 'string') return '';
    return input.replace(/[<>]/g, '').trim().slice(0, 200);
};

// å®šæ—¶å™¨ç®¡ç†å™¨ï¼šé˜²æ­¢å†…å­˜æ³„æ¼
const TimerManager = {
    timers: new Set(),
    setInterval: function(fn, delay) {
        const id = setInterval(fn, delay);
        this.timers.add(id);
        return id;
    },
    clearInterval: function(id) {
        clearInterval(id);
        this.timers.delete(id);
    },
    clearAll: function() {
        this.timers.forEach(id => clearInterval(id));
        this.timers.clear();
    }
};

// å…¨å±€é”™è¯¯æ•è·
window.onerror = function(msg, url, line, col, error) {
    console.error('App Error:', msg, error);
    Message.show(`ç³»ç»Ÿé”™è¯¯: ${msg}`, 'error');
    return false;
};

/* ==========================================================================
   ç»Ÿä¸€æ¶ˆæ¯ç³»ç»Ÿ (V14 å¢å¼º)
   ========================================================================== */

const Message = {
    container: null,
    init: function() {
        if (this.container) return;
        
        this.container = document.createElement('div');
        this.container.id = 'message-container';
        this.container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            pointer-events: none;
        `;
        document.body.appendChild(this.container);
    },
    
    show: function(text, type = 'info', duration = 3000) {
        this.init();
        
        const message = document.createElement('div');
        message.className = `message message-${type}`;
        message.style.cssText = `
            background: ${this.getBgColor(type)};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease-out;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        
        const icon = this.getIcon(type);
        message.innerHTML = `
            <span style="font-size:1.2rem;">${icon}</span>
            <span style="flex:1;">${text}</span>
            <button onclick="this.parentElement.remove()" style="background:none; border:none; color:white; cursor:pointer; font-size:1.2rem;">Ã—</button>
        `;
        
        this.container.appendChild(message);
        
        // è‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (message.parentElement) {
                message.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => message.remove(), 300);
            }
        }, duration);
        
        // æ’­æ”¾éŸ³æ•ˆ
        this.playSound(type);
    },
    
    getBgColor: function(type) {
        const colors = {
            'success': '#2ecc71',
            'error': '#ff7675',
            'warning': '#fdcb6e',
            'info': '#74b9ff',
            'question': '#a29bfe'
        };
        return colors[type] || colors.info;
    },
    
    getIcon: function(type) {
        const icons = {
            'success': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'info': 'â„¹ï¸',
            'question': 'â“'
        };
        return icons[type] || icons.info;
    },
    
    playSound: function(type) {
        const sounds = {
            'success': () => SoundManager.win(),
            'error': () => SoundManager.error(),
            'warning': () => SoundManager.playTone(600, 'sine', 0.2),
            'info': () => SoundManager.click(),
            'question': () => SoundManager.playTone(700, 'sine', 0.2)
        };
        if (sounds[type]) sounds[type]();
    },
    
    confirm: function(text, title = 'ç¡®è®¤') {
        return new Promise((resolve) => {
            this.init();
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.2s;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 20px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                animation: slideUp 0.3s;
            `;
            
            dialog.innerHTML = `
                <h3 style="margin-top:0;">${title}</h3>
                <p>${text}</p>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-primary" id="confirmYes">ç¡®å®š</button>
                    <button class="btn btn-outline" id="confirmNo">å–æ¶ˆ</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            document.getElementById('confirmYes').onclick = () => {
                overlay.remove();
                resolve(true);
            };
            
            document.getElementById('confirmNo').onclick = () => {
                overlay.remove();
                resolve(false);
            };
            
            // ESCé”®å…³é—­
            overlay.onkeydown = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    resolve(false);
                }
            };
            overlay.focus();
        });
    }
};

/* ==========================================================================
   æ–°åŠŸèƒ½æ¨¡å— (V14 å¢å¼ºç‰ˆ)
   ========================================================================== */

const RulesManager = {
    showRules: function() {
        const modal = document.getElementById('rulesModal');
        const content = document.getElementById('rulesContent');
        
        const rules = {
            'ä½ ç”»æˆ‘çŒœ': [
                { point: 'çŒœå¯¹çš„åŒå­¦', score: '+1åˆ†', desc: 'ç¬¬ä¸€ä¸ªçŒœå¯¹ç”»ä½œå†…å®¹çš„å­¦ç”Ÿ' },
                { point: 'ç”»å®¶', score: '+1åˆ†', desc: 'æˆåŠŸç”»å‡ºé¢˜ç›®è®©åŒå­¦çŒœå¯¹' }
            ],
            'æ•°å­¦é€Ÿç®—': [
                { point: 'ç­”å¯¹ä¸€é¢˜', score: '+0.2åˆ†', desc: 'æ¯æ­£ç¡®è®¡ç®—ä¸€é“æ•°å­¦é¢˜' },
                { point: 'æ¯”èµ›å† å†›', score: '+1åˆ†', desc: 'æ¯”èµ›ç»“æŸåå¾—åˆ†æœ€é«˜çš„å­¦ç”Ÿ' }
            ],
            'å•è¯æ‹¼å†™': [
                { point: 'å¡«å¯¹ä¸€ä¸ªå­—æ¯', score: '+0.2åˆ†', desc: 'æ¯æ­£ç¡®å¡«è¡¥ä¸€ä¸ªç©ºç¼ºå­—æ¯' },
                { point: 'å¡«é”™ä¸€ä¸ªå­—æ¯', score: '-0.1åˆ†', desc: 'æ¯é”™è¯¯å¡«è¡¥ä¸€ä¸ªç©ºç¼ºå­—æ¯' },
                { point: 'æ¯”èµ›å† å†›', score: '+1åˆ†', desc: 'æ¯”èµ›ç»“æŸåå¾—åˆ†æœ€é«˜çš„å­¦ç”Ÿ' }
            ],
            'è„‘ç­‹æ€¥è½¬å¼¯': [
                { point: 'ç­”å¯¹ä¸€é¢˜', score: '+2åˆ†', desc: 'ç¬¬ä¸€ä¸ªæ­£ç¡®å›ç­”å‡ºè„‘ç­‹æ€¥è½¬å¼¯ç­”æ¡ˆ' }
            ],
            'æµ·é¾Ÿæ±¤': [
                { point: 'æ¨ç†æˆåŠŸ', score: '+3åˆ†', desc: 'ç¬¬ä¸€ä¸ªå®Œæ•´æ¨ç†å‡ºæ•…äº‹çœŸç›¸' },
                { point: 'å…³é”®æé—®', score: '+1åˆ†', desc: 'æå‡ºå¯¹æ¨ç†æœ‰å¸®åŠ©çš„å…³é”®é—®é¢˜' }
            ],
            'çœ¼ç–¾æ‰‹å¿«': [
                { point: 'ç¬¬ä¸€å', score: '+3åˆ†', desc: 'ååº”é€Ÿåº¦æœ€å¿«çš„å‚èµ›è€…' },
                { point: 'ç¬¬äºŒå', score: '+2åˆ†', desc: 'ååº”é€Ÿåº¦ç¬¬äºŒå¿«çš„å‚èµ›è€…' },
                { point: 'ç¬¬ä¸‰å', score: '+1åˆ†', desc: 'ååº”é€Ÿåº¦ç¬¬ä¸‰å¿«çš„å‚èµ›è€…' }
            ],
            'æ•°å­—ç‚¸å¼¹': [
                { point: 'ä¸­å¼¹è€…', score: '-2åˆ†', desc: 'ä¸å¹¸çŒœä¸­ç‚¸å¼¹æ•°å­—çš„å­¦ç”Ÿ' },
                { point: 'å¹¸å­˜è€…', score: '+1åˆ†', desc: 'æˆåŠŸé¿å¼€ç‚¸å¼¹çš„å…¶ä»–å‚èµ›è€…' }
            ],
            'è¯¾å ‚è¯„ä»·': [
                { point: 'ç§¯æè¡¨ç°', score: '+1 ~ +3åˆ†', desc: 'ä½œä¸šå…¨å¯¹ã€å£°éŸ³å“äº®ã€å¸®åŠ©åŒå­¦ç­‰' },
                { point: 'å¾…æ”¹è¿›', score: '-1åˆ†', desc: 'è¿Ÿåˆ°ã€å¿˜å¸¦ä¹¦æœ¬ã€ä¸Šè¯¾è®²è¯ç­‰' },
                { point: 'ç‰¹åˆ«é¼“åŠ±', score: '+2 ~ +3åˆ†', desc: 'è¿›æ­¥ä¹‹æ˜Ÿã€çºªå¾‹æ ‡å…µã€è¯¾å ‚ä¹‹æ˜Ÿç­‰' }
            ]
        };
        
        let html = '';
        for (const [category, items] of Object.entries(rules)) {
            html += `
                <div class="rules-category">
                    <h4>${category}</h4>
            `;
            
            items.forEach(item => {
                const isNegative = item.score.startsWith('-');
                html += `
                    <div class="rules-item ${isNegative ? 'negative' : ''}">
                        <div class="rules-point">${item.point}: ${item.score}</div>
                        <div class="rules-desc">${item.desc}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        content.innerHTML = html;
        modal.style.display = 'flex';
        modal.classList.add('show');
    }
};

const AutoSelector = {
    selectPlayers: function(count=2, exclude=[]) {
        const names = DataManager.getNames();
        const available = names.filter(n => !exclude.includes(n));
        if(available.length < count) return available;
        
        const selected = [];
        const tempAvailable = [...available];
        
        while(selected.length < count && tempAvailable.length > 0) {
            const idx = Math.floor(Math.random() * tempAvailable.length);
            selected.push(tempAvailable[idx]);
            tempAvailable.splice(idx, 1);
        }
        return selected;
    },
    
    autoSelect: function(gameType) {
        if (!GameConfigs.AUTO_SELECT.ENABLED) return;
        
        const players = this.selectPlayers(2);
        if(players.length === 2) {
            const p1 = document.getElementById(`${gameType}Player1`);
            const p2 = document.getElementById(`${gameType}Player2`);
            
            if(p1 && p2) {
                p1.style.borderColor = 'var(--primary-blue)';
                p2.style.borderColor = 'var(--primary-blue)';
                p1.value = players[0];
                p2.value = players[1];
                
                setTimeout(() => {
                    p1.style.borderColor = '#eee';
                    p2.style.borderColor = '#eee';
                }, 500);
            }
        } else {
            Message.show('å­¦ç”Ÿäººæ•°ä¸è¶³ï¼Œæ— æ³•è‡ªåŠ¨æŠ½å–', 'warning');
        }
    },
    
    enhancedSelect: function(count = 2, exclude = [], gameType = null, callback = null) {
        const names = DataManager.getNames();
        const available = names.filter(n => !exclude.includes(n));
        if (available.length < count) {
            Message.show('å­¦ç”Ÿäººæ•°ä¸è¶³', 'error');
            return;
        }
        
        // åˆ›å»ºåŠ¨ç”»å®¹å™¨
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        `;
        
        const container = document.createElement('div');
        container.style.cssText = `
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        `;
        
        container.innerHTML = `
            <h3 style="margin-top:0;">ğŸ² æ­£åœ¨æŠ½å–...</h3>
            <div id="selectorAnimation" style="font-size: 2.5rem; margin: 30px 0; height: 60px; color: var(--primary-blue);"></div>
            <div id="selectedResult" style="display: none; margin-top: 20px;">
                <h4>ğŸ‰ æŠ½å–ç»“æœ</h4>
            </div>
        `;
        
        overlay.appendChild(container);
        document.body.appendChild(overlay);
        
        const animationEl = document.getElementById('selectorAnimation');
        const resultEl = document.getElementById('selectedResult');
        
        // å¼€å§‹åŠ¨ç”»
        let animationCount = 0;
        const maxAnimations = 25;
        let soundInterval;
        
        const startAnimation = () => {
            soundInterval = setInterval(() => {
                SoundManager.playTone(600 + Math.random() * 200, 'sine', 0.05);
            }, 50);
            
            const animationInterval = TimerManager.setInterval(() => {
                const randomNames = [...available]
                    .sort(() => Math.random() - 0.5)
                    .slice(0, count)
                    .join('  ğŸ¯  ');
                
                animationEl.textContent = randomNames;
                animationEl.style.transform = `scale(${1 + Math.sin(animationCount * 0.2) * 0.1})`;
                
                animationCount++;
                if (animationCount >= maxAnimations) {
                    TimerManager.clearInterval(animationInterval);
                    clearInterval(soundInterval);
                    this.finalizeSelection(available, count, animationEl, resultEl, overlay, gameType, callback);
                }
            }, 80);
        };
        
        setTimeout(startAnimation, 100);
    },
    
    finalizeSelection: function(available, count, animationEl, resultEl, overlay, gameType, callback) {
        const selected = this.selectPlayers(count, []);
        
        // æœ€ç»ˆæ˜¾ç¤º
        animationEl.style.cssText = `
            font-size: 2.5rem;
            color: var(--primary-blue);
            font-weight: bold;
            animation: pulse 1s infinite;
        `;
        animationEl.textContent = selected.join('  ğŸ†  ');
        
        resultEl.style.display = 'block';
        resultEl.innerHTML += `
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                ${selected.map((name, index) => `
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 10px;">
                        é€‰æ‰‹ ${index + 1}: <strong>${name}</strong>
                    </div>
                `).join('')}
            </div>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="this.closest('div[style*=\\'position: fixed\\']').remove()">
                ç¡®å®š
            </button>
        `;
        
        // èƒœåˆ©éŸ³æ•ˆ
        SoundManager.win();
        
        // å¦‚æœæŒ‡å®šäº†æ¸¸æˆç±»å‹ï¼Œè‡ªåŠ¨å¡«å……
        if (gameType) {
            setTimeout(() => {
                const p1 = document.getElementById(`${gameType}Player1`);
                const p2 = document.getElementById(`${gameType}Player2`);
                
                if(p1 && p2 && selected.length >= 2) {
                    p1.value = selected[0];
                    p2.value = selected[1];
                }
            }, 500);
        }
        
        // å¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼Œæ‰§è¡Œå›è°ƒ
        if (callback && typeof callback === 'function') {
            callback(selected);
        }
        
        // ç§»é™¤overlay
        overlay.remove();
    }
};

// V14é‡æ„ï¼šè™šæ‹Ÿé”®ç›˜ç³»ç»Ÿï¼Œæ”¯æŒå¤šç‚¹è§¦æ§
const VirtualKeyboard = {
    instances: new Map(),
    activeTouches: new Map(), // è®°å½•å¤šç‚¹è§¦æ§çŠ¶æ€
    
    create: function(targetInputId, playerNum = null, gameType = 'general') {
        const container = document.createElement('div');
        container.className = 'virtual-keyboard';
        container.dataset.player = playerNum;
        container.dataset.gameType = gameType;
        
        // V14ä¼˜åŒ–ï¼šæ”¯æŒå¤šç‚¹è§¦æ§
        container.style.touchAction = 'manipulation';
        
        if (gameType === 'math') {
            container.classList.add('math-keyboard');
            
            // æ•°å­¦é”®ç›˜ï¼šä¹å®«æ ¼å¸ƒå±€ï¼Œè¿ç®—ç¬¦åœ¨å³ä¾§
            const layout = [
                ['7', '8', '9', 'Ã·', 'C'],
                ['4', '5', '6', 'Ã—', 'âŒ«'],
                ['1', '2', '3', '-', ''],
                ['0', '.', '=', '+', 'âœ…']
            ];
            
            layout.forEach(row => {
                row.forEach(key => {
                    if (key === '') return;
                    
                    const btn = this.createKey(key, targetInputId, playerNum, gameType);
                    container.appendChild(btn);
                });
            });
            
        } else if (gameType === 'spelling') {
            container.classList.add('spelling-keyboard');
            
            // V14ä¼˜åŒ–ï¼šæ‹¼å†™é”®ç›˜æ”¯æŒå¤šç‚¹è§¦æ§
            const rows = [
                'QWERTYUIOP'.split(''),
                'ASDFGHJKL'.split(''),
                'ZXCVBNM'.split('')
            ];
            
            rows.forEach(row => {
                row.forEach(key => {
                    const btn = this.createKey(key, targetInputId, playerNum, gameType);
                    container.appendChild(btn);
                });
            });
            
            // åŠŸèƒ½é”®
            const backspaceBtn = this.createKey('âŒ«', targetInputId, playerNum, gameType);
            backspaceBtn.className += ' wide action';
            container.appendChild(backspaceBtn);
            
            // ä¿®å¤ï¼šä½¿ç”¨ 'Clear' ä½œä¸ºå†…éƒ¨é”®å€¼ä»¥åŒºåˆ†å­—æ¯ Cï¼Œä½†æ˜¾ç¤ºæ–‡æœ¬ä»è®¾ä¸º 'C'
            const clearBtn = this.createKey('Clear', targetInputId, playerNum, gameType);
            clearBtn.textContent = 'C'; 
            clearBtn.className += ' wide clear';
            container.appendChild(clearBtn);
            
            const submitBtn = this.createKey('âœ…', targetInputId, playerNum, gameType);
            submitBtn.className += ' wide submit';
            container.appendChild(submitBtn);
        }
        
        // å­˜å‚¨å®ä¾‹
        this.instances.set(targetInputId, container);
        
        return container;
    },
    
    createKey: function(key, targetInputId, playerNum, gameType) {
        const btn = document.createElement('button');
        btn.textContent = key;
        btn.className = 'keyboard-key';
        
        // ç‰¹æ®Šé”®æ ·å¼
        if (key === 'C') {
            // V14 Fix: æ‹¼å†™æ¸¸æˆä¸­ï¼Œå­—æ¯ C ä¸åº”æœ‰çº¢è‰²æ¸…é™¤æ ·å¼ï¼Œåªæœ‰æ•°å­¦æ¸¸æˆçš„ C æ‰æ˜¯æ¸…é™¤é”®
            if (gameType === 'math') {
                btn.className += ' clear';
            }
        } else if (key === 'Clear') {
            // ä¸“é—¨çš„æ¸…é™¤é”®ï¼ˆæ‹¼å†™æ¸¸æˆåº•éƒ¨é‚£ä¸ªï¼‰
            btn.className += ' clear';
        } else if (key === 'âŒ«') {
            btn.className += ' action';
        } else if (key === 'âœ…') {
            btn.className += ' submit';
        } else if (['Ã·', 'Ã—', '-', '+', '='].includes(key)) {
            btn.className += ' operator';
        }
        
        // V14ä¼˜åŒ–ï¼šæ”¯æŒå¤šç‚¹è§¦æ§
        btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            this.handleKeyPress(targetInputId, key, playerNum, gameType);
        });
        
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.handleKeyPress(targetInputId, key, playerNum, gameType);
        }, { passive: false });
        
        // æ·»åŠ è§¦æ‘¸åé¦ˆ
        btn.addEventListener('touchstart', (e) => {
            btn.style.backgroundColor = '#e0e0e0';
        });
        
        btn.addEventListener('touchend', (e) => {
            btn.style.backgroundColor = '';
        });
        
        return btn;
    },
    
    handleKeyPress: function(targetInputId, key, playerNum, gameType) {
        const input = document.getElementById(targetInputId);
        if (!input) return;
        
        SoundManager.click();
        
        // æ ¹æ®æŒ‰é”®ç±»å‹å¤„ç†
        switch(key) {
            case 'Clear': // æ˜ç¡®çš„æ¸…é™¤æŒ‡ä»¤
                input.value = '';
                break;
                
            case 'C':
                // å¦‚æœæ˜¯æ•°å­¦æ¸¸æˆï¼ŒC é”®æ˜¯æ¸…é™¤
                if (gameType === 'math') {
                    input.value = '';
                    break;
                }
                // å¦‚æœæ˜¯æ‹¼å†™æ¸¸æˆï¼ŒC é”®æ˜¯å­—æ¯ï¼Œå‘ä¸‹ç©¿é€åˆ° default å¤„ç†
                
            case 'âŒ«':
            case 'Backspace':
                input.value = input.value.slice(0, -1);
                break;
                
            case 'âœ…':
            case 'Submit':
                // æ ¹æ®æ¸¸æˆç±»å‹æäº¤ç­”æ¡ˆ
                if (gameType === 'math') {
                    if (typeof mathRace !== 'undefined' && mathRace.submitAnswer && playerNum) {
                        mathRace.submitAnswer(parseInt(playerNum));
                    }
                } else if (gameType === 'spelling') {
                    if (typeof spellingRace !== 'undefined' && spellingRace.submitAnswer && playerNum) {
                        spellingRace.submitAnswer(parseInt(playerNum));
                    }
                }
                break;
                
            case '=':
                // ç­‰äºå·åœ¨æ•°å­¦æ¸¸æˆä¸­ç‰¹æ®Šå¤„ç†
                if (gameType === 'math') {
                    if (typeof mathRace !== 'undefined' && mathRace.submitAnswer && playerNum) {
                        mathRace.submitAnswer(parseInt(playerNum));
                    }
                } else {
                    input.value += key;
                }
                break;
                
            default:
                // å¸¸è§„å­—ç¬¦è¾“å…¥
                input.value += key;
                
                // å¦‚æœæ˜¯æ‹¼å†™æ¸¸æˆï¼Œè‡ªåŠ¨å¤„ç†å­—æ¯è¾“å…¥
                if (gameType === 'spelling' && typeof spellingRace !== 'undefined' && spellingRace.handleBlankInput && playerNum) {
                    setTimeout(() => {
                        spellingRace.handleBlankInput(parseInt(playerNum), key);
                    }, 10);
                }
                break;
        }
        
        // è§¦å‘è¾“å…¥äº‹ä»¶
        input.dispatchEvent(new Event('input', { bubbles: true }));
    },
    
    attachToGame: function(gameId, inputIds) {
        // å…ˆç§»é™¤æ—§çš„é”®ç›˜
        this.detachAll();
        
        // inputIds å¯ä»¥æ˜¯æ•°ç»„ï¼ˆå¤šä¸ªè¾“å…¥æ¡†ï¼‰
        const inputArray = Array.isArray(inputIds) ? inputIds : [inputIds];
        
        inputArray.forEach((inputId, index) => {
            const inputArea = document.getElementById(inputId);
            if (!inputArea) return;
            
            const playerNum = index + 1;
            const keyboard = this.create(inputId, playerNum, gameId);
            
            // æ’å…¥åˆ°è¾“å…¥æ¡†åé¢
            inputArea.parentNode.insertBefore(keyboard, inputArea.nextSibling);
            
            // æ·»åŠ é”®ç›˜æ ‡é¢˜
            const title = document.createElement('div');
            title.className = 'keyboard-title';
            title.textContent = `é€‰æ‰‹${playerNum}é”®ç›˜`;
            keyboard.parentNode.insertBefore(title, keyboard);
            
            // ç¦ç”¨è¾“å…¥æ¡†çš„ç›´æ¥è¾“å…¥ï¼ˆé˜²æ­¢è½¯é”®ç›˜å¼¹å‡ºï¼‰
            inputArea.addEventListener('focus', (e) => {
                e.preventDefault();
                inputArea.blur();
            });
        });
    },
    
    detachAll: function() {
        document.querySelectorAll('.virtual-keyboard').forEach(kb => kb.remove());
        document.querySelectorAll('.keyboard-title').forEach(title => title.remove());
        this.instances.clear();
    }
};

/* ==========================================================================
   æ•°æ®ç®¡ç† (Data Layer) - V14.0
   ========================================================================== */

const DataManager = {
    VERSION: 'v14.0',
    KEY_DATA: 'hc_data_v14',
    KEY_QUESTIONS: 'hc_questions_v14',
    KEY_TAGS: 'hc_tags_v14', // V14æ–°å¢ï¼šå­˜å‚¨è‡ªå®šä¹‰æ ‡ç­¾
    
    defaults: {
        names: "å¼ ä¸‰\næå››\nç‹äº”\nèµµå…­\nå°æ˜\nå°çº¢",
        prizes: "å…ä½œä¸šä¸€æ¬¡\næ£’æ£’ç³–\nè‡ªåŠ¨é“…ç¬”",
        scores: {},
        stats: [],
        hiddenGames: []
    },
    
    // V14æ–°å¢ï¼šé»˜è®¤è¯„ä»·æ ‡ç­¾
    defaultTags: {
        positive: [
            { text: "âœ… ä½œä¸šå…¨å¯¹ +1", value: 1 },
            { text: "ğŸ¯ å£°éŸ³å“äº® +1", value: 1 },
            { text: "ğŸ¤ å¸®åŠ©åŒå­¦ +1", value: 1 },
            { text: "ğŸ“ ä¹¦å†™å·¥æ•´ +1", value: 1 },
            { text: "ğŸ§  è§£é¢˜æ–°æ–¹æ³• +2", value: 2 },
            { text: "ğŸ¨ åˆ›æ„ä½œå“ +2", value: 2 },
            { text: "ğŸ† å°ç»„åˆä½œ +3", value: 3 }
        ],
        negative: [
            { text: "â° è¿Ÿåˆ° -1", value: -1 },
            { text: "ğŸ“– å¿˜å¸¦ä¹¦æœ¬ -1", value: -1 },
            { text: "ğŸ”Š ä¸Šè¯¾è®²è¯ -1", value: -1 },
            { text: "ğŸš« è¿åè§„åˆ™ -1", value: -1 }
        ],
        special: [
            { text: "ğŸ’« è¿›æ­¥ä¹‹æ˜Ÿ +2", value: 2 },
            { text: "ğŸ–ï¸ çºªå¾‹æ ‡å…µ +2", value: 2 },
            { text: "ğŸŒŸ è¯¾å ‚ä¹‹æ˜Ÿ +3", value: 3 }
        ]
    },

    load: function() {
        const raw = localStorage.getItem(this.KEY_DATA);
        if (raw) {
            try {
                const data = JSON.parse(raw);
                return { ...this.defaults, ...data };
            } catch(e) { 
                console.error("æ•°æ®æŸåï¼Œé‡ç½®é»˜è®¤", e);
                Message.show('æ•°æ®æŸåï¼Œå·²æ¢å¤é»˜è®¤è®¾ç½®', 'error');
            }
        }
        return this.defaults;
    },

    save: function(data) {
        localStorage.setItem(this.KEY_DATA, JSON.stringify(data));
    },
    
    // V14æ–°å¢ï¼šæ ‡ç­¾ç®¡ç†
    loadTags: function() {
        const raw = localStorage.getItem(this.KEY_TAGS);
        if (raw) {
            try {
                return JSON.parse(raw);
            } catch(e) {
                console.error("æ ‡ç­¾æ•°æ®æŸåï¼Œé‡ç½®é»˜è®¤", e);
            }
        }
        return this.defaultTags;
    },
    
    saveTags: function(tags) {
        localStorage.setItem(this.KEY_TAGS, JSON.stringify(tags));
    },
    
    addTag: function(category, text, value) {
        const tags = this.loadTags();
        if (!tags[category]) tags[category] = [];
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡æœ¬çš„æ ‡ç­¾
        const exists = tags[category].some(tag => tag.text === text);
        if (!exists) {
            tags[category].push({ text, value });
            this.saveTags(tags);
            return true;
        }
        return false;
    },
    
    removeTag: function(category, index) {
        const tags = this.loadTags();
        if (tags[category] && tags[category][index]) {
            tags[category].splice(index, 1);
            this.saveTags(tags);
            return true;
        }
        return false;
    },

    getNames: function() {
        return (document.getElementById('nameInput').value || "").split('\n').filter(n => n.trim());
    },

    saveNames: function() {
        const val = sanitizeInput(document.getElementById('nameInput').value);
        const data = this.load();
        data.names = val;
        this.save(data);
        scoreSys.initData();
        Message.show('åå•å·²ä¿å­˜', 'success');
    },

    savePrizes: function() {
        const val = sanitizeInput(document.getElementById('prizeInput').value);
        const data = this.load();
        data.prizes = val;
        this.save(data);
        Message.show('å¥–å“åˆ—è¡¨å·²ä¿å­˜', 'success');
    },

    exportData: function() {
        const exportObj = {
            data: this.load(),
            questions: QuestionManager.load(),
            tags: this.loadTags(),
            version: this.VERSION,
            timestamp: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `hc_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        Message.show('æ•°æ®å¤‡ä»½å·²å¼€å§‹ä¸‹è½½', 'success');
    },

    importData: function(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.data) this.save(imported.data);
                if (imported.questions) QuestionManager.save(imported.questions);
                if (imported.tags) this.saveTags(imported.tags);
                Message.show('âœ… æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (err) {
                Message.show('âŒ æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                console.error(err);
            }
        };
        reader.readAsText(file);
    },
    
    bulkImportQuestions: function(gameType, text, format = 'json') {
        try {
            let questions = [];
            const existingData = QuestionManager.load();
            
            if (format === 'json') {
                const parsed = JSON.parse(text);
                questions = Array.isArray(parsed) ? parsed : [parsed];
            } else if (format === 'csv') {
                // CSVæ ¼å¼è§£æ
                const lines = text.split('\n').filter(line => line.trim());
                questions = lines.map(line => {
                    const parts = line.split(',').map(part => part.trim());
                    if (gameType === 'drawGuess') {
                        // æ–°æ ¼å¼ï¼šword,type
                        if (parts.length >= 2) {
                            return { word: parts[0], type: parts[1] };
                        } else {
                            return parts[0] || '';
                        }
                    } else if (gameType === 'riddleSoup') {
                        // V14æ–°å¢ï¼šæ”¯æŒå››æ®µå¼ é—®é¢˜|ç­”æ¡ˆ|çº¿ç´¢1|çº¿ç´¢2
                        if (parts.length >= 4) {
                            return { q: parts[0], a: parts[1], clue1: parts[2], clue2: parts[3] };
                        } else if (parts.length >= 2) {
                            return { q: parts[0], a: parts[1] };
                        }
                    } else if (gameType === 'brainTeaser') {
                        return { q: parts[0] || '', a: parts[1] || '' };
                    } else if (gameType === 'math' || gameType === 'spelling') {
                        return parts[0] || '';
                    }
                    return null;
                }).filter(q => q);
            } else if (format === 'txt') {
                // æ¯è¡Œä¸€ä¸ªé¢˜ç›®
                const lines = text.split('\n').filter(line => line.trim());
                questions = lines.map(line => {
                    if (gameType === 'drawGuess') {
                        // æ£€æŸ¥æ˜¯å¦æœ‰ç±»å‹åˆ†éš”ç¬¦
                        if (line.includes('|')) {
                            const parts = line.split('|');
                            return { word: parts[0].trim(), type: parts[1]?.trim() || 'å…¶ä»–' };
                        } else if (line.includes('ï¼š')) {
                            const parts = line.split('ï¼š');
                            return { word: parts[0].trim(), type: parts[1]?.trim() || 'å…¶ä»–' };
                        } else if (line.includes(':')) {
                            const parts = line.split(':');
                            return { word: parts[0].trim(), type: parts[1]?.trim() || 'å…¶ä»–' };
                        }
                        return line.trim();
                    } else if (gameType === 'math' || gameType === 'spelling') {
                        return line.trim();
                    } else if (gameType === 'riddleSoup') {
                        // V14æ–°å¢ï¼šæ”¯æŒå››æ®µå¼
                        const separator = line.includes('|') ? '|' : 
                                        line.includes('ï¼š') ? 'ï¼š' : 
                                        line.includes(':') ? ':' : '';
                        if (separator) {
                            const parts = line.split(separator);
                            if (parts.length >= 4) {
                                return { 
                                    q: parts[0].trim(), 
                                    a: parts[1]?.trim() || '',
                                    clue1: parts[2]?.trim() || '',
                                    clue2: parts[3]?.trim() || ''
                                };
                            } else if (parts.length >= 2) {
                                return { q: parts[0].trim(), a: parts[1]?.trim() || '' };
                            }
                        }
                        return { q: line.trim(), a: '' };
                    } else if (gameType === 'brainTeaser') {
                        const separator = line.includes('|') ? '|' : 
                                        line.includes('ï¼š') ? 'ï¼š' : 
                                        line.includes(':') ? ':' : '';
                        if (separator) {
                            const parts = line.split(separator);
                            return { q: parts[0].trim(), a: parts[1]?.trim() || '' };
                        }
                        return { q: line.trim(), a: '' };
                    }
                    return null;
                }).filter(q => q);
            }
            
            // åˆå¹¶åˆ°ç°æœ‰é¢˜åº“
            if (!existingData[gameType]) {
                existingData[gameType] = gameType === 'math' || gameType === 'spelling' ? 
                    { easy: [], medium: [], hard: [] } : [];
            }
            
            let addedCount = 0;
            if (Array.isArray(existingData[gameType])) {
                // ç®€å•æ•°ç»„ç±»å‹
                const existingSet = new Set(existingData[gameType].map(q => {
                    if (typeof q === 'object') {
                        if (q.word && q.type) {
                            return JSON.stringify({ word: q.word, type: q.type });
                        } else if (q.q && q.a) {
                            return JSON.stringify({ q: q.q, a: q.a });
                        }
                    }
                    return q;
                }));
                
                questions.forEach(q => {
                    let qStr;
                    if (typeof q === 'object') {
                        if (q.word && q.type) {
                            qStr = JSON.stringify({ word: q.word, type: q.type });
                        } else if (q.q && q.a) {
                            qStr = JSON.stringify({ q: q.q, a: q.a });
                        } else {
                            qStr = JSON.stringify(q);
                        }
                    } else {
                        qStr = q;
                    }
                    
                    if (!existingSet.has(qStr)) {
                        existingData[gameType].push(q);
                        addedCount++;
                    }
                });
            } else if (typeof existingData[gameType] === 'object') {
                // åˆ†çº§ç±»å‹ - é»˜è®¤å¯¼å…¥åˆ°ä¸­ç­‰éš¾åº¦
                const level = 'medium';
                const existingSet = new Set(existingData[gameType][level] || []);
                
                questions.forEach(q => {
                    if (!existingSet.has(q)) {
                        if (!existingData[gameType][level]) {
                            existingData[gameType][level] = [];
                        }
                        existingData[gameType][level].push(q);
                        addedCount++;
                    }
                });
            }
            
            QuestionManager.save(existingData);
            return { success: true, count: addedCount };
        } catch (error) {
            console.error('æ‰¹é‡å¯¼å…¥å¤±è´¥:', error);
            return { success: false, error: error.message };
        }
    }
};

/* ==========================================================================
   é¢˜åº“ç®¡ç† (Question Manager) - V14.0
   ========================================================================== */

const QuestionManager = {
    defaults: {
        drawGuess: [
            { "word": "è‹¹æœ", "type": "æ°´æœ" },
            { "word": "é¦™è•‰", "type": "æ°´æœ" },
            { "word": "è¥¿ç“œ", "type": "æ°´æœ" },
            { "word": "è‘¡è„", "type": "æ°´æœ" },
            { "word": "è‰è“", "type": "æ°´æœ" },
            { "word": "æ¦´è²", "type": "æ°´æœ" },
            { "word": "å¤§è±¡", "type": "åŠ¨ç‰©" },
            { "word": "é•¿é¢ˆé¹¿", "type": "åŠ¨ç‰©" },
            { "word": "ç†ŠçŒ«", "type": "åŠ¨ç‰©" },
            { "word": "ç‹®å­", "type": "åŠ¨ç‰©" },
            { "word": "ä¼é¹…", "type": "åŠ¨ç‰©" },
            { "word": "å­”é›€", "type": "åŠ¨ç‰©" },
            { "word": "å†°ç®±", "type": "å®¶ç”µ" },
            { "word": "æ´—è¡£æœº", "type": "å®¶ç”µ" },
            { "word": "ç©ºè°ƒ", "type": "å®¶ç”µ" },
            { "word": "ç”µè§†æœº", "type": "å®¶ç”µ" },
            { "word": "å¾®æ³¢ç‚‰", "type": "å®¶ç”µ" },
            { "word": "é›¨ä¼", "type": "æ—¥ç”¨å“" },
            { "word": "ç‰™åˆ·", "type": "æ—¥ç”¨å“" },
            { "word": "æ¯›å·¾", "type": "æ—¥ç”¨å“" },
            { "word": "ç­·å­", "type": "æ—¥ç”¨å“" },
            { "word": "åƒåœ¾æ¡¶", "type": "æ—¥ç”¨å“" },
            { "word": "ç”µè„‘", "type": "ç”µå­äº§å“" },
            { "word": "æ‰‹æœº", "type": "ç”µå­äº§å“" },
            { "word": "é¼ æ ‡", "type": "ç”µå­äº§å“" },
            { "word": "é”®ç›˜", "type": "ç”µå­äº§å“" },
            { "word": "è€³æœº", "type": "ç”µå­äº§å“" },
            { "word": "å……ç”µå®", "type": "ç”µå­äº§å“" },
            { "word": "è‡ªè¡Œè½¦", "type": "äº¤é€šå·¥å…·" },
            { "word": "æ‘©æ‰˜è½¦", "type": "äº¤é€šå·¥å…·" },
            { "word": "å…¬äº¤è½¦", "type": "äº¤é€šå·¥å…·" },
            { "word": "ç›´å‡æœº", "type": "äº¤é€šå·¥å…·" },
            { "word": "çƒ­æ°”çƒ", "type": "äº¤é€šå·¥å…·" },
            { "word": "æ½œæ°´è‰‡", "type": "äº¤é€šå·¥å…·" },
            { "word": "å¥¥ç‰¹æ›¼", "type": "è™šæ„äººç‰©" },
            { "word": "çš®å¡ä¸˜", "type": "è™šæ„äººç‰©" },
            { "word": "å“†å•¦Aæ¢¦", "type": "è™šæ„äººç‰©" },
            { "word": "å­™æ‚Ÿç©º", "type": "è™šæ„äººç‰©" },
            { "word": "èœ˜è››ä¾ ", "type": "è™šæ„äººç‰©" },
            { "word": "çŒªå…«æˆ’", "type": "è™šæ„äººç‰©" },
            { "word": "å“ˆåˆ©æ³¢ç‰¹", "type": "è™šæ„äººç‰©" },
            { "word": "è–¯æ¡", "type": "é£Ÿç‰©" },
            { "word": "æ±‰å ¡", "type": "é£Ÿç‰©" },
            { "word": "ç«é”…", "type": "é£Ÿç‰©" },
            { "word": "å¯¿å¸", "type": "é£Ÿç‰©" },
            { "word": "è‡­è±†è…", "type": "é£Ÿç‰©" },
            { "word": "çç å¥¶èŒ¶", "type": "é£Ÿç‰©" },
            { "word": "æœˆé¥¼", "type": "é£Ÿç‰©" },
            { "word": "å¤ªé˜³", "type": "å¤©ä½“" },
            { "word": "æœˆäº®", "type": "å¤©ä½“" },
            { "word": "åœ°çƒ", "type": "å¤©ä½“" },
            { "word": "é»‘æ´", "type": "å¤©ä½“" },
            { "word": "äº‘æœµ", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "é—ªç”µ", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "å½©è™¹", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "é¾™å·é£", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "é›ªäºº", "type": "å¨±ä¹/è‡ªç„¶" },
            { "word": "ç«å±±", "type": "è‡ªç„¶æ™¯è§‚" },
            { "word": "ç€‘å¸ƒ", "type": "è‡ªç„¶æ™¯è§‚" },
            { "word": "æ²™æ¼ ", "type": "è‡ªç„¶æ™¯è§‚" },
            { "word": "é•¿åŸ", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "é‡‘å­—å¡”", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "åŸƒè²å°”é“å¡”", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "è‡ªç”±å¥³ç¥åƒ", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "å®‡èˆªå‘˜", "type": "èŒä¸š" },
            { "word": "é­”æœ¯å¸ˆ", "type": "èŒä¸š" },
            { "word": "ä¾¦æ¢", "type": "èŒä¸š" },
            { "word": "å°ä¸‘", "type": "èŒä¸š" },
            { "word": "ç¨‹åºå‘˜", "type": "èŒä¸š" },
            { "word": "æœ›è¿œé•œ", "type": "å…‰å­¦ä»ªå™¨" },
            { "word": "æ˜¾å¾®é•œ", "type": "ç§‘å­¦ä»ªå™¨" },
            { "word": "çœ¼é•œ", "type": "é…é¥°" },
            { "word": "å¢¨é•œ", "type": "é…é¥°" },
            { "word": "å£ç½©", "type": "é˜²æŠ¤ç”¨å“" },
            { "word": "å¸½å­", "type": "æœé¥°" },
            { "word": "é«˜è·Ÿé‹", "type": "æœé¥°" },
            { "word": "å‰ä»–", "type": "ä¹å™¨" },
            { "word": "é’¢ç´", "type": "ä¹å™¨" },
            { "word": "æ¶å­é¼“", "type": "ä¹å™¨" },
            { "word": "äºŒèƒ¡", "type": "ä¹å™¨" },
            { "word": "è¶³çƒ", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "ç¯®çƒ", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "ä¹’ä¹“çƒ", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "è·³ç»³", "type": "å¥èº«è¿åŠ¨" },
            { "word": "æ»‘é›ª", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "é’“é±¼", "type": "ä¼‘é—²æ´»åŠ¨" },
            { "word": "çˆ¬å±±", "type": "æˆ·å¤–æ´»åŠ¨" },
            { "word": "éœ²è¥", "type": "æˆ·å¤–æ´»åŠ¨" },
            { "word": "åˆ·ç‰™", "type": "åŠ¨ä½œ" },
            { "word": "ç¡è§‰", "type": "åŠ¨ä½œ" },
            { "word": "æ‰“æ¶", "type": "åŠ¨ä½œ" },
            { "word": "æ±‚å©š", "type": "åŠ¨ä½œ" },
            { "word": "åŒ»ç”Ÿ", "type": "èŒä¸š" },
            { "word": "è­¦å¯Ÿ", "type": "èŒä¸š" },
            { "word": "æ¶ˆé˜²å‘˜", "type": "èŒä¸š" },
            { "word": "æ˜¥èŠ‚", "type": "èŠ‚æ—¥" },
            { "word": "åœ£è¯èŠ‚", "type": "èŠ‚æ—¥" },
            { "word": "ä¸‡åœ£èŠ‚", "type": "èŠ‚æ—¥" },
            { "word": "çº¢åŒ…", "type": "ç‰©å“" },
            { "word": "ç¯ç¬¼", "type": "ç‰©å“" },
            { "word": "é­ç‚®", "type": "ç‰©å“" },
            { "word": "é¾™", "type": "ç¥è¯ç”Ÿç‰©" },
            { "word": "ç‹¬è§’å…½", "type": "ç¥è¯ç”Ÿç‰©" },
            { "word": "ç¾äººé±¼", "type": "ç¥è¯ç”Ÿç‰©" },
            { "word": "åƒµå°¸", "type": "è™šæ„ç”Ÿç‰©" },
            { "word": "å¸è¡€é¬¼", "type": "è™šæ„ç”Ÿç‰©" },
            { "word": "è è", "type": "æ°´æœ" },
            { "word": "æ¡ƒå­", "type": "æ°´æœ" },
            { "word": "æ¨±æ¡ƒ", "type": "æ°´æœ" },
            { "word": "æŸ æª¬", "type": "æ°´æœ" },
            { "word": "å“ˆå¯†ç“œ", "type": "æ°´æœ" },
            { "word": "ç«é¾™æœ", "type": "æ°´æœ" },
            { "word": "è€è™", "type": "åŠ¨ç‰©" },
            { "word": "è¢‹é¼ ", "type": "åŠ¨ç‰©" },
            { "word": "æ¾é¼ ", "type": "åŠ¨ç‰©" },
            { "word": "ä¹Œé¾Ÿ", "type": "åŠ¨ç‰©" },
            { "word": "è´è¶", "type": "åŠ¨ç‰©" },
            { "word": "èœœèœ‚", "type": "åŠ¨ç‰©" },
            { "word": "èœ»èœ“", "type": "åŠ¨ç‰©" },
            { "word": "ç« é±¼", "type": "åŠ¨ç‰©" },
            { "word": "é²¸é±¼", "type": "åŠ¨ç‰©" },
            { "word": "ç”µé£æ‰‡", "type": "å®¶ç”µ" },
            { "word": "å¸å°˜å™¨", "type": "å®¶ç”µ" },
            { "word": "å¹é£æœº", "type": "å®¶ç”µ" },
            { "word": "çƒ¤ç®±", "type": "å®¶ç”µ" },
            { "word": "æ´—ç¢—æœº", "type": "å®¶ç”µ" },
            { "word": "æ‰«åœ°æœºå™¨äºº", "type": "å®¶ç”µ" },
            { "word": "æ•å¤´", "type": "æ—¥ç”¨å“" },
            { "word": "è¢«å­", "type": "æ—¥ç”¨å“" },
            { "word": "æ¢³å­", "type": "æ—¥ç”¨å“" },
            { "word": "æŒ‡ç”²åˆ€", "type": "æ—¥ç”¨å“" },
            { "word": "å«ç”Ÿçº¸", "type": "æ—¥ç”¨å“" },
            { "word": "èŠ±ç“¶", "type": "æ—¥ç”¨å“" },
            { "word": "é—¹é’Ÿ", "type": "æ—¥ç”¨å“" },
            { "word": "å¹³æ¿ç”µè„‘", "type": "ç”µå­äº§å“" },
            { "word": "æ™ºèƒ½æ‰‹è¡¨", "type": "ç”µå­äº§å“" },
            { "word": "æŠ•å½±ä»ª", "type": "ç”µå­äº§å“" },
            { "word": "æ— äººæœº", "type": "ç”µå­äº§å“" },
            { "word": "Uç›˜", "type": "ç”µå­äº§å“" },
            { "word": "å‡ºç§Ÿè½¦", "type": "äº¤é€šå·¥å…·" },
            { "word": "æ•‘æŠ¤è½¦", "type": "äº¤é€šå·¥å…·" },
            { "word": "è­¦è½¦", "type": "äº¤é€šå·¥å…·" },
            { "word": "æ»‘æ¿", "type": "äº¤é€šå·¥å…·" },
            { "word": "è½®èˆ¹", "type": "äº¤é€šå·¥å…·" },
            { "word": "ç«ç®­", "type": "äº¤é€šå·¥å…·" },
            { "word": "é©¬è½¦", "type": "äº¤é€šå·¥å…·" },
            { "word": "é’¢é“ä¾ ", "type": "è™šæ„äººç‰©" },
            { "word": "ç¾å›½é˜Ÿé•¿", "type": "è™šæ„äººç‰©" },
            { "word": "è·¯é£", "type": "è™šæ„äººç‰©" },
            { "word": "é¸£äºº", "type": "è™šæ„äººç‰©" },
            { "word": "æŸ¯å—", "type": "è™šæ„äººç‰©" },
            { "word": "è‘«èŠ¦å¨ƒ", "type": "è™šæ„äººç‰©" },
            { "word": "ç™½é›ªå…¬ä¸»", "type": "è™šæ„äººç‰©" },
            { "word": "å†°æ·‡æ·‹", "type": "é£Ÿç‰©" },
            { "word": "é¥ºå­", "type": "é£Ÿç‰©" },
            { "word": "é¢æ¡", "type": "é£Ÿç‰©" },
            { "word": "æŠ«è¨", "type": "é£Ÿç‰©" },
            { "word": "çƒ¤é¸­", "type": "é£Ÿç‰©" },
            { "word": "ä¸‰æ˜æ²»", "type": "é£Ÿç‰©" },
            { "word": "å·§å…‹åŠ›", "type": "é£Ÿç‰©" },
            { "word": "çˆ†ç±³èŠ±", "type": "é£Ÿç‰©" },
            { "word": "æ˜Ÿæ˜Ÿ", "type": "å¤©ä½“" },
            { "word": "æµæ˜Ÿ", "type": "å¤©ä½“" },
            { "word": "é“¶æ²³", "type": "å¤©ä½“" },
            { "word": "ä¸‹é›¨", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "ä¸‹é›ª", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "é›¾", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "æµ·å•¸", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "åœ°éœ‡", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "æå…‰", "type": "è‡ªç„¶ç°è±¡" },
            { "word": "æ£®æ—", "type": "è‡ªç„¶æ™¯è§‚" },
            { "word": "è‰åŸ", "type": "è‡ªç„¶æ™¯è§‚" },
            { "word": "å¤§æµ·", "type": "è‡ªç„¶æ™¯è§‚" },
            { "word": "å±±æ´", "type": "è‡ªç„¶æ™¯è§‚" },
            { "word": "æ•…å®«", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "é¸Ÿå·¢", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "æ¯”è¨æ–œå¡”", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "æ‚‰å°¼æ­Œå‰§é™¢", "type": "åœ°æ ‡å»ºç­‘" },
            { "word": "æ•™å¸ˆ", "type": "èŒä¸š" },
            { "word": "å¨å¸ˆ", "type": "èŒä¸š" },
            { "word": "æŠ¤å£«", "type": "èŒä¸š" },
            { "word": "ç”»å®¶", "type": "èŒä¸š" },
            { "word": "æ­Œæ‰‹", "type": "èŒä¸š" },
            { "word": "å†œæ°‘", "type": "èŒä¸š" },
            { "word": "å¿«é€’å‘˜", "type": "èŒä¸š" },
            { "word": "å¬è¯Šå™¨", "type": "åŒ»ç–—å™¨æ¢°" },
            { "word": "é’ˆç®¡", "type": "åŒ»ç–—å™¨æ¢°" },
            { "word": "æ¸©åº¦è®¡", "type": "ç§‘å­¦ä»ªå™¨" },
            { "word": "æŒ‡å—é’ˆ", "type": "ç§‘å­¦ä»ªå™¨" },
            { "word": "å›´å·¾", "type": "æœé¥°" },
            { "word": "æ‰‹å¥—", "type": "æœé¥°" },
            { "word": "é¢†å¸¦", "type": "æœé¥°" },
            { "word": "è£™å­", "type": "æœé¥°" },
            { "word": "æ³³è¡£", "type": "æœé¥°" },
            { "word": "å°æç´", "type": "ä¹å™¨" },
            { "word": "ç¬›å­", "type": "ä¹å™¨" },
            { "word": "è¨å…‹æ–¯", "type": "ä¹å™¨" },
            { "word": "çµç¶", "type": "ä¹å™¨" },
            { "word": "éº¦å…‹é£", "type": "è®¾å¤‡" },
            { "word": "ç¾½æ¯›çƒ", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "ç½‘çƒ", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "æ’çƒ", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "æ¸¸æ³³", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "ä¸¾é‡", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "å°„ç®­", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "è·‘æ­¥", "type": "ä½“è‚²è¿åŠ¨" },
            { "word": "æ”¾é£ç­", "type": "ä¼‘é—²æ´»åŠ¨" },
            { "word": "ä¸‹æ£‹", "type": "ä¼‘é—²æ´»åŠ¨" },
            { "word": "çœ‹ä¹¦", "type": "ä¼‘é—²æ´»åŠ¨" },
            { "word": "å”±æ­Œ", "type": "åŠ¨ä½œ" },
            { "word": "è·³èˆ", "type": "åŠ¨ä½œ" },
            { "word": "æ‹¥æŠ±", "type": "åŠ¨ä½œ" },
            { "word": "å“­æ³£", "type": "åŠ¨ä½œ" },
            { "word": "å¤§ç¬‘", "type": "åŠ¨ä½œ" },
            { "word": "æ‹ç…§", "type": "åŠ¨ä½œ" },
            { "word": "ä¸­ç§‹èŠ‚", "type": "èŠ‚æ—¥" },
            { "word": "ç«¯åˆèŠ‚", "type": "èŠ‚æ—¥" },
            { "word": "æƒ…äººèŠ‚", "type": "èŠ‚æ—¥" },
            { "word": "å„¿ç«¥èŠ‚", "type": "èŠ‚æ—¥" },
            { "word": "å¯¹è”", "type": "ç‰©å“" },
            { "word": "ç«ç‘°èŠ±", "type": "ç‰©å“" },
            { "word": "è›‹ç³•", "type": "ç‰©å“" },
            { "word": "ç¤¼ç‰©", "type": "ç‰©å“" },
            { "word": "èœ¡çƒ›", "type": "ç‰©å“" },
            { "word": "æˆ’æŒ‡", "type": "ç‰©å“" },
            { "word": "å‡¤å‡°", "type": "ç¥è¯ç”Ÿç‰©" },
            { "word": "ä¹å°¾ç‹", "type": "ç¥è¯ç”Ÿç‰©" },
            { "word": "å¤–æ˜Ÿäºº", "type": "è™šæ„ç”Ÿç‰©" },
            { "word": "å“¥æ–¯æ‹‰", "type": "è™šæ„ç”Ÿç‰©" },
            { "word": "å˜å½¢é‡‘åˆš", "type": "è™šæ„ç”Ÿç‰©" },
            { "word": "åŒ»é™¢", "type": "åœºæ‰€" },
            { "word": "å­¦æ ¡", "type": "åœºæ‰€" },
            { "word": "è¶…å¸‚", "type": "åœºæ‰€" },
            { "word": "å›¾ä¹¦é¦†", "type": "åœºæ‰€" },
            { "word": "ç”µå½±é™¢", "type": "åœºæ‰€" },
            { "word": "è­¦å¯Ÿå±€", "type": "åœºæ‰€" },
            { "word": "å‰ªåˆ€", "type": "å·¥å…·" },
            { "word": "é”¤å­", "type": "å·¥å…·" },
            { "word": "èºä¸åˆ€", "type": "å·¥å…·" },
            { "word": "æ¢¯å­", "type": "å·¥å…·" }
        ],
        riddleSoup: [
            {
                "q": "ä¸€ä¸ªç”·äººèµ°è¿›é…’å§ï¼Œå‘é…’ä¿è¦äº†ä¸€æ¯æ°´ã€‚é…’ä¿çœ‹äº†ä»–ä¸€çœ¼ï¼Œçªç„¶æå‡ºä¸€æŠŠæªå¯¹å‡†äº†ä»–ã€‚ç”·äººè¯´ï¼š'è°¢è°¢ä½ 'ï¼Œç„¶åç¦»å¼€äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "è¿™ä¸ªç”·äººæ‰“å—ä¸æ­¢ï¼Œæƒ³è¦æ°´æ¥ç¼“è§£ã€‚é…’ä¿ç”¨æªå“äº†ä»–ä¸€è·³ï¼Œæ²»å¥½äº†ä»–çš„æ‰“å—ã€‚"
            },
            {
                "q": "ä¸€ä¸ªå¥³äººå¬åˆ°æ•²é—¨å£°ï¼Œå¥¹æ‰“å¼€é—¨ï¼Œå‘ç°é—¨å¤–ç«™ç€ä¸€ä¸ªé™Œç”Ÿç”·äººã€‚å¥³äººè¯´ï¼š'å“¦ï¼Œæ˜¯ä½ å•Šï¼Œè¯·è¿›ã€‚'ç„¶åç”·äººèµ°äº†è¿›æ¥ã€‚å¥³äººä¹‹å‰å¹¶ä¸è®¤è¯†è¿™ä¸ªç”·äººï¼Œä¸ºä»€ä¹ˆå¥¹ä¼šè¿™æ ·è¯´ï¼Ÿ",
                "a": "å¥³äººæ˜¯ç›²äººï¼Œå¥¹ä»¥ä¸ºæ•²é—¨çš„æ˜¯å¥¹çš„ä¸ˆå¤«ï¼Œä½†å®é™…ä¸Šå¥¹çš„ä¸ˆå¤«å·²ç»å»ä¸–äº†ï¼Œé—¨å¤–æ˜¯ä¸€ä¸ªé™Œç”Ÿäººã€‚(æˆ–è€…ï¼šç”·äººæ˜¯ä¿®æ°´ç®¡/é€å¿«é€’çš„ï¼Œè™½ç„¶æ²¡è§è¿‡ï¼Œä½†å¥³äººé¢„çº¦äº†æœåŠ¡)"
            },
            {
                "q": "ä¸€ä¸ªäººåç«è½¦å»é‚»é•‡çœ‹ç—…ï¼Œçœ‹å®Œç—…å›æ¥æ—¶ï¼Œç«è½¦ç»è¿‡ä¸€ä¸ªéš§é“ï¼Œè¿™ä¸ªäººå°±è·³è½¦è‡ªæ€äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "è¿™ä¸ªäººçš„ç—…æ˜¯çœ¼ç–¾ï¼Œä»–åˆšæ²»å¥½çœ¼ç›é‡è§å…‰æ˜ã€‚ç»è¿‡éš§é“æ—¶è½¦å¢å˜é»‘ï¼Œä»–ä»¥ä¸ºè‡ªå·±åˆçäº†ï¼Œç»æœ›ä¹‹ä¸‹è‡ªæ€ã€‚"
            },
            {
                "q": "ç”·å­åœ¨æ²™æ¼ ä¸­å‘ç°äº†ä¸€å…·å°¸ä½“ï¼Œå°¸ä½“æ—è¾¹æ•£è½ç€å‡ ä¸ªè¡Œæç®±ã€‚ç”·å­çœ‹äº†ä¸€çœ¼ï¼Œå°±çŸ¥é“è°æ˜¯å‡¶æ‰‹ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "è¿™æ˜¯ä¸€èµ·é£æœºå¤±äº‹ï¼Œç”·å­æ˜¯å”¯ä¸€çš„å¹¸å­˜è€…ï¼Œä¹Ÿæ˜¯å› ä¸ºä»–æŠŠå…¶ä»–äººæ¨ä¸‹å»å‡è½»é‡é‡æ‰å¹¸å­˜çš„ï¼Œä»–æ˜¯å‡¶æ‰‹ï¼Œä»–åœ¨å›å¿†ã€‚"
            },
            {
                "q": "å°æ˜åœ¨çœ‹ä¹¦ï¼Œçªç„¶åœç”µäº†ï¼Œä½†æ˜¯å°æ˜è¿˜åœ¨ç»§ç»­çœ‹ä¹¦ï¼Œä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "å°æ˜æ˜¯ç›²äººï¼Œä»–åœ¨çœ‹ç›²æ–‡ä¹¦ã€‚"
            },
            {
                "q": "ä¸€ä¸ªäººä½åœ¨12æ¥¼ï¼Œä»–æ¯å¤©å‡ºé—¨éƒ½åç”µæ¢¯åˆ°1æ¥¼ã€‚å›æ¥æ—¶ï¼Œå¦‚æœæ˜¯ä¸‹é›¨å¤©æˆ–è€…æœ‰äººåŒè¡Œï¼Œä»–ä¼šååˆ°12æ¥¼ï¼›å¦åˆ™ä»–åªååˆ°7æ¥¼ï¼Œç„¶åçˆ¬æ¥¼æ¢¯ä¸Šå»ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "è¿™ä¸ªäººæ˜¯ä¾å„’ï¼ŒæŒ‰ä¸åˆ°12æ¥¼çš„æŒ‰é’®ã€‚ä¸‹é›¨å¤©å¯ä»¥ç”¨é›¨ä¼æŒ‰ï¼Œæœ‰äººåŒè¡Œå¯ä»¥è¯·äººå¸®å¿™ã€‚"
            },
            {
                "q": "ä¸¤ä¸ªäººæ­»åœ¨äº†ä¸€é—´å¯†å®¤é‡Œï¼Œåœ°ä¸Šå…¨æ˜¯æ°´å’Œç¢ç»ç’ƒï¼Œæ­»å› æ˜¯ä»€ä¹ˆï¼Ÿ",
                "a": "è¿™ä¸¤ä¸ªâ€œäººâ€å…¶å®æ˜¯é‡‘é±¼ï¼Œé±¼ç¼¸ç¢äº†ï¼Œå®ƒä»¬å¹²æ­»äº†ã€‚"
            },
            {
                "q": "ç”·å­æ¸…æ™¨é†’æ¥ï¼Œå‘ç°è‡ªå·±åœ¨ä¸€ä¸ªé™Œç”Ÿçš„æˆ¿é—´ï¼Œåœ°ä¸Šæœ‰ä¸€æ»©è¡€å’Œä¸€æŠŠåˆ€ï¼Œä½†ä»–è‡ªå·±èº«ä¸Šæ²¡æœ‰ä¼¤å£ã€‚ä»–éå¸¸é«˜å…´ï¼Œä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "ç”·å­æ˜¯è¢«ç»‘æ¶çš„äººè´¨ï¼Œé‚£æ˜¯ç»‘åŒªçš„è¡€ï¼Œè­¦å¯Ÿåˆšåˆšå†²è¿›æ¥è§£æ•‘äº†ä»–ã€‚"
            },
            {
                "q": "å¥³å­æ¯å¤©éƒ½ç»™æ¤ç‰©æµ‡æ°´ï¼Œä½†æ¤ç‰©è¿˜æ˜¯æ­»äº†ï¼Œä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "é‚£æ˜¯å¡‘æ–™æ¤ç‰©ï¼Œæ°´ç§¯åœ¨æ ¹éƒ¨è…çƒ‚å‘è‡­ï¼Œæˆ–è€…å¥¹æµ‡çš„æ˜¯çƒ­æ°´/é™¤è‰å‰‚ã€‚"
            },
            {
                "q": "ä¸€ä¸ªç”·äººåœ¨æµ·è¾¹åƒäº†ä¸€å£æµ·é¸¥è‚‰ï¼Œç„¶åå°±å“­äº†ï¼Œå¹¶åœ¨ä¸ä¹…åè‡ªæ€ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "å¤šå¹´å‰ä»–é­é‡æµ·éš¾æ¼‚æµï¼ŒåŒä¼´ç»™ä»–åƒè‚‰è¯´æ˜¯æµ·é¸¥è‚‰ã€‚ç°åœ¨ä»–å°åˆ°äº†çœŸæµ·é¸¥è‚‰çš„å‘³é“ï¼Œæ‰æ„è¯†åˆ°å½“å¹´åŒä¼´ç»™ä»–åƒçš„æ˜¯æ­»å»å¦»å­çš„è‚‰ã€‚"
            },
            {
                "q": "æ°å…‹æŠŠè½¦åœåœ¨æ—…é¦†å¤–é¢ï¼Œç„¶åä»–å°±ç ´äº§äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "è¿™æ˜¯åœ¨å¤§å¯Œç¿æ¸¸æˆä¸­ï¼Œä»–èµ°åˆ°äº†åˆ«äººçš„åœ°ç›˜ï¼Œä»˜ä¸èµ·è¿‡è·¯è´¹ã€‚"
            },
            {
                "q": "ä¸€ä¸ªå¥åº·çš„äººè¢«åˆ‡æ–­äº†ä¸€æ ¹æ‰‹æŒ‡ï¼Œä½†ä»–å´ç¬‘äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "é‚£æ˜¯è›‹ç³•åšçš„æ‰‹æŒ‡ï¼ˆä¸‡åœ£èŠ‚æ¶ä½œå‰§ï¼‰ï¼Œæˆ–è€…æ˜¯ä»–åœ¨é›•åˆ»/åšæ‰‹å·¥åˆ‡æ–­çš„æ˜¯å‡æ‰‹æŒ‡ã€‚"
            },
            {
                "q": "çˆ¶äº²ç»™è¿œåœ¨å›½å¤–çš„å¥³å„¿æ‰“äº†ä¸ªç”µè¯ï¼Œè¯´å®Œåè­¦å¯Ÿç«‹åˆ»é€®æ•äº†çˆ¶äº²ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "å¥³å„¿è¢«è°‹æ€äº†ï¼Œè­¦å¯Ÿè¿˜æ²¡å…¬å¸ƒæ­»è®¯ï¼Œçˆ¶äº²å´è¯´â€œçœŸé—æ†¾å¬åˆ°å¥¹å»ä¸–çš„æ¶ˆæ¯â€ï¼Œæš´éœ²äº†ä»–çŸ¥æƒ…ï¼ˆå¯èƒ½æ˜¯ä¹°å‡¶ï¼‰ã€‚"
            },
            {
                "q": "ä¸€ä¸ªäººåœ¨ç‹¬æœ¨æ¡¥ä¸Šè¡Œèµ°ï¼Œå‰é¢æ˜¯ç‹¼ï¼Œåé¢æ˜¯è™ï¼Œä¸‹é¢æ˜¯é³„é±¼ï¼Œä½†ä»–æœ€åå®‰å…¨è¿‡å»äº†ï¼Œæ€ä¹ˆåšåˆ°çš„ï¼Ÿ",
                "a": "ä»–æ™•è¿‡å»äº†ã€‚"
            },
            {
                "q": "åŠå¤œï¼Œç”µæ¢¯é—¨å¼€äº†ï¼Œé‡Œé¢ç©ºæ— ä¸€äººï¼Œä½†é—¨å£çš„äººå´å°–å«ç€è·‘äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "å› ä¸ºç”µæ¢¯æ˜¯ä»æ¥¼ä¸Šä¸‹æ¥çš„ï¼Œä½†ç”µæ¢¯é‡Œçš„äººå¤´é«˜åº¦çš„é•œå­ä¸Šæ²¡æœ‰æ˜ å‡ºä»»ä½•ä¸œè¥¿ï¼ˆæˆ–è€…æ˜¯ç”µæ¢¯è¶…é‡è­¦æŠ¥å“äº†ï¼‰ã€‚"
            },
            {
                "q": "ä¸€ä¸ªå¥³äººä¹°äº†ä¸€åŒçº¢è‰²çš„é«˜è·Ÿé‹ï¼Œå›å®¶åå¥¹å°±æ­»äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "å¥¹æ˜¯æ‚æŠ€å›¢é‡Œçš„é£åˆ€è¡¨æ¼”åŠ©æ‰‹ï¼Œè¡¨æ¼”æ—¶å¥¹éœ€è¦å¤´é¡¶è‹¹æœã€‚æ–°ä¹°çš„é«˜è·Ÿé‹é‹è·Ÿæ¯”å¹³æ—¶çš„é«˜ï¼Œå¯¼è‡´å¥¹èº«é«˜å˜é«˜äº†ï¼Œé£åˆ€æ‰‹æŒ‰ç…§ä¹ æƒ¯çš„é«˜åº¦æ‰”åˆ€ï¼Œç»“æœåˆºä¸­äº†å¥¹çš„å¤´ã€‚"
            },
            {
                "q": "æ»¡åœ°æœ¨å±‘ï¼Œä¸€ä¸ªä¾å„’åœ¨æˆ¿é—´é‡Œè‡ªæ€äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "ä¾å„’æ˜¯é©¬æˆå›¢çš„ç›²äººæ˜æ˜Ÿã€‚æœ‰äººä¸ºäº†æ¶ä½œå‰§ï¼ˆæˆ–å«‰å¦’ï¼‰ï¼ŒæŠŠä»–å¸¸ç”¨çš„æ‹æ–é”¯çŸ­äº†ä¸€æˆªã€‚ä¾å„’å›å®¶ç”¨æ‹æ–æ—¶ï¼Œä»¥ä¸ºè‡ªå·±çªç„¶é•¿é«˜äº†ï¼Œè¿™æ„å‘³ç€ä»–å°†å¤±å»ä¾å„’è¡¨æ¼”çš„å·¥ä½œï¼Œç»æœ›ä¹‹ä¸‹è‡ªæ€ã€‚"
            },
            {
                "q": "ç”·å­åœ¨çœ‹æŠ¥çº¸ï¼Œçœ‹åˆ°ä¸€æ¡æ¶ˆæ¯åï¼Œä»–ç«‹åˆ»å»è­¦å¯Ÿå±€è‡ªé¦–äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "æŠ¥çº¸ä¸ŠåˆŠç™»äº†è¿ç¯æ€æ‰‹çš„é€šç¼‰ç”»åƒã€‚ç”·å­ä¹‹å‰èŠ±å¤§ä»·é’±åšäº†æ•´å®¹æ‰‹æœ¯æ¥é€ƒé¿è¿½æ•ï¼Œç»“æœå‘ç°æ•´å®¹åŒ»ç”ŸæŠŠä»–æ•´æˆäº†é€šç¼‰ä»¤ä¸Šç”»åƒçš„æ ·å­ï¼ˆå¯èƒ½æ˜¯åŒ»ç”Ÿæ•…æ„çš„æˆ–è€…åŒ»ç”Ÿåªæœ‰è¿™å¼ å‚è€ƒå›¾ï¼‰ã€‚"
            },
            {
                "q": "ä¸€ä¸ªäººåœ¨æ²™æ¼ é‡Œå‘ç°äº†ä¸€æ ¹çƒ§è¿‡çš„ç«æŸ´ï¼Œç„¶åä»–æ­»äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "ä»–å’ŒåŒä¼´ä¹˜åçš„çƒ­æ°”çƒåœ¨ç©¿è¶Šæ²™æ¼ æ—¶è¶…é‡æ¼æ°”ï¼Œå¤§å®¶æ‰”æ‰äº†æ‰€æœ‰è¡Œæè¿˜æ˜¯ä¸è¡Œã€‚æœ€åå†³å®šæŠ½ç­¾ï¼ŒæŠ½åˆ°çŸ­ç«æŸ´ï¼ˆçƒ§æ–­çš„ï¼‰çš„äººè·³ä¸‹å»ã€‚ä»–æŠ½åˆ°äº†ï¼Œæ‰€ä»¥è·³ä¸‹å»æ‘”æ­»äº†ã€‚"
            },
            {
                "q": "ä¸€ä½å…ˆç”Ÿå»å‚åŠ å®´ä¼šï¼Œå› ä¸ºæ²¡æ—¶é—´åªåƒäº†ä¸€ç‚¹æ²™æ‹‰ã€‚å®´ä¼šè¿›è¡Œåˆ°ä¸€åŠï¼Œå¤§å®¶éƒ½çªç„¶æ­»äº†ï¼Œåªæœ‰ä»–æ²¡äº‹ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "å› ä¸ºé£Ÿç‰©é‡Œæœ‰æ¯’ï¼Œæ¯’åœ¨æ²™æ‹‰é…±æˆ–è€…å…¶ä»–çƒ­èœé‡Œï¼Œæˆ–è€…æ¯’è¯æ˜¯åœ¨å†°å—é‡Œï¼Œä»–å–é¥®æ–™å–å¾—å¿«ï¼Œå†°å—è¿˜æ²¡åŒ–æ¯’è¯æ²¡å‡ºæ¥ï¼Œè€Œå…¶ä»–äººæ…¢æ…¢å–å†°å—åŒ–äº†å°±ä¸­æ¯’äº†ã€‚"
            },
            {
                "q": "ç”·å­æ¯å¤©ç¡è§‰å‰éƒ½æŠŠåŠ©å¬å™¨æ‘˜ä¸‹æ¥æ”¾è¿›æŠ½å±‰ã€‚æœ‰ä¸€å¤©ä»–å¿˜è®°æ‘˜äº†ï¼Œç¬¬äºŒå¤©ä»–æ­»äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "ä»–ä½åœ¨é—¹å¸‚åŒºï¼ˆæˆ–é“è½¨æ—ï¼‰ï¼Œä¹ æƒ¯äº†æˆ´åŠ©å¬å™¨ç¡è§‰ä¼šè¢«åµé†’ï¼Œæ‰€ä»¥æ¯æ™šæ‘˜ä¸‹ã€‚é‚£æ™šä»–å¿˜äº†æ‘˜ï¼Œæ·±å¤œç…¤æ°”æ³„æ¼çš„è­¦æŠ¥å£°å¤§ä½œï¼Œä½†ä»–å¹³æ—¶ä¹ æƒ¯äº†æœ‰å™ªéŸ³ä»¥ä¸ºæ˜¯å¤–é¢çš„å£°éŸ³ï¼Œå°±æ²¡æœ‰ç†ä¼šï¼Œç»“æœç…¤æ°”ä¸­æ¯’è€Œæ­»ï¼ˆæˆ–è€…åè¿‡æ¥ï¼šä»–æ²¡æˆ´åŠ©å¬å™¨ï¼Œæ²¡å¬åˆ°è­¦æŠ¥è€Œæ­»ï¼‰ã€‚"
            },
            {
                "q": "ä¸€ä¸ªç”·äººä¸ŠåŠè‡ªæ€äº†ï¼Œæˆ¿é—´é‡Œç©ºè¡è¡çš„ï¼Œé—¨çª—ç´§é”ï¼Œåœ°ä¸Šåªæœ‰ä¸€æ»©æ°´ã€‚ä»–æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ",
                "a": "ä»–ç«™åœ¨ä¸€å—å·¨å¤§çš„å†°å—ä¸Šä¸ŠåŠï¼Œå†°å—èåŒ–åå°±å˜æˆäº†æ°´ï¼Œæ‚¬ç©ºçš„ä»–å› æ­¤çª’æ¯è€Œæ­»ã€‚"
            },
            {
                "q": "ä¸¤å…„å¼Ÿå‡ºç”Ÿæ—¶é—´åªå·®å‡ åˆ†é’Ÿï¼Œä½†æ˜¯æ¯å¹´ä»–ä»¬çš„ç”Ÿæ—¥å´ä¸åœ¨ä¸€èµ·ï¼Œä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "ä¸€è‰˜èˆ¹æ­£åœ¨è·¨è¶Šå›½é™…æ—¥æœŸå˜æ›´çº¿ã€‚å“¥å“¥åœ¨æ—¥æœŸå˜æ›´çº¿ä¸€ä¾§å‡ºç”Ÿï¼Œèˆ¹è¿‡åå¼Ÿå¼Ÿå‡ºç”Ÿï¼Œå¯¼è‡´æ—¥æœŸç›¸å·®ä¸€å¤©ï¼ˆæˆ–è€…ä»–ä»¬ä¸€ä¸ªåœ¨2æœˆ29æ—¥å‡ºç”Ÿï¼Œä¸€ä¸ªåœ¨3æœˆ1æ—¥å‡ºç”Ÿï¼Œéé—°å¹´æ—¶ç”Ÿæ—¥ä¸åŒï¼‰ã€‚"
            },
            {
                "q": "ä¸€ä¸ªå¥³äººåœ¨è¶…å¸‚ä¹°ä¸œè¥¿ï¼Œç”±äºä¹°å¾—å°‘ï¼Œæ”¶é“¶å‘˜çœ‹äº†ä¸€çœ¼è¯´ï¼šâ€˜ä½ æ˜¯å•èº«å§ï¼Ÿâ€™å¥³äººå¾ˆæƒŠè®¶ï¼Œé—®ä¸ºä»€ä¹ˆï¼Œæ”¶é“¶å‘˜çš„å›ç­”è®©å¥¹æ— è¯­ã€‚æ”¶é“¶å‘˜è¯´äº†ä»€ä¹ˆï¼Ÿ",
                "a": "æ”¶é“¶å‘˜è¯´ï¼šâ€˜å› ä¸ºä½ é•¿å¾—ä¸‘ã€‚â€™ï¼ˆè¿™æ˜¯ä¸€åˆ™åå¥—è·¯çš„å†·ç¬‘è¯å¼æ±¤é¢ï¼Œå¼ºè°ƒæ‰“ç ´â€˜å› ä¸ºä¹°äº†ä¸€ä»½ä¸œè¥¿â€™çš„å¸¸è§„é€»è¾‘ï¼‰ã€‚"
            },
            {
                "q": "ç”·å­ç«™åœ¨çª—å‰çœ‹é£æ™¯ï¼Œçªç„¶ä»–è½¬èº«è·³å‡ºäº†çª—æˆ·ï¼Œæ‘”æ­»äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                "a": "ä»–æ˜¯çª—æˆ·æ¸…æ´å·¥ï¼Œæˆ–è€…æ˜¯æ­£åœ¨æ“¦çª—æˆ·çš„äººã€‚ä»–ä»¥ä¸ºé‚£æ˜¯è½åœ°çª—çš„ç»ç’ƒï¼Œç»“æœç»ç’ƒå·²ç»è¢«æ‹†æ‰äº†ï¼ˆæˆ–è€…ä»–æ˜¯åœ¨æ½œæ°´è‰‡é‡Œï¼Œçœ‹åˆ°äº†â€˜é£æ™¯â€™ä»¥ä¸ºæ˜¯å¤–é¢ï¼Œå…¶å®æ˜¯å¹»è§‰/å±å¹•ï¼Œä½†ä»–æ‰“å¼€äº†èˆ±é—¨ï¼‰ã€‚æœ€ç»å…¸è§£æ³•ï¼šä»–æ˜¯æ“¦ç»ç’ƒçš„ï¼Œå¤–é¢é£å¤§ï¼Œä»–æƒ³è¿›å±‹ï¼Œç»“æœæŠŠçª—æˆ·å‘å¤–æ¨ï¼ˆæˆ–è€…å‘å†…æ‹‰é”™æ–¹å‘ï¼‰å¯¼è‡´å¤±è¶³ã€‚"
            },
            {
                "q": "ä¸€ä¸ªäººè¢«å‘ç°æ­»åœ¨æ²™æ¼ é‡Œï¼Œæ‰‹ç´§ç´§æ¡ç€åŠæˆªç«æŸ´ï¼Œèº«ä¸Šæ²¡æœ‰å¤–ä¼¤ã€‚æ€ä¹ˆå›äº‹ï¼Ÿï¼ˆå˜ä½“è¡¥å……ï¼‰",
                "a": "çƒ­æ°”çƒæ•…éšœï¼Œéœ€è¦å‡è½»é‡é‡ï¼Œæ‰€æœ‰äººæ‰”å®Œè¡Œæåå†³å®šæŠ½ç­¾ï¼ŒæŠ½åˆ°æ–­ç«æŸ´çš„äººè·³ä¸‹å»ï¼Œä»–è¾“äº†ã€‚"
            },
            {
                "q": "ä¸€åç”·å­è¢«å›°åœ¨ä¸€ä¸ªæ²¡æœ‰çª—æˆ·ã€åªæœ‰ä¸€æ‰‡è¢«é”ä½çš„é“é—¨çš„æˆ¿é—´é‡Œã€‚æˆ¿é—´é‡Œåªæœ‰ä¸€å¼ æ¡Œå­å’Œä¸€æŠŠé”¯å­ã€‚ä»–æ€ä¹ˆé€ƒå‡ºå»çš„ï¼Ÿ",
                "a": "ä»–æŠŠæ¡Œå­é”¯æˆä¸¤åŠï¼Œä¸¤ä¸ªåŠåœ†æ‹¼æˆä¸€ä¸ªâ€˜å…¨åœ†â€™ï¼ˆå…¨å‘˜ï¼‰ï¼Œç„¶åä»–å°±å’Œå…¨å‘˜ä¸€èµ·å‡ºå»äº†ã€‚ï¼ˆæ–‡å­—æ¸¸æˆç±»æ±¤é¢ï¼‰ã€‚æˆ–è€…ï¼šä»–ç”¨é”¯å­é”¯æ–­äº†æ¡Œå­è…¿ï¼Œç”¨æœ¨å¤´ç ¸å¼€äº†é”ï¼ˆç‰©ç†ç±»ï¼‰ã€‚"
            },
            {
                "q": "ä¸€ä¸ªç›²äººèµ°åˆ°æ‚¬å´–è¾¹ï¼Œä¸ºä»€ä¹ˆä»–åœä¸‹äº†è„šæ­¥ï¼Ÿ",
                "a": "å› ä¸ºä»–æ˜¯ç‹¬çœ¼é¾™ï¼ˆä¸€åªçœ¼çï¼‰ï¼Œå¦ä¸€åªçœ¼çœ‹å¾—åˆ°ã€‚æˆ–è€…ï¼šå¯¼ç›²çŠ¬åœä¸‹äº†ã€‚"
            },
            {
                "q": "å°çº¢å’Œå¦ˆå¦ˆå»ä¹°è¡£æœï¼Œè¯•è¡£é—´é‡Œä¼ æ¥ä¸€å£°æƒ¨å«ï¼Œå¤§å®¶å†²è¿›å»å‘ç°å°çº¢æ­»äº†ï¼Œå¦ˆå¦ˆæ‰‹é‡Œæ‹¿ç€å‡¶å™¨ã€‚ä¸ºä»€ä¹ˆè­¦å¯Ÿåˆ¤å®šæ˜¯æ„å¤–ï¼Ÿ",
                "a": "å¦ˆå¦ˆåœ¨å¸®å°çº¢æ‹‰èƒŒåçš„æ‹‰é“¾ï¼Œæ‹‰é“¾å¡ä½äº†çš®è‚‰æˆ–è€…ç”¨åŠ›è¿‡çŒ›å¯¼è‡´æŸç§æ„å¤–ï¼ˆè¾ƒå°‘è§ï¼‰ã€‚æ›´ç»å…¸çš„è§£æ³•ï¼šé‚£æ˜¯åŒèƒèƒå§å¦¹ï¼Œé‚£æ˜¯è¿ä½“å©´åˆ†ç¦»æ‰‹æœ¯å¤±è´¥ï¼ˆæ¯”è¾ƒç‰µå¼ºï¼‰ã€‚æœ€åˆç†çš„ï¼šå¦ˆå¦ˆæ˜¯åŒ»ç”Ÿï¼Œæ­£åœ¨è¿›è¡Œç´§æ€¥æ°”ç®¡åˆ‡å¼€æœ¯ä½†å¤±è´¥äº†ã€‚"
            },
            {
                "q": "ä¸€ä¸ªäººåœ¨å…¬å›­çš„é•¿æ¤…ä¸Šè¯»æŠ¥çº¸ï¼Œè¯»ç€è¯»ç€ä»–æ­»å»äº†ã€‚åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ",
                "a": "ä»–è¯»çš„æ˜¯æ˜¨å¤©ç”šè‡³æ›´æ—©çš„æŠ¥çº¸ï¼Œä¸Šé¢æœ‰é¢„è¨€æˆ–æ¶ˆæ¯è¯å®äº†ä»–æ— æ³•æ¥å—çš„äº‹å®ï¼ˆä¾‹å¦‚è‚¡å¸‚å´©ç›˜ã€å”¯ä¸€çš„äº²äººå»ä¸–ï¼‰ï¼Œå¿ƒè„ç—…å‘ä½œã€‚"
            }
        ],
        brainTeaser: [
            { "q": "ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ", "a": "æ°´" },
            { "q": "ä»€ä¹ˆé—¨æ°¸è¿œå…³ä¸ä¸Šï¼Ÿ", "a": "çƒé—¨" },
            { "q": "å¤ªå¹³æ´‹çš„ä¸­é—´æ˜¯ä»€ä¹ˆï¼Ÿ", "a": "æ˜¯â€œå¹³â€å­—" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æ—©ä¸Šå››æ¡è…¿ï¼Œä¸­åˆä¸¤æ¡è…¿ï¼Œæ™šä¸Šä¸‰æ¡è…¿ï¼Ÿ", "a": "äººï¼ˆå©´å„¿çˆ¬ï¼Œæˆå¹´èµ°ï¼Œè€å¹´æ‹„æ‹ï¼‰" },
            { "q": "å·ä»€ä¹ˆä¸œè¥¿ä¸çŠ¯æ³•ï¼Ÿ", "a": "å·ç¬‘" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æœ‰ç‰™é½¿å´ä¸èƒ½å’¬ä¸œè¥¿ï¼Ÿ", "a": "æ¢³å­" },
            { "q": "ä»€ä¹ˆå¸ƒå‰ªä¸æ–­ï¼Ÿ", "a": "ç€‘å¸ƒ" },
            { "q": "ä»€ä¹ˆè·¯æœ€çª„ï¼Ÿ", "a": "å†¤å®¶è·¯çª„" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æœ‰å¤´ã€æœ‰å°¾ï¼Œä½†æ˜¯æ²¡æœ‰èº«ä½“ï¼Ÿ", "a": "ç¡¬å¸" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æ™šä¸Šé•¿å‡ºå°¾å·´ï¼Œç™½å¤©å°¾å·´å°±ä¸è§äº†ï¼Ÿ", "a": "æµæ˜Ÿï¼ˆæˆ–è€…è¢«å­/ç¡è¡£çš„å½¢è±¡æ¯”å–»ï¼Œé€šå¸¸ç­”æ¡ˆæ˜¯æµæ˜Ÿï¼‰" },
            { "q": "ä¸€åªé¸¡å’Œä¸€åªé¹…åŒæ—¶æ”¾è¿›å†°ç®±ï¼Œä¸ºä»€ä¹ˆé¸¡æ­»äº†é¹…æ²¡æ­»ï¼Ÿ", "a": "å› ä¸ºæ˜¯ä¼é¹…" },
            { "q": "ä»€ä¹ˆäººç”Ÿç—…ä»æ¥ä¸çœ‹åŒ»ç”Ÿï¼Ÿ", "a": "ç›²äºº" },
            { "q": "å°æ˜çŸ¥é“è¯•å·çš„ç­”æ¡ˆï¼Œä¸ºä»€ä¹ˆè¿˜æ˜¯è€ƒäº†é›¶åˆ†ï¼Ÿ", "a": "å› ä¸ºä»–å†™çš„æ˜¯åˆ¤æ–­é¢˜çš„ç­”æ¡ˆï¼Œé¢˜ç›®æ˜¯å¡«ç©ºé¢˜ï¼ˆæˆ–è€…ä»–æ²¡å†™åœ¨è¯•å·ä¸Šï¼‰" },
            { "q": "ä»€ä¹ˆä¹¦ä¹°ä¸åˆ°ï¼Ÿ", "a": "ç§˜ä¹¦" },
            { "q": "ä»€ä¹ˆä¸œè¥¿è¶Šç”¨è¶Šå°‘ï¼Ÿ", "a": "ç”Ÿå‘½ / æ©¡çš® / èœ¡çƒ›" },
            { "q": "ä»€ä¹ˆä¸œè¥¿è¶Šç”¨è¶Šå¤šï¼Ÿ", "a": "çŸ¥è¯† / æŠ€èƒ½" },
            { "q": "ä»€ä¹ˆæµ·æ²¡æœ‰æ°´ï¼Ÿ", "a": "è¾æµ· / è„‘æµ·" },
            { "q": "ä»€ä¹ˆç“œä¸èƒ½åƒï¼Ÿ", "a": "å‚»ç“œ" },
            { "q": "ä»€ä¹ˆé›¨ä¸ä¸‹åœ¨å¤©ä¸Šï¼Ÿ", "a": "æªæ—å¼¹é›¨" },
            { "q": "ä»€ä¹ˆè½¦ä¸è€—æ²¹ä¹Ÿä¸ç”¨ç”µï¼Ÿ", "a": "é£è½¦ / è‡ªè¡Œè½¦" },
            { "q": "ä¸€ä¸ªæœˆæœ€å¤šæœ‰å‡ ä¸ªæ˜ŸæœŸäº”ï¼Ÿ", "a": "5ä¸ª" },
            { "q": "æ”¾å¤§é•œä¸èƒ½æ”¾å¤§çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆï¼Ÿ", "a": "è§’åº¦" },
            { "q": "ä»€ä¹ˆä¸œè¥¿è¢«æ‰“ç¢äº†ï¼Œå¤§å®¶éƒ½å¾ˆé«˜å…´ï¼Ÿ", "a": "è®°å½• / å­˜é’±ç½" },
            { "q": "å“ªä¸€ä¸ªæœˆæœ‰28å¤©ï¼Ÿ", "a": "æ¯ä¸ªæœˆéƒ½æœ‰" },
            { "q": "ä»€ä¹ˆä¸œè¥¿åªæœ‰ä¸€åªè„šï¼Ÿ", "a": "è˜‘è‡ / èºä¸é’‰" },
            { "q": "ä»€ä¹ˆè›‹ä¸èƒ½åƒï¼Ÿ", "a": "é›¶è›‹ / ç‚¸å¼¹" },
            { "q": "ä»€ä¹ˆé©¬ä¸ä¼šè·‘ï¼Ÿ", "a": "æœ¨é©¬ / æµ·é©¬" },
            { "q": "è°æ˜¯ä¸‡å…½ä¹‹ç‹ï¼Ÿ", "a": "åŠ¨ç‰©å›­å›­é•¿" },
            { "q": "ä»€ä¹ˆä¸œè¥¿çœ‹ä¸è§æ‘¸ä¸ç€ï¼Œä½†å¯ä»¥å……æ»¡æˆ¿é—´ï¼Ÿ", "a": "å…‰ / ç©ºæ°” / å£°éŸ³" },
            { "q": "å†å²ä¸Šè°è·‘å¾—æœ€å¿«ï¼Ÿ", "a": "æ›¹æ“ï¼ˆè¯´åˆ°æ›¹æ“ï¼Œæ›¹æ“å°±åˆ°ï¼‰" },
            { "q": "ä»€ä¹ˆè€é¼ ä¸¤æ¡è…¿ï¼Ÿ", "a": "ç±³è€é¼ " },
            { "q": "ä»€ä¹ˆé¸­å­ä¸¤æ¡è…¿ï¼Ÿ", "a": "æ‰€æœ‰é¸­å­ï¼ˆæ¥ä¸Šé¢˜ï¼šå”è€é¸­ä¹Ÿæ˜¯ï¼‰" },
            { "q": "ä¸–ç•Œä¸Šä»€ä¹ˆäººä¸€ä¸‹å­å˜è€ï¼Ÿ", "a": "æ–°å¨˜ï¼ˆå› ä¸ºä»Šå¤©æ˜¯æ–°å¨˜ï¼Œæ˜å¤©æ˜¯è€å©†ï¼‰" },
            { "q": "éº’éºŸé£åˆ°åŒ—æä¼šå˜æˆä»€ä¹ˆï¼Ÿ", "a": "å†°æ·‡æ·‹ (å†°éº’éºŸ)" },
            { "q": "å“ªç§ç«¹å­ä¸é•¿åœ¨åœŸé‡Œï¼Ÿ", "a": "çˆ†ç«¹" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æ”¾åœ¨ç«é‡Œçƒ¤ä¸çƒ­ï¼Ÿ", "a": "è¿˜æ²¡æ”¾è¿›å»çš„æ—¶å€™ / å®ƒæ˜¯è€ç«ææ–™" },
            { "q": "äººåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šä¸ƒçªç”ŸçƒŸï¼Ÿ", "a": "ç«è‘¬çš„æ—¶å€™" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æœ‰é£ä¸åŠ¨æ— é£åŠ¨ï¼Ÿ", "a": "æ‰‡å­" },
            { "q": "ä¸¤å¯¹çˆ¶å­å»ä¹°å¸½å­ï¼Œä¸ºä»€ä¹ˆåªä¹°äº†ä¸‰é¡¶ï¼Ÿ", "a": "å› ä¸ºæ˜¯ çˆ·çˆ·ã€çˆ¸çˆ¸ã€å„¿å­" },
            { "q": "ä»€ä¹ˆå­—å¤§å®¶éƒ½ä¼šå¿µé”™ï¼Ÿ", "a": "é”™å­—" },
            { "q": "é»‘ç§äººå’Œé»„ç§äººç”Ÿçš„å­©å­ï¼Œç‰™é½¿æ˜¯ä»€ä¹ˆé¢œè‰²çš„ï¼Ÿ", "a": "å©´å„¿æ²¡æœ‰ç‰™é½¿" },
            { "q": "ä»€ä¹ˆä¸œè¥¿èƒ½åƒï¼Œèƒ½ç©ï¼Œèƒ½æ‰“ï¼Ÿ", "a": "éº»å°†" },
            { "q": "ä¸ºä»€ä¹ˆé£æœºé£è¿™ä¹ˆé«˜ï¼Ÿ", "a": "å› ä¸ºä¸Šé¢è·¯å®½" },
            { "q": "çŒ´å­æ¯åˆ†é’Ÿèƒ½æ°ä¸€ä¸ªç‰ç±³ï¼Œåœ¨æœå›­é‡Œï¼Œä¸€åªçŒ´å­5åˆ†é’Ÿèƒ½æ°å‡ ä¸ªç‰ç±³ï¼Ÿ", "a": "0ä¸ªï¼Œå› ä¸ºæœå›­é‡Œæ²¡æœ‰ç‰ç±³" },
            { "q": "æ€ä¹ˆç”¨ä¸‰æ ¹ç­·å­æ­æˆä¸€ä¸ªæ¯”3å¤§æ¯”4å°çš„æ•°ï¼Ÿ", "a": "æ­æˆåœ†å‘¨ç‡ Ï€" },
            { "q": "ä¸ºä»€ä¹ˆå¤§é›ç§‹å¤©è¦é£åˆ°å—æ–¹å»ï¼Ÿ", "a": "å› ä¸ºèµ°è¿‡å»å¤ªè¿œäº†" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æœ‰äº”ä¸ªå¤´ï¼Œä½†äººä¸è§‰å¾—å¥‡æ€ªï¼Ÿ", "a": "æ‰‹/è„šï¼ˆæœ‰äº”ä¸ªæŒ‡å¤´ï¼‰" },
            { "q": "ä¸€ä¸ªç›’å­çš„è¾¹æœ‰å‡ ä¸ªï¼Ÿ", "a": "ä¸¤ä¸ªï¼Œé‡Œè¾¹å’Œå¤–è¾¹" },
            { "q": "ä¸ºä»€ä¹ˆè­¦å¯Ÿå¯¹é—¯çº¢ç¯çš„æ±½è½¦è§†è€Œä¸è§ï¼Ÿ", "a": "å› ä¸ºæ±½è½¦æ²¡åŠ¨ï¼Œåœåœ¨è·¯è¾¹" },
            { "q": "å“ªç§æ¯”èµ›ï¼Œèµ¢çš„å¾—ä¸åˆ°å¥–å“ï¼Œè¾“çš„å´æœ‰å¥–å“ï¼Ÿ", "a": "åˆ’æ‹³ï¼ˆè¾“çš„ç½šé…’ï¼‰" },
            { "q": "ä»€ä¹ˆäººå§‹ç»ˆä¸æ•¢æ´—æ¾¡ï¼Ÿ", "a": "æ³¥äºº" },
            { "q": "ä»€ä¹ˆä¸œè¥¿ä¸èƒ½ç”¨æ”¾å¤§é•œæ”¾å¤§ï¼Ÿ", "a": "è§’åº¦" },
            { "q": "ä»€ä¹ˆä¸œè¥¿å€Ÿäº†ä¸ç”¨è¿˜ï¼Ÿ", "a": "å€Ÿå…‰" },
            { "q": "ä¸–ç•Œä¸Šå“ªä¸ªæµ·ä¸äº§é±¼ï¼Ÿ", "a": "è¾æµ·" },
            { "q": "ä»€ä¹ˆä¸œè¥¿ä¹°çš„äººä¸ç©¿ï¼Œç©¿çš„äººä¸ä¹°ï¼Œçœ‹åˆ°çš„äººä¸ç©¿ï¼Ÿ", "a": "æ£ºæ/å¯¿è¡£" },
            { "q": "å“ªç§åŠ¨ç‰©æœ€æ²¡æœ‰æ–¹å‘æ„Ÿï¼Ÿ", "a": "éº‹é¹¿ï¼ˆè¿·è·¯ï¼‰" },
            { "q": "ä¸€æ–¤é“å’Œä¸€æ–¤æ£‰èŠ±å“ªä¸ªé‡ï¼Ÿ", "a": "ä¸€æ ·é‡" },
            { "q": "å·¦æ‰‹èƒ½æ‹¿ï¼Œå³æ‰‹æ‹¿ä¸åˆ°çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆï¼Ÿ", "a": "å³æ‰‹" },
            { "q": "ä»€ä¹ˆäººä¸€å¹´åªå·¥ä½œä¸€å¤©ï¼Ÿ", "a": "åœ£è¯è€äºº" },
            { "q": "ä»€ä¹ˆç½‘ä¸èƒ½æŠ“é±¼ï¼Ÿ", "a": "äº’è”ç½‘ / èœ˜è››ç½‘" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æœ‰è„šå´ä¸èƒ½èµ°è·¯ï¼Ÿ", "a": "æ¡Œå­ / æ¤…å­" },
            { "q": "å°æ˜å®¶æœ‰ä¸‰ä¸ªå„¿å­ï¼Œå¤§å„¿å­å«å¤§æ¯›ï¼ŒäºŒå„¿å­å«äºŒæ¯›ï¼Œä¸‰å„¿å­å«ä»€ä¹ˆï¼Ÿ", "a": "å°æ˜" },
            { "q": "ä»€ä¹ˆä¸œè¥¿å¾€ä¸Šå‡æ°¸è¿œä¸æ‰ä¸‹æ¥ï¼Ÿ", "a": "å¹´é¾„" },
            { "q": "ä»€ä¹ˆä¸œè¥¿æ‰“ç ´äº†æ‰èƒ½ç”¨ï¼Ÿ", "a": "é¸¡è›‹" },
            { "q": "å†¬ç“œã€é»„ç“œã€è¥¿ç“œã€å—ç“œéƒ½èƒ½åƒï¼Œä»€ä¹ˆç“œä¸èƒ½åƒï¼Ÿ", "a": "å‚»ç“œ" },
            { "q": "ä¸ºä»€ä¹ˆæµæ°“åè½¦ä¸ç»™é’±ï¼Ÿ", "a": "å› ä¸ºé‚£æ˜¯è­¦è½¦ï¼ˆä»–è¢«æŠ“äº†ï¼‰" },
            { "q": "ä»€ä¹ˆæ¡¶æ°¸è¿œè£…ä¸æ»¡ï¼Ÿ", "a": "é©¬æ¡¶" },
            { "q": "æœ‰ä¸€å¤´å¤´æœåŒ—çš„ç‰›ï¼Œå®ƒå‘å³è½¬åŸåœ°ä¸‰åœˆï¼Œç„¶åå‘åè½¬åŸåœ°ä¸‰åœˆï¼Œæ¥ç€å†å¾€å³è½¬ï¼Œè¿™æ—¶å€™å®ƒçš„å°¾å·´æœå“ªï¼Ÿ", "a": "æœä¸‹" },
            { "q": "ä¸€ä¸ªäººæ‰è¿›æ²³é‡Œï¼Œä¸ºä»€ä¹ˆä»–çš„å¤´å‘æ²¡æœ‰æ¹¿ï¼Ÿ", "a": "å› ä¸ºä»–æ˜¯å…‰å¤´" },
            { "q": "å°ç‹æ˜¯ä¸€åä¼˜ç§€å£«å…µï¼Œåœ¨ç«™å²—å€¼å‹¤æ—¶ï¼Œæ˜æ˜çœ‹åˆ°æœ‰æ•Œäººæ‚„æ‚„å‘ä»–æ‘¸è¿‡æ¥ï¼Œä¸ºä»€ä¹ˆä»–å´çä¸€åªçœ¼é—­ä¸€åªçœ¼ï¼Ÿ", "a": "ä»–åœ¨ç„å‡†" },
            { "q": "ä»€ä¹ˆä¸œè¥¿å¤©æ°”è¶Šçƒ­ï¼Œå®ƒçˆ¬å¾—è¶Šé«˜ï¼Ÿ", "a": "æ¸©åº¦è®¡" }
        ],
        math: {
            "easy": [
                "5+3", "7+2", "9-4", "6+8", "10-2", "3+4", "8-1", "2+2", "5+5", "9-3",
                "1+9", "7-5", "4+6", "8+2", "6-3", "5+1", "10-5", "3+7", "2+8", "9+1",
                "4-2", "6+2", "7+3", "8-4", "5-2", "1+5", "3+3", "9-6", "7-2", "4+4",
                "2+6", "10-8", "6+4", "5+3", "8-5", "9-2", "1+7", "3+5", "7-4", "4+1",
                "2+5", "6-2", "8+1", "10-3", "5+4", "9-5", "3+2", "7+1", "4+3", "6-1",
                "12-6", "15-7", "9+8", "7+6", "11-4", "5+9", "13-5", "8+7", "14-6", "6+9",
                "3Ã—2", "4Ã—2", "5Ã—1", "2Ã—6", "10Ã·2", "8Ã·2", "9Ã·3", "6Ã·3", "4Ã·2", "5Ã·5",
                "20-10", "18-9", "16-8", "12+8", "15+5", "11+9", "19-7", "17-4", "13+6", "10+10",
                "2+9", "11-3", "12-4", "13-7", "14-5", "15-6", "16-9", "17-8", "18-10", "9+4",
                "8+5", "7+7", "6+6", "5+8", "4+9", "3+8", "10+2", "20-5", "15-2", "11+2",
                "1Ã—5", "2Ã—3", "3Ã—3", "4Ã—1", "5Ã—2", "6Ã·2", "8Ã·4", "10Ã·5", "12Ã·3", "14Ã·2",
                "11-1", "12+3", "19-2", "16+3", "14+4", "18-3", "17-5", "13+3", "15-4", "12+7"
            ],
            "medium": [
                "12Ã—3", "15Ã·3", "7Ã—8", "36Ã·4", "11Ã—2", "20Ã·5", "9Ã—6", "45Ã·9", "13+15", "25-12",
                "6Ã—7", "24Ã·3", "8Ã—9", "50Ã·2", "14Ã—2", "30Ã·6", "5Ã—12", "40Ã·8", "18+22", "35-18",
                "4Ã—11", "27Ã·3", "7Ã—5", "64Ã·8", "15Ã—3", "33Ã·11", "9Ã—9", "81Ã·9", "16+19", "42-24",
                "3Ã—15", "48Ã·6", "6Ã—8", "32Ã·4", "12Ã—4", "55Ã·5", "8Ã—5", "36Ã·6", "23+17", "50-25",
                "5Ã—9", "28Ã·7", "7Ã—7", "49Ã·7", "11Ã—5", "60Ã·10", "4Ã—12", "21Ã·3", "19+21", "60-35",
                "25Ã—2", "48Ã·4", "13Ã—3", "75Ã·3", "16Ã—2", "60Ã·5", "12Ã—5", "90Ã·9", "22+38", "70-28",
                "7Ã—9", "56Ã·8", "6Ã—6", "54Ã·9", "18Ã—2", "39Ã·3", "8Ã—12", "72Ã·6", "45+25", "88-44",
                "14Ã—3", "42Ã·2", "15Ã—4", "65Ã·5", "11Ã—6", "77Ã·7", "9Ã—8", "63Ã·7", "26+34", "95-37",
                "24Ã—2", "99Ã·3", "16Ã—3", "84Ã·4", "13Ã—4", "52Ã·2", "18Ã—3", "96Ã·3", "25+45", "100-33",
                "7Ã—12", "100Ã·5", "90-45", "33+27", "15Ã—5", "120Ã·6", "14Ã—5", "66Ã·2", "29+31", "80-16",
                "4Ã—15", "18Ã·2", "55-22", "44+26", "21Ã—2", "69Ã·3", "8Ã—6", "9Ã—5", "10Ã—8", "72Ã·8",
                "23Ã—3", "88Ã·8", "19Ã—2", "56Ã·2", "30Ã—3", "150Ã·3", "17Ã—3", "45Ã·3", "65-20", "40+35"
            ],
            "hard": [
                "12+5Ã—3", "24Ã·(2+2)", "15-3Ã—4", "20Ã·(5-1)", "8Ã—(3+2)", "50-5Ã—5", "36Ã·6+4", "7+7Ã—2", "(12-4)Ã—3", "100Ã·10-5",
                "5Ã—(6-2)", "18Ã·3+9", "45-9Ã·3", "8+20Ã·4", "6Ã—6-10", "(15+5)Ã·4", "30-10Ã—2", "72Ã·(3+5)", "9+9Ã·3", "4Ã—(8-3)",
                "3+4Ã—6", "56Ã·7-2", "25-15Ã·3", "12+12Ã·2", "8Ã—8-4", "(20-5)Ã·3", "40+10Ã—2", "60Ã·(2Ã—3)", "14-2Ã—5", "5+5Ã—5",
                "6Ã—(4+2)", "30Ã·5+6", "22-11Ã—2", "16Ã·4Ã—3", "(9+9)Ã·9", "100-25Ã—3", "48Ã·(2+4)", "3Ã—3+3Ã—3", "15Ã·5+15", "7Ã—(10-3)",
                "2+2Ã—2", "50Ã·(5+5)", "10-3Ã—3", "24Ã·4-2", "9Ã—(2+1)", "80-8Ã—9", "35Ã·5+7", "6+6Ã—6", "(100-50)Ã·2", "12Ã—2-4",
                "15+(12-6)Ã—2", "20-(8+2)Ã·2", "4Ã—5+6Ã—3", "30Ã·(2Ã—3)+5", "(18+12)Ã·6Ã—2", "50-4Ã—(3+2)", "8Ã—(15-8)Ã·2", "100-10Ã—5+2",
                "7+3Ã—(10-4)", "120Ã·(15-5)", "6Ã—8-24Ã·4", "(32-8)Ã·(2+2)", "5Ã—5Ã—2-10", "40Ã·4+40Ã·8", "16+4Ã—(5-3)", "90-9Ã—9+1",
                "25Ã—4-100Ã·2", "15Ã—(10-8)+6", "72Ã·9Ã—8", "14+6Ã—5-10", "300Ã·(10+5)", "12Ã—12Ã·6", "50+(20-5)Ã—2", "(40-10)Ã·5Ã—3",
                "100-(25+25)Ã·2", "8Ã—9-7Ã—8", "60Ã·(4Ã—3)+15", "45Ã·5+9Ã—2", "3+7Ã—(12-8)", "200Ã·10-5Ã—3", "(16+14)Ã·3Ã—5", "81Ã·9+81Ã·9",
                "5Ã—(12+8)Ã·10", "120-20Ã—4+10", "6Ã—(3+3)-30", "10Ã—10-10Ã·10", "48Ã·8Ã—(9-3)", "7+7+7Ã—7", "(100-1)Ã·9", "25Ã—2Ã·(5+5)"
            ]
        },
        spelling: {
            "easy": [
                "apple", "book", "cat", "dog", "egg", "fish", "girl", "hat", "ice", "jump",
                "kite", "lion", "milk", "nose", "orange", "pen", "queen", "red", "sun", "tree",
                "up", "van", "water", "box", "yes", "zoo", "ant", "ball", "car", "desk",
                "ear", "foot", "goat", "hand", "ink", "jam", "king", "leg", "map", "net",
                "owl", "pig", "run", "sit", "top", "use", "vest", "wall", "xray", "yard",
                "blue", "baby", "bird", "boat", "cake", "door", "duck", "farm", "frog", "gold",
                "hair", "home", "lamp", "love", "moon", "park", "rain", "rose", "ship", "shoe",
                "snow", "star", "swim", "taxi", "time", "toy", "wind", "wolf", "year", "zero",
                "bed", "bus", "cup", "day", "eat", "face", "game", "hill", "job", "key",
                "lake", "man", "name", "old", "pear", "room", "sea", "tea", "unit", "view",
                "way", "arm", "bat", "cow", "doll", "eye", "fun", "gas", "hen", "joy",
                "kid", "lip", "mom", "nut", "oil", "pet", "rat", "sky", "ten", "war",
                "big", "can", "dad", "end", "fox", "get", "hot", "ill", "jug", "kit"
            ],
            "medium": [
                "teacher", "school", "pencil", "computer", "garden", "flower", "winter", "summer", "friend", "family",
                "doctor", "nurse", "police", "driver", "window", "yellow", "purple", "orange", "banana", "monkey",
                "rabbit", "tiger", "horse", "sheep", "chicken", "kitchen", "dinner", "breakfast", "lunch", "market",
                "street", "bridge", "river", "ocean", "forest", "planet", "rocket", "robot", "music", "dance",
                "party", "happy", "smile", "dream", "sleep", "watch", "clock", "phone", "photo", "paper",
                "animal", "basket", "bottle", "camera", "circle", "cloudy", "coffee", "cousin", "danger", "energy",
                "famous", "farmer", "forest", "fridge", "future", "guitar", "health", "island", "jacket", "jungle",
                "ladder", "laptop", "lesson", "library", "market", "minute", "mirror", "mother", "museum", "nature",
                "airport", "bedroom", "bicycle", "biology", "capital", "carpet", "cartoon", "ceiling", "channel", "comfort",
                "concert", "contest", "country", "curtain", "dentist", "diamond", "dolphin", "fashion", "festival", "gallery",
                "giraffe", "holiday", "husband", "insects", "journey", "kingdom", "luggage", "machine", "manager", "message",
                "morning", "mystery", "network", "notebook", "officer", "opinion", "package", "painting", "partner", "pattern",
                "penguin", "picture", "plastic", "problem", "project", "pyramid", "quality", "rainbow", "receipt", "reptile"
            ],
            "hard": [
                "beautiful", "important", "different", "understand", "knowledge", "experience", "challenge", "adventure", "community", "education",
                "government", "history", "information", "language", "management", "necessary", "organization", "position", "question", "remember",
                "science", "technology", "university", "vacation", "wonderful", "yesterday", "biology", "chemistry", "geography", "literature",
                "mathematics", "philosophy", "psychology", "sociology", "economy", "industry", "medicine", "politics", "religion", "culture",
                "environment", "pollution", "recycling", "sustainability", "atmosphere", "temperature", "experiment", "hypothesis", "conclusion", "discovery",
                "accomplish", "background", "calculator", "celebration", "championship", "communication", "concentration", "consequence", "construction", "conversation",
                "development", "dictionary", "earthquake", "electricity", "entertainment", "explanation", "friendship", "generation", "grandfather", "grandmother",
                "helicopter", "imagination", "impossible", "ingredient", "instrument", "intelligence", "invitation", "laboratory", "leadership", "medication",
                "accommodation", "achievement", "acknowledgement", "administration", "advertisement", "anniversary", "appreciation", "architecture", "arrangement", "association",
                "characteristic", "circumstance", "collaboration", "comprehensive", "congratulation", "consideration", "constitution", "contribution", "correspondence", "demonstration",
                "determination", "disappointment", "discrimination", "distribution", "embarrassment", "encouragement", "establishment", "extraordinary", "identification", "implementation",
                "independence", "infrastructure", "interpretation", "investigation", "justification", "manufacturing", "misunderstanding", "negotiation", "observation", "opportunity",
                "participation", "perspective", "photography", "presentation", "qualification", "recommendation", "relationship", "representative", "responsibility", "satisfaction",
                "scholarship", "sophisticated", "speculation", "supermarket", "telecommunication", "transformation", "transportation", "underestimate", "unfortunately", "veterinarian"
            ]
        }
    },
    
    usedIndexes: {
        drawGuess: [], riddleSoup: [], brainTeaser: [],
        math: { easy: [], medium: [], hard: [] },
        spelling: { easy: [], medium: [], hard: [] }
    },
    
    load: function() {
        const raw = localStorage.getItem(DataManager.KEY_QUESTIONS);
        if (raw) {
            try {
                const data = JSON.parse(raw);
                return this.mergeWithDefaults(data);
            } catch(e) { 
                console.error("é¢˜ç›®æ•°æ®æŸå", e);
                Message.show('é¢˜ç›®æ•°æ®æŸåï¼Œå·²æ¢å¤é»˜è®¤', 'error');
            }
        }
        return this.defaults;
    },
    
    mergeWithDefaults: function(userData) {
        const result = JSON.parse(JSON.stringify(this.defaults));
        for (const category in userData) {
            if (Array.isArray(userData[category])) {
                if (!result[category]) result[category] = [];
                // å»é‡åˆå¹¶
                const existing = new Set(result[category].map(item => {
                    if (typeof item === 'object' && item.word) {
                        return JSON.stringify({ word: item.word, type: item.type });
                    } else if (typeof item === 'object' && item.q) {
                        // V14: æµ·é¾Ÿæ±¤é¢˜ç›®å¯èƒ½æœ‰çº¿ç´¢
                        if (item.clue1 || item.clue2) {
                            return JSON.stringify({ 
                                q: item.q, 
                                a: item.a,
                                clue1: item.clue1 || '',
                                clue2: item.clue2 || ''
                            });
                        }
                        return JSON.stringify({ q: item.q, a: item.a });
                    }
                    return item;
                }));
                
                userData[category].forEach(item => {
                    let itemStr;
                    if (typeof item === 'object' && item.word) {
                        itemStr = JSON.stringify({ word: item.word, type: item.type });
                    } else if (typeof item === 'object' && item.q) {
                        // V14: æµ·é¾Ÿæ±¤é¢˜ç›®å¯èƒ½æœ‰çº¿ç´¢
                        if (item.clue1 || item.clue2) {
                            itemStr = JSON.stringify({ 
                                q: item.q, 
                                a: item.a,
                                clue1: item.clue1 || '',
                                clue2: item.clue2 || ''
                            });
                        } else {
                            itemStr = JSON.stringify({ q: item.q, a: item.a });
                        }
                    } else {
                        itemStr = item;
                    }
                    
                    if (!existing.has(itemStr)) result[category].push(item);
                });
            } else if (typeof userData[category] === 'object') {
                if (!result[category]) result[category] = {};
                for (const level in userData[category]) {
                    if (!result[category][level]) result[category][level] = [];
                    const existing = new Set(result[category][level].map(JSON.stringify));
                    userData[category][level].forEach(item => {
                        if (!existing.has(JSON.stringify(item))) result[category][level].push(item);
                    });
                }
            }
        }
        return result;
    },
    
    save: function(data) {
        localStorage.setItem(DataManager.KEY_QUESTIONS, JSON.stringify(data));
    },
    
    getRandom: function(category, level=null) {
        const data = this.load();
        let questionSet = level ? data[category][level] : data[category];
        
        if (!questionSet || questionSet.length === 0) {
            return level ? this.defaults[category][level][0] : this.defaults[category][0];
        }
        
        const allIndexes = Array.from({length: questionSet.length}, (_, i) => i);
        const used = level ? this.usedIndexes[category][level] : this.usedIndexes[category];
        const availableIndexes = allIndexes.filter(idx => !used.includes(idx));
        
        if (availableIndexes.length === 0) {
            // é‡ç½®
            if (level) this.usedIndexes[category][level] = [];
            else this.usedIndexes[category] = [];
            return this.getRandom(category, level);
        }
        
        const randomIdx = availableIndexes[Math.floor(Math.random() * availableIndexes.length)];
        const question = questionSet[randomIdx];
        
        if (level) this.usedIndexes[category][level].push(randomIdx);
        else this.usedIndexes[category].push(randomIdx);
        
        return typeof question === 'object' ? { ...question, _index: randomIdx } : question;
    },
    
    // V14 æ–°å¢ï¼šè·å–æµ·é¾Ÿæ±¤é¢˜ç›®ï¼ˆæ”¯æŒçº¿ç´¢ï¼‰
    getRiddleSoupQuestion: function() {
        const item = this.getRandom('riddleSoup');
        // ç¡®ä¿æœ‰çº¿ç´¢å­—æ®µ
        if (typeof item === 'object' && item.q) {
            return {
                q: item.q || '',
                a: item.a || '',
                clue1: item.clue1 || '',
                clue2: item.clue2 || ''
            };
        }
        return { q: "åŠ è½½ä¸­...", a: "åŠ è½½ä¸­...", clue1: "", clue2: "" };
    },
    
    // V14 æ–°å¢ï¼šè·å–ä½ ç”»æˆ‘çŒœçš„è¯è¯­
    getDrawGuessWord: function() {
        const item = this.getRandom('drawGuess');
        if (typeof item === 'object' && item.word) {
            return item;
        } else if (typeof item === 'string') {
            return { word: item, type: "å…¶ä»–" };
        }
        return { word: "è‹¹æœ", type: "æ°´æœ" };
    },
    
    // V14 æ–°å¢ï¼šå•è¯æŒ–ç©ºç”Ÿæˆ
    generateWordBlank: function(word, difficulty = 'medium') {
        const wordArray = word.split('');
        let blankCount;
        
        switch(difficulty) {
            case 'easy':
                blankCount = Math.max(1, Math.floor(wordArray.length * 0.3));
                break;
            case 'medium':
                blankCount = Math.max(2, Math.floor(wordArray.length * 0.5));
                break;
            case 'hard':
                blankCount = Math.max(3, Math.floor(wordArray.length * 0.7));
                break;
            default:
                blankCount = Math.max(2, Math.floor(wordArray.length * 0.4));
        }
        
        // åˆ›å»ºæŒ–ç©ºä½ç½®
        const positions = new Set();
        while (positions.size < blankCount && positions.size < wordArray.length) {
            const pos = Math.floor(Math.random() * wordArray.length);
            positions.add(pos);
        }
        
        // ç”Ÿæˆæ˜¾ç¤ºå­—ç¬¦ä¸²å’Œç­”æ¡ˆæ˜ å°„
        let display = '';
        const answerMap = [];
        
        for (let i = 0; i < wordArray.length; i++) {
            if (positions.has(i)) {
                display += '_';
                answerMap.push({
                    position: i,
                    letter: wordArray[i].toLowerCase(),
                    filled: false
                });
            } else {
                display += wordArray[i];
            }
        }
        
        return {
            original: word,
            display: display,
            blanks: Array.from(positions),
            answerMap: answerMap,
            length: wordArray.length
        };
    },
    
    addQuestion: function(category, question, level=null) {
        const data = this.load();
        if (level) {
            if (!data[category]) data[category] = {};
            if (!data[category][level]) data[category][level] = [];
            data[category][level].push(question);
        } else {
            if (!data[category]) data[category] = [];
            data[category].push(question);
        }
        this.save(data);
        Message.show(`å·²æ·»åŠ æ–°é¢˜ç›®åˆ° ${category}${level ? ' - ' + level : ''}`, 'success');
    },
    
    showAddDialog: function(gameName, level=null) {
        const old = document.querySelector('.add-question-dialog');
        if (old) old.remove();

        const dialog = document.createElement('div');
        dialog.className = 'add-question-dialog';
        dialog.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.2s;`;
        const form = document.createElement('div');
        form.style.cssText = `background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);`;
        
        let formHTML = `<h3 style="margin-top:0;">æ·»åŠ ${gameName}é¢˜ç›®</h3>`;
        
        if (gameName === 'ä½ ç”»æˆ‘çŒœ') {
            formHTML += `<div style="margin-bottom:15px;"><label>è¯è¯­ï¼š</label><input type="text" id="newQuestionWord" style="width:100%; margin-top:5px;"></div>`;
            formHTML += `<div style="margin-bottom:15px;"><label>ç±»å‹ï¼š</label><input type="text" id="newQuestionType" style="width:100%; margin-top:5px;" placeholder="å¦‚ï¼šæ°´æœã€åŠ¨ç‰©ã€ç‰©å“ç­‰"></div>`;
        } else if (gameName === 'æµ·é¾Ÿæ±¤') {
            formHTML += `<div style="margin-bottom:15px;"><label>é¢˜ç›®ï¼š</label><textarea id="newQuestionText" rows="3" style="width:100%; margin-top:5px;"></textarea></div>`;
            formHTML += `<div style="margin-bottom:15px;"><label>ç­”æ¡ˆï¼š</label><input type="text" id="newQuestionAnswer" style="width:100%; margin-top:5px;"></div>`;
            formHTML += `<div style="margin-bottom:15px;"><label>çº¿ç´¢1ï¼ˆæé—®2ä¸ªåè§£é”ï¼‰ï¼š</label><input type="text" id="newQuestionClue1" style="width:100%; margin-top:5px;"></div>`;
            formHTML += `<div style="margin-bottom:15px;"><label>çº¿ç´¢2ï¼ˆæé—®5ä¸ªåè§£é”ï¼‰ï¼š</label><input type="text" id="newQuestionClue2" style="width:100%; margin-top:5px;"></div>`;
        } else if (gameName === 'è„‘ç­‹æ€¥è½¬å¼¯') {
            formHTML += `<div style="margin-bottom:15px;"><label>é¢˜ç›®ï¼š</label><textarea id="newQuestionText" rows="3" style="width:100%; margin-top:5px;"></textarea></div>`;
            formHTML += `<div style="margin-bottom:15px;"><label>ç­”æ¡ˆï¼š</label><input type="text" id="newQuestionAnswer" style="width:100%; margin-top:5px;"></div>`;
        } else {
            formHTML += `<div style="margin-bottom:15px;"><label>é¢˜ç›®ï¼š</label><textarea id="newQuestionText" rows="3" style="width:100%; margin-top:5px;"></textarea></div>`;
        }
        
        formHTML += `<div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-primary" onclick="QuestionManager.saveNewQuestion('${gameName}', ${level ? `'${level}'` : 'null'})">ä¿å­˜</button>
            <button class="btn btn-outline" onclick="this.closest('.add-question-dialog').remove()">å–æ¶ˆ</button>
        </div>`;
        
        form.innerHTML = formHTML;
        dialog.appendChild(form);
        document.body.appendChild(dialog);
    },
    
    saveNewQuestion: function(gameName, level) {
        const categoryMap = { 'ä½ ç”»æˆ‘çŒœ': 'drawGuess', 'æµ·é¾Ÿæ±¤': 'riddleSoup', 'è„‘ç­‹æ€¥è½¬å¼¯': 'brainTeaser', 'æ•°å­¦é€Ÿç®—': 'math', 'å•è¯æ‹¼å†™': 'spelling' };
        const category = categoryMap[gameName];
        let question;
        
        if (category === 'drawGuess') {
            const wordInput = document.getElementById('newQuestionWord');
            const typeInput = document.getElementById('newQuestionType');
            const word = sanitizeInput(wordInput.value);
            const type = sanitizeInput(typeInput.value) || 'å…¶ä»–';
            
            if (!word) {
                Message.show('è¯·è¾“å…¥è¯è¯­', 'warning');
                return;
            }
            question = { word: word, type: type };
        } else if (category === 'riddleSoup') {
            const textInput = document.getElementById('newQuestionText');
            const ansInput = document.getElementById('newQuestionAnswer');
            const clue1Input = document.getElementById('newQuestionClue1');
            const clue2Input = document.getElementById('newQuestionClue2');
            const text = sanitizeInput(textInput.value);
            const answer = sanitizeInput(ansInput.value);
            const clue1 = sanitizeInput(clue1Input.value);
            const clue2 = sanitizeInput(clue2Input.value);
            
            if (!text) {
                Message.show('è¯·è¾“å…¥é¢˜ç›®', 'warning');
                return;
            }
            if (!answer) {
                Message.show('è¯·è¾“å…¥ç­”æ¡ˆ', 'warning');
                return;
            }
            question = { q: text, a: answer, clue1: clue1, clue2: clue2 };
        } else if (category === 'brainTeaser') {
            const textInput = document.getElementById('newQuestionText');
            const ansInput = document.getElementById('newQuestionAnswer');
            const text = sanitizeInput(textInput.value);
            const answer = sanitizeInput(ansInput.value);
            
            if (!text) {
                Message.show('è¯·è¾“å…¥é¢˜ç›®', 'warning');
                return;
            }
            if (!answer) {
                Message.show('è¯·è¾“å…¥ç­”æ¡ˆ', 'warning');
                return;
            }
            question = { q: text, a: answer };
        } else if (category === 'math' || category === 'spelling') {
            const textInput = document.getElementById('newQuestionText');
            const text = sanitizeInput(textInput.value);
            
            if (!text) {
                Message.show('è¯·è¾“å…¥é¢˜ç›®', 'warning');
                return;
            }
            question = text;
        }
        
        this.addQuestion(category, question, level);
        document.querySelector('.add-question-dialog').remove();
    },
    
    // V14 æ–°å¢ï¼šé¢˜åº“æŸ¥çœ‹åŠŸèƒ½
    showQuestionBank: function() {
        const data = this.load();
        let html = '';
        
        // éå†æ¯ä¸ªæ¸¸æˆç±»å‹
        for (const [category, questions] of Object.entries(data)) {
            let categoryName = '';
            let questionCount = 0;
            
            // æ ¹æ®ç±»åˆ«è®¾ç½®åç§°
            switch(category) {
                case 'drawGuess': categoryName = 'ğŸ¨ ä½ ç”»æˆ‘çŒœ'; break;
                case 'riddleSoup': categoryName = 'ğŸ¢ æµ·é¾Ÿæ±¤'; break;
                case 'brainTeaser': categoryName = 'ğŸŒ€ è„‘ç­‹æ€¥è½¬å¼¯'; break;
                case 'math': categoryName = 'ğŸ§® æ•°å­¦é€Ÿç®—'; break;
                case 'spelling': categoryName = 'ğŸ“ å•è¯æ‹¼å†™'; break;
                default: categoryName = category;
            }
            
            html += `<div class="question-category">`;
            html += `<h3>${categoryName}`;
            
            if (Array.isArray(questions)) {
                questionCount = questions.length;
                html += `<span class="question-count">${questionCount}é¢˜</span>`;
                html += `</h3>`;
                
                // æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
                questions.forEach((q, index) => {
                    html += `<div class="question-item">`;
                    if (typeof q === 'object') {
                        if (q.word && q.type) {
                            html += `<div class="question-text">${index+1}. ${q.word} <small style="color:#666;">(${q.type})</small></div>`;
                        } else if (q.q && q.a) {
                            html += `<div class="question-text">${index+1}. ${q.q}</div>`;
                            if (q.clue1 || q.clue2) {
                                html += `<div class="answer-text" style="margin-top:5px;">
                                    çº¿ç´¢1: ${q.clue1 || 'æ— '} | çº¿ç´¢2: ${q.clue2 || 'æ— '}
                                </div>`;
                            }
                            html += `<div class="answer-text">ç­”æ¡ˆ: ${q.a}</div>`;
                        }
                    } else {
                        html += `<div class="question-text">${index+1}. ${q}</div>`;
                    }
                    html += `</div>`;
                });
            } else if (typeof questions === 'object') {
                // åˆ†çº§é¢˜åº“
                let total = 0;
                for (const level in questions) {
                    total += questions[level].length;
                }
                html += `<span class="question-count">${total}é¢˜</span>`;
                html += `</h3>`;
                
                // æ˜¾ç¤ºæ¯ä¸ªéš¾åº¦çº§åˆ«çš„é¢˜ç›®
                for (const [level, levelQuestions] of Object.entries(questions)) {
                    if (levelQuestions.length > 0) {
                        let levelName = '';
                        switch(level) {
                            case 'easy': levelName = 'ç®€å•'; break;
                            case 'medium': levelName = 'ä¸­ç­‰'; break;
                            case 'hard': levelName = 'å›°éš¾'; break;
                            default: levelName = level;
                        }
                        
                        html += `<h4 style="margin-top:15px; color:#666;">${levelName} (${levelQuestions.length}é¢˜)</h4>`;
                        levelQuestions.forEach((q, index) => {
                            html += `<div class="question-item">`;
                            html += `<div class="question-text">${index+1}. ${q}</div>`;
                            html += `</div>`;
                        });
                    }
                }
            }
            
            html += `</div>`;
        }
        
        // å¦‚æœé¢˜åº“ä¸ºç©º
        if (Object.keys(data).length === 0) {
            html = `<div style="text-align:center; padding:40px;">
                <h3 style="color:#666;">é¢˜åº“ä¸ºç©º</h3>
                <p style="color:#888;">è¯·å…ˆå¯¼å…¥æˆ–æ·»åŠ é¢˜ç›®</p>
                <button class="btn btn-primary" onclick="QuestionManager.showBulkImportMenu()">ğŸ“¥ æ‰¹é‡å¯¼å…¥é¢˜ç›®</button>
            </div>`;
        }
        
        document.getElementById('questionBankContent').innerHTML = html;
        document.getElementById('questionBankModal').style.display = 'flex';
        document.getElementById('questionBankModal').classList.add('show');
    },
    
    // V14 å¢å¼ºï¼šæ‰¹é‡å¯¼å…¥åŠŸèƒ½
    showBulkImportMenu: function() {
        const menu = document.createElement('div');
        menu.className = 'bulk-import-dialog';
        menu.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.2s;`;
        
        const form = document.createElement('div');
        form.style.cssText = `background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 700px; max-height: 80vh; box-shadow: 0 20px 40px rgba(0,0,0,0.3); overflow-y: auto;`;
        
        form.innerHTML = `
            <h3 style="margin-top:0;">ğŸ“¥ æ‰¹é‡å¯¼å…¥é¢˜ç›®</h3>
            <p style="color:#666; margin-bottom:20px;">é€‰æ‹©è¦å¯¼å…¥é¢˜ç›®çš„æ¸¸æˆç±»å‹</p>
            
            <div class="import-type-selector">
                <div class="import-type-btn" onclick="QuestionManager.showBulkImportDialog('drawGuess', this)">
                    <div style="font-size:1.2rem; margin-bottom:5px;">ğŸ¨</div>
                    <div style="font-weight:bold;">ä½ ç”»æˆ‘çŒœ</div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">è¯è¯­ç±»é¢˜ç›®</div>
                </div>
                <div class="import-type-btn" onclick="QuestionManager.showBulkImportDialog('riddleSoup', this)">
                    <div style="font-size:1.2rem; margin-bottom:5px;">ğŸ¢</div>
                    <div style="font-weight:bold;">æµ·é¾Ÿæ±¤</div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">æ¨ç†æ•…äº‹ç±»</div>
                </div>
                <div class="import-type-btn" onclick="QuestionManager.showBulkImportDialog('brainTeaser', this)">
                    <div style="font-size:1.2rem; margin-bottom:5px;">ğŸŒ€</div>
                    <div style="font-weight:bold;">è„‘ç­‹æ€¥è½¬å¼¯</div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">æ€ç»´å‘æ•£ç±»</div>
                </div>
                <div class="import-type-btn" onclick="QuestionManager.showBulkImportDialog('math', this)">
                    <div style="font-size:1.2rem; margin-bottom:5px;">ğŸ§®</div>
                    <div style="font-weight:bold;">æ•°å­¦é€Ÿç®—</div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">è®¡ç®—ç±»é¢˜ç›®</div>
                </div>
                <div class="import-type-btn" onclick="QuestionManager.showBulkImportDialog('spelling', this)">
                    <div style="font-size:1.2rem; margin-bottom:5px;">ğŸ“</div>
                    <div style="font-weight:bold;">å•è¯æ‹¼å†™</div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">è‹±è¯­å•è¯ç±»</div>
                </div>
            </div>
            
            <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                <h4>ğŸ“‹ æ ¼å¼è¯´æ˜</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; font-size: 0.9rem; color: #666;">
                    <p><strong>ğŸŸ¡ ä½ ç”»æˆ‘çŒœï¼š</strong>æ¯è¡Œæ ¼å¼ï¼šè¯è¯­|ç±»å‹ï¼Œä¾‹å¦‚ï¼šè‹¹æœ|æ°´æœã€å¤§è±¡|åŠ¨ç‰©</p>
                    <p><strong>ğŸ”µ æµ·é¾Ÿæ±¤ï¼š</strong>æ¯è¡Œæ ¼å¼ï¼šé—®é¢˜|ç­”æ¡ˆ|çº¿ç´¢1|çº¿ç´¢2ï¼Œä¾‹å¦‚ï¼šä¸€ä¸ªç”·äººèµ°è¿›é…’å§...|è¿™ä¸ªç”·äººæ‰“å—ä¸æ­¢...|æç¤º1|æç¤º2</p>
                    <p><strong>ğŸ”´ è„‘ç­‹æ€¥è½¬å¼¯ï¼š</strong>æ¯è¡Œæ ¼å¼ï¼šé—®é¢˜|ç­”æ¡ˆï¼Œä¾‹å¦‚ï¼šä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ|æ°´</p>
                    <p><strong>ğŸŸ£ æ•°å­¦é€Ÿç®—ï¼š</strong>æ¯è¡Œä¸€ä¸ªç®—å¼ï¼Œä¾‹å¦‚ï¼š5+3ã€12Ã—4ã€15Ã·3</p>
                    <p><strong>ğŸŸ¢ å•è¯æ‹¼å†™ï¼š</strong>æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œä¾‹å¦‚ï¼šappleã€bananaã€computer</p>
                    <p>ç³»ç»Ÿä¼šè‡ªåŠ¨å»é‡ï¼Œä¸ä¼šå¯¼å…¥é‡å¤çš„é¢˜ç›®ã€‚</p>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-outline" onclick="this.closest('.bulk-import-dialog').remove()">å…³é—­</button>
            </div>
        `;
        
        menu.appendChild(form);
        document.body.appendChild(menu);
        
        // æ·»åŠ é€‰ä¸­æ ·å¼
        const buttons = form.querySelectorAll('.import-type-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', function() {
                buttons.forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
    },
    
    showBulkImportDialog: function(gameType, selectedBtn) {
        const gameTypeMap = {
            'drawGuess': { name: 'ä½ ç”»æˆ‘çŒœ', icon: 'ğŸ¨', color: '#ffeaa7' },
            'riddleSoup': { name: 'æµ·é¾Ÿæ±¤', icon: 'ğŸ¢', color: '#81ecec' },
            'brainTeaser': { name: 'è„‘ç­‹æ€¥è½¬å¼¯', icon: 'ğŸŒ€', color: '#fab1a0' },
            'math': { name: 'æ•°å­¦é€Ÿç®—', icon: 'ğŸ§®', color: '#a29bfe' },
            'spelling': { name: 'å•è¯æ‹¼å†™', icon: 'ğŸ“', color: '#55efc4' }
        };
        
        const gameInfo = gameTypeMap[gameType];
        if (!gameInfo) return;
        
        // ç§»é™¤ä¹‹å‰çš„å¯¹è¯æ¡†
        const oldDialog = document.querySelector('.bulk-import-dialog');
        if (oldDialog) oldDialog.remove();
        
        const dialog = document.createElement('div');
        dialog.className = 'bulk-import-dialog';
        dialog.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.2s;
        `;
        
        const form = document.createElement('div');
        form.style.cssText = `
            background: white; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 600px; max-height: 80vh;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow-y: auto;
        `;
        
        form.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div style="font-size: 2rem;">${gameInfo.icon}</div>
                <div>
                    <h3 style="margin:0;">æ‰¹é‡å¯¼å…¥${gameInfo.name}é¢˜ç›®</h3>
                    <div style="color:#666; font-size:0.9rem;">è¯·é€‰æ‹©å¯¼å…¥æ ¼å¼å¹¶è¾“å…¥é¢˜ç›®æ•°æ®</div>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <button class="btn btn-primary" onclick="QuestionManager.selectQuestionFile('${gameType}')" style="width:100%; margin-bottom:10px;">
                    ğŸ“ é€‰æ‹©é¢˜åº“æ–‡ä»¶
                </button>
                <p style="color:#666; font-size:0.9rem; text-align:center;">æˆ–æ‰‹åŠ¨è¾“å…¥ä¸‹æ–¹</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:bold;">
                    å¯¼å…¥æ ¼å¼ï¼š
                </label>
                <!-- V14ä¿®å¤ï¼šä½¿ç”¨CSSå¼ºåˆ¶å•é€‰æ¡†æ°´å¹³æ’åˆ— -->
                <div class="format-radio-group">
                    <label style="display:flex; align-items:center; gap:5px; white-space:nowrap;">
                        <input type="radio" name="importFormat" value="txt" checked> æ–‡æœ¬
                    </label>
                    <label style="display:flex; align-items:center; gap:5px; white-space:nowrap;">
                        <input type="radio" name="importFormat" value="csv"> CSV
                    </label>
                    <label style="display:flex; align-items:center; gap:5px; white-space:nowrap;">
                        <input type="radio" name="importFormat" value="json"> JSON
                    </label>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:bold;">
                    é¢˜ç›®æ•°æ®ï¼š
                </label>
                <textarea id="bulkImportText" rows="10" style="width:100%; padding:10px; border:2px solid #eee; border-radius:10px; font-family:monospace;" 
                    placeholder="è¯·è¾“å…¥é¢˜ç›®æ•°æ®..." onfocus="this.select()"></textarea>
            </div>
            
            <div style="margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:10px;">
                <h4 style="margin-top:0;">ğŸ“‹ æ ¼å¼è¯´æ˜ï¼ˆå¯å¤åˆ¶ï¼‰ï¼š</h4>
                <div style="font-size:0.9rem; color:#666; user-select: text; cursor: text;" onclick="this.querySelector('pre').select()">
                    ${this.getFormatInstructions(gameType)}
                    <pre style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; user-select: text; cursor: text;">
${this.getFormatExample(gameType)}</pre>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" onclick="QuestionManager.processBulkImport('${gameType}')">
                    å¯¼å…¥
                </button>
                <button class="btn btn-outline" onclick="this.closest('.bulk-import-dialog').remove()">
                    å–æ¶ˆ
                </button>
                <button class="btn btn-outline" onclick="QuestionManager.downloadTemplate('${gameType}')" style="margin-left:auto;">
                    ä¸‹è½½æ¨¡æ¿
                </button>
            </div>
        `;
        
        dialog.appendChild(form);
        document.body.appendChild(dialog);
        
        // è‡ªåŠ¨é€‰æ‹©æ–‡æœ¬æ¡†å†…å®¹ä»¥ä¾¿å¤åˆ¶
        setTimeout(() => {
            const textarea = document.getElementById('bulkImportText');
            if (textarea) textarea.focus();
        }, 100);
    },
    
    getFormatInstructions: function(gameType) {
        const instructions = {
            drawGuess: '<span class="import-tag import-tag-draw">ä½ ç”»æˆ‘çŒœ</span>æ¯è¡Œæ ¼å¼ï¼šè¯è¯­|ç±»å‹<br>ç¤ºä¾‹ï¼šè‹¹æœ|æ°´æœ<br>å¤§è±¡|åŠ¨ç‰©<br>å†°ç®±|å®¶ç”µ',
            riddleSoup: '<span class="import-tag import-tag-soup">æµ·é¾Ÿæ±¤</span>æ¯è¡Œæ ¼å¼ï¼šé—®é¢˜|ç­”æ¡ˆ|çº¿ç´¢1|çº¿ç´¢2<br>ç¤ºä¾‹ï¼šä¸€ä¸ªç”·äººèµ°è¿›é…’å§...|è¿™ä¸ªç”·äººæ‰“å—ä¸æ­¢...|æç¤º1|æç¤º2',
            brainTeaser: '<span class="import-tag import-tag-teaser">è„‘ç­‹æ€¥è½¬å¼¯</span>æ¯è¡Œæ ¼å¼ï¼šé—®é¢˜|ç­”æ¡ˆ<br>ç¤ºä¾‹ï¼šä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ|æ°´',
            math: '<span class="import-tag import-tag-math">æ•°å­¦é€Ÿç®—</span>æ¯è¡Œä¸€ä¸ªç®—å¼<br>ç¤ºä¾‹ï¼š5+3<br>12Ã—4<br>15Ã·3',
            spelling: '<span class="import-tag import-tag-spelling">å•è¯æ‹¼å†™</span>æ¯è¡Œä¸€ä¸ªå•è¯<br>ç¤ºä¾‹ï¼šapple<br>banana<br>computer'
        };
        return instructions[gameType] || 'è¯·æŒ‰ç…§æŒ‡å®šæ ¼å¼è¾“å…¥æ•°æ®';
    },
    
    getFormatExample: function(gameType) {
        const examples = {
            drawGuess: 'è‹¹æœ|æ°´æœ\né¦™è•‰|æ°´æœ\nå¤§è±¡|åŠ¨ç‰©\nå†°ç®±|å®¶ç”µ\né›¨ä¼|æ—¥ç”¨å“',
            riddleSoup: 'ä¸€ä¸ªç”·äººèµ°è¿›é…’å§...|è¿™ä¸ªç”·äººæ‰“å—ä¸æ­¢...|ç”·äººå½“æ—¶åœ¨æ‰“å—|æªå£°å¯ä»¥æ­¢ä½æ‰“å—',
            brainTeaser: 'ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ|æ°´\nä»€ä¹ˆé—¨æ°¸è¿œå…³ä¸ä¸Šï¼Ÿ|çƒé—¨',
            math: '5+3\n12Ã—4\n15Ã·3',
            spelling: 'apple\nbanana\ncomputer'
        };
        return examples[gameType] || '';
    },
    
    processBulkImport: function(gameType) {
        const textarea = document.getElementById('bulkImportText');
        const formatRadios = document.querySelectorAll('input[name="importFormat"]');
        let format = 'txt';
        
        formatRadios.forEach(radio => {
            if (radio.checked) format = radio.value;
        });
        
        if (!textarea || !textarea.value.trim()) {
            Message.show('è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®', 'warning');
            return;
        }
        
        const result = DataManager.bulkImportQuestions(gameType, textarea.value, format);
        
        if (result.success) {
            Message.show(`æˆåŠŸå¯¼å…¥ ${result.count} æ¡é¢˜ç›®`, 'success');
            document.querySelector('.bulk-import-dialog').remove();
            
            // åˆ·æ–°å½“å‰æ¸¸æˆ
            const activeGame = document.querySelector('.game-screen.active');
            if (activeGame) {
                const gameId = activeGame.id.replace('game-', '');
                if (gameId === 'drawGuess') drawGame.init();
                else if (gameId === 'riddleSoup') riddleSoup.init();
                else if (gameId === 'brainTeaser') brainTeaser.init();
                else if (gameId === 'math') mathRace.init();
                else if (gameId === 'spelling') spellingRace.init();
            }
        } else {
            Message.show(`å¯¼å…¥å¤±è´¥: ${result.error}`, 'error');
        }
    },
    
    selectQuestionFile: function(gameType) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,.txt,.csv';
        input.style.display = 'none';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const content = event.target.result;
                const textarea = document.getElementById('bulkImportText');
                if (textarea) {
                    textarea.value = content;
                    textarea.focus();
                }
                
                // è‡ªåŠ¨é€‰æ‹©JSONæ ¼å¼
                if (file.name.endsWith('.json')) {
                    const jsonRadio = document.querySelector('input[value="json"]');
                    if (jsonRadio) jsonRadio.checked = true;
                } else if (file.name.endsWith('.csv')) {
                    const csvRadio = document.querySelector('input[value="csv"]');
                    if (csvRadio) csvRadio.checked = true;
                }
                
                Message.show(`å·²åŠ è½½æ–‡ä»¶: ${file.name}`, 'success');
            };
            reader.readAsText(file);
        };
        
        document.body.appendChild(input);
        input.click();
        setTimeout(() => document.body.removeChild(input), 100);
    },
    
    // V14ä¼˜åŒ–ï¼šå¢å¼ºå‰ªè´´æ¿å…¼å®¹æ€§
    copyFormatInstructions: function(gameType) {
        const exampleText = this.getFormatExample(gameType);
        if (!exampleText) return;
        
        // ä½¿ç”¨Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(exampleText).then(() => {
                Message.show('æ ¼å¼ç¤ºä¾‹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(err => {
                // é™çº§æ–¹æ¡ˆ
                this.copyUsingExecCommand(exampleText);
            });
        } else {
            // é™çº§æ–¹æ¡ˆ
            this.copyUsingExecCommand(exampleText);
        }
    },
    
    copyUsingExecCommand: function(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                Message.show('æ ¼å¼ç¤ºä¾‹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } else {
                Message.show('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'warning');
            }
        } catch (err) {
            Message.show('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'warning');
        }
        
        document.body.removeChild(textArea);
    },
    
    downloadTemplate: function(gameType) {
        const templates = {
            drawGuess: 'è‹¹æœ|æ°´æœ\né¦™è•‰|æ°´æœ\nå¤§è±¡|åŠ¨ç‰©\nå†°ç®±|å®¶ç”µ\né›¨ä¼|æ—¥ç”¨å“',
            riddleSoup: 'ä¸€ä¸ªç”·äººèµ°è¿›é…’å§ï¼Œå‘é…’ä¿è¦äº†ä¸€æ¯æ°´...|è¿™ä¸ªç”·äººæ‰“å—ä¸æ­¢...|ç”·äººå½“æ—¶åœ¨æ‰“å—|æªå£°å¯ä»¥æ­¢ä½æ‰“å—',
            brainTeaser: 'ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ|æ°´',
            math: '5+3\n12Ã—4\n15Ã·3\n7Ã—8\n36Ã·4',
            spelling: 'apple\nbanana\ncomputer\nteacher\nschool'
        };
        
        const template = templates[gameType] || '';
        const blob = new Blob([template], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${gameType}_template.txt`;
        a.click();
        URL.revokeObjectURL(url);
        Message.show('æ¨¡æ¿å·²å¼€å§‹ä¸‹è½½', 'success');
    },
    
    importFromFile: function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.style.display = 'none';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const content = JSON.parse(event.target.result);
                    const result = await this.importCompleteQuestionBank(content);
                    
                    if (result.success) {
                        Message.show(`æˆåŠŸå¯¼å…¥æ•´ä¸ªé¢˜åº“ï¼\nå…±è®¡å¯¼å…¥${result.total}é“é¢˜ç›®`, 'success');
                        
                        // åˆ·æ–°æ‰€æœ‰æ¸¸æˆ
                        if (riddleSoup && riddleSoup.init) riddleSoup.init();
                        if (brainTeaser && brainTeaser.init) brainTeaser.init();
                        if (mathRace && mathRace.init) mathRace.init();
                        if (spellingRace && spellingRace.init) spellingRace.init();
                        if (drawGame && drawGame.init) drawGame.init();
                    } else {
                        Message.show(`å¯¼å…¥å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    Message.show(`æ–‡ä»¶æ ¼å¼é”™è¯¯: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        };
        
        document.body.appendChild(input);
        input.click();
        setTimeout(() => document.body.removeChild(input), 100);
    },
    
    importCompleteQuestionBank: function(data) {
        return new Promise((resolve) => {
            try {
                let total = 0;
                const existingData = this.load();
                
                // åˆå¹¶å„ä¸ªé¢˜åº“
                for (const [category, questions] of Object.entries(data)) {
                    if (Array.isArray(questions)) {
                        if (!existingData[category]) existingData[category] = [];
                        
                        const existingSet = new Set(existingData[category].map(q => {
                            if (typeof q === 'object') {
                                if (q.word && q.type) {
                                    return JSON.stringify({ word: q.word, type: q.type });
                                } else if (q.q && q.a) {
                                    return JSON.stringify({ q: q.q, a: q.a });
                                }
                            }
                            return q;
                        }));
                        
                        questions.forEach(q => {
                            let qStr;
                            if (typeof q === 'object') {
                                if (q.word && q.type) {
                                    qStr = JSON.stringify({ word: q.word, type: q.type });
                                } else if (q.q && q.a) {
                                    qStr = JSON.stringify({ q: q.q, a: q.a });
                                } else {
                                    qStr = JSON.stringify(q);
                                }
                            } else {
                                qStr = q;
                            }
                            
                            if (!existingSet.has(qStr)) {
                                existingData[category].push(q);
                                total++;
                            }
                        });
                    } else if (typeof questions === 'object') {
                        // åˆ†çº§é¢˜åº“
                        if (!existingData[category]) existingData[category] = { easy: [], medium: [], hard: [] };
                        
                        for (const [level, levelQuestions] of Object.entries(questions)) {
                            if (Array.isArray(levelQuestions)) {
                                if (!existingData[category][level]) existingData[category][level] = [];
                                
                                const existingSet = new Set(existingData[category][level]);
                                levelQuestions.forEach(q => {
                                    if (!existingSet.has(q)) {
                                        existingData[category][level].push(q);
                                        total++;
                                    }
                                });
                            }
                        }
                    }
                }
                
                this.save(existingData);
                resolve({ success: true, total });
            } catch (error) {
                resolve({ success: false, error: error.message });
            }
        });
    }
};

/* ==========================================================================
   ç³»ç»ŸæœåŠ¡ (Sound, Stats, Scoring) - V14.0
   ========================================================================== */

const SoundManager = {
    enabled: true,
    ctx: null,
    init: function() {
        const resumeCtx = () => {
            if (this.ctx && this.ctx.state === 'suspended') {
                this.ctx.resume();
            } else if (!this.ctx) {
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('Web Audio API not supported');
                }
            }
        };
        window.addEventListener('click', resumeCtx, {once:true});
        window.addEventListener('touchstart', resumeCtx, {once:true});
    },
    toggle: function() {
        this.enabled = !this.enabled;
        const btn = document.getElementById('soundToggleBtn');
        btn.innerText = this.enabled ? 'ğŸ”Š' : 'ğŸ”‡';
        btn.classList.toggle('btn-outline');
        btn.classList.toggle('btn-danger');
        Message.show(this.enabled ? 'éŸ³æ•ˆå·²å¼€å¯' : 'éŸ³æ•ˆå·²å…³é—­', 'info');
    },
    playTone: function(freq, type='sine', dur=0.1) {
        if (!this.enabled || !this.ctx) return;
        if (this.ctx.state === 'suspended') this.ctx.resume().catch(()=>{});
        try {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + dur);
        } catch (e) {
            console.warn('Audio error:', e);
        }
    },
    click: function() { this.playTone(800, 'sine', 0.1); },
    win: function() { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2), i*100)); },
    error: function() { this.playTone(150, 'sawtooth', 0.3); },
    tick: function() { this.playTone(1000, 'triangle', 0.05); },
    shuffle: function() {
        this.playTone(600, 'sine', 0.1);
        setTimeout(() => this.playTone(700, 'sine', 0.1), 100);
        setTimeout(() => this.playTone(800, 'sine', 0.1), 200);
    },
    reveal: function() {
        [523, 659, 784, 1046, 1318].forEach((f, i) => 
            setTimeout(() => this.playTone(f, 'square', 0.2), i * 100)
        );
    }
};

const GameStats = {
    record: function(game, action, isAutoScore = false) {
        const data = DataManager.load();
        data.stats.push({ 
            game: game, 
            action: action, 
            time: new Date().toLocaleString(),
            isAutoScore: isAutoScore // V14æ–°å¢ï¼šæ ‡è®°æ˜¯å¦ä¸ºè‡ªåŠ¨å¾—åˆ†
        });
        if(data.stats.length > 500) data.stats = data.stats.slice(-500);
        DataManager.save(data);
    },
    exportReport: function() {
        const data = DataManager.load();
        Message.show(`ğŸ“Š è¯¾å ‚æŠ¥è¡¨\nè®°å½•æ¡æ•°: ${data.stats.length}\næœ€åæ“ä½œ: ${data.stats.length > 0 ? data.stats[data.stats.length-1].time : 'æ— '}`, 'info');
    },
    exportFullReport: function() {
        const data = DataManager.load();
        const students = SettlementSystem.loadData();
        const date = new Date();
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "å¿«ä¹è¯¾å ‚ - è¯¦ç»†è¯¾å ‚æŠ¥è¡¨\n";
        csvContent += `ç”Ÿæˆæ—¶é—´,${date.toLocaleString()}\n\n`;
        // å­¦ç”Ÿåˆ†æ•°è¡¨
        csvContent += "å­¦ç”Ÿå§“å,å½“å‰åˆ†æ•°,è¡¨æ‰¬æ¬¡æ•°,å¾…æ”¹è¿›æ¬¡æ•°\n";
        students.forEach(s => {
            csvContent += `${s.name},${s.score.toFixed(1)},${s.positiveCount || 0},${s.negativeCount || 0}\n`;
        });
        csvContent += "\n\nè¯¾å ‚æ´»åŠ¨è®°å½•\n";
        csvContent += "æ—¶é—´,æ¸¸æˆ/æ¨¡å—,æ“ä½œå†…å®¹,æ˜¯å¦ä¸ºè‡ªåŠ¨å¾—åˆ†\n";
        data.stats.slice(-100).forEach(stat => {
            csvContent += `${stat.time || ''},${stat.game || ''},"${stat.action || ''}",${stat.isAutoScore || false}\n`;
        });
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `è¯¾å ‚æŠ¥è¡¨_${date.getFullYear()}${date.getMonth()+1}${date.getDate()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        Message.show('è¯¦ç»†æŠ¥è¡¨å·²å¼€å§‹ä¸‹è½½', 'success');
    }
};

// V14é‡æ„ï¼šç»“ç®—ç³»ç»Ÿ
const SettlementSystem = {
    currentTab: 'ranking',
    top3Students: [],
    lotteryResults: {},
    prizePool: [],
    
    open: function() {
        this.loadData();
        this.renderContent();
        document.getElementById('settlementModal').classList.add('show');
        document.getElementById('settlementModal').style.display = 'flex';
    },
    
    close: function() {
        document.getElementById('settlementModal').classList.remove('show');
        setTimeout(() => {
            document.getElementById('settlementModal').style.display = 'none';
        }, 300);
    },
    
    switchTab: function(tabName) {
        this.currentTab = tabName;
        document.querySelectorAll('.settlement-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        this.renderContent();
    },
    
    loadData: function() {
        const data = DataManager.load();
        const names = DataManager.getNames();
        
        // è·å–å­¦ç”Ÿåˆ†æ•°å¹¶æ’åºï¼ˆV14ä¿®å¤ï¼šåŒºåˆ†è‡ªåŠ¨å¾—åˆ†å’Œæ‰‹åŠ¨è¯„ä»·ï¼‰
        const students = names.map(name => ({
            name: name,
            score: parseFloat((data.scores[name] || 0).toFixed(1)), // V14ä¿®å¤ï¼šç»Ÿä¸€ç²¾åº¦
            // V14ä¿®å¤ï¼šåªç»Ÿè®¡æ‰‹åŠ¨è¯„ä»·ï¼Œæ’é™¤è‡ªåŠ¨å¾—åˆ†
            positiveCount: data.stats.filter(s => 
                s.action && s.action.includes(name) && 
                s.action.includes('+') && 
                !s.isAutoScore // æ’é™¤è‡ªåŠ¨å¾—åˆ†
            ).length,
            negativeCount: data.stats.filter(s => 
                s.action && s.action.includes(name) && 
                s.action.includes('-') && 
                !s.isAutoScore // æ’é™¤è‡ªåŠ¨å¾—åˆ†
            ).length
        })).sort((a, b) => b.score - a.score);
        
        // è·å–å‰ä¸‰å
        this.top3Students = students.slice(0, 3);
        
        // åŠ è½½å¥–å“æ±  - V14æ”¹ä¸ºä»textareaè·å–
        this.prizePool = document.getElementById('prizeInput').value
            .split('\n')
            .filter(p => p.trim());
        
        return students;
    },
    
    renderContent: function() {
        const contentEl = document.getElementById('settlementContent');
        
        switch(this.currentTab) {
            case 'ranking':
                contentEl.innerHTML = this.renderRankingTab();
                break;
            case 'lottery':
                contentEl.innerHTML = this.renderLotteryTab();
                break;
            case 'report':
                contentEl.innerHTML = this.renderReportTab();
                break;
            case 'questionBank':
                QuestionManager.showQuestionBank();
                break;
        }
    },
    
    renderRankingTab: function() {
        const students = this.loadData();
        
        let html = `
            <h3 style="margin-top:0;">ğŸ… æœ¬å ‚è¯¾æˆç»©æ’å</h3>
            <p style="color:#666; margin-bottom:20px;">ç‚¹å‡»å­¦ç”Ÿå§“åæŸ¥çœ‹è¯¦æƒ…</p>
            <div class="ranking-list">
        `;
        
        students.forEach((student, index) => {
            const rankClass = index === 0 ? 'rank-1' : 
                             index === 1 ? 'rank-2' : 
                             index === 2 ? 'rank-3' : 'rank-other';
            const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ…';
            
            html += `
                <div class="ranking-item" onclick="SettlementSystem.showStudentDetail('${student.name}')">
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div style="flex: 1;">
                        <div style="font-weight:bold; font-size:1.1rem;">${student.name}</div>
                        <div style="display:flex; gap:15px; font-size:0.9rem; color:#666; margin-top:5px;">
                            <span>æ€»åˆ†: <strong style="color:var(--primary-blue)">${student.score.toFixed(1)}</strong></span>
                            <span>ğŸ‘ ${student.positiveCount || 0}</span>
                            <span>âš ï¸ ${student.negativeCount || 0}</span>
                        </div>
                    </div>
                    <div style="font-size:1.5rem;">${medal}</div>
                </div>
            `;
        });
        
        html += `
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-primary" onclick="SettlementSystem.awardTop3()">
                    ğŸ ä¸ºå‰ä¸‰åæŠ½å¥–
                </button>
            </div>
        `;
        
        return html;
    },
    
    // V14ä¼˜åŒ–ï¼šå¥–å“åˆ—è¡¨ç®¡ç†æ¨¡å¼
    renderLotteryTab: function() {
        const top3 = this.top3Students;
        
        // åŠ è½½å¥–å“æ± 
        this.loadPrizePool();
        
        let html = `
            <h3 style="margin-top:0;">ğŸ å‰ä¸‰åå¹¸è¿æŠ½å¥–</h3>
            <p style="color:#666; margin-bottom:20px;">ä¾æ¬¡ä¸ºå‰ä¸‰åæŠ½å–å¥–åŠ±</p>
            
            <!-- V14æ–°å¢ï¼šå¥–å“åˆ—è¡¨ç®¡ç† -->
            <div class="prize-list-container">
                <h4 style="margin-top:0; margin-bottom:15px;">ğŸ“‹ å½“å‰å¥–å“æ± </h4>
                <div class="prize-list" id="prizeList">
                    <!-- å¥–å“åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="newPrizeInput" placeholder="è¾“å…¥æ–°å¥–å“..." class="custom-prize-input" style="flex:1;">
                    <button class="btn btn-primary" onclick="SettlementSystem.addNewPrize()">æ·»åŠ </button>
                </div>
            </div>
            
            <div class="lottery-area">
                <div id="lotteryStudent" style="font-size:1.2rem; color:var(--primary-blue); font-weight:bold;">
                    ç­‰å¾…å¼€å§‹æŠ½å¥–...
                </div>
                <div id="lotteryDisplay" class="lottery-display">ç‚¹å‡»å¼€å§‹</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-warning" onclick="SettlementSystem.startLottery()" id="startLotteryBtn">
                        ğŸ² å¼€å§‹æŠ½å¥–
                    </button>
                    <button class="btn btn-danger" onclick="SettlementSystem.resetLottery()">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                </div>
            </div>
            <div id="lotteryResultsContainer"></div>
        `;
        
        // æ¸²æŸ“å¥–å“åˆ—è¡¨
        this.renderPrizeList();
        
        return html;
    },
    
    // V14æ–°å¢ï¼šåŠ è½½å¥–å“æ± 
    loadPrizePool: function() {
        const prizeText = document.getElementById('prizeInput').value;
        this.prizePool = prizeText.split('\n').filter(p => p.trim());
    },
    
    // V14æ–°å¢ï¼šæ¸²æŸ“å¥–å“åˆ—è¡¨
    renderPrizeList: function() {
        const listEl = document.getElementById('prizeList');
        if (!listEl) return;
        
        listEl.innerHTML = '';
        
        if (this.prizePool.length === 0) {
            listEl.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">å¥–å“æ± ä¸ºç©ºï¼Œè¯·æ·»åŠ å¥–å“</p>';
            return;
        }
        
        this.prizePool.forEach((prize, index) => {
            const item = document.createElement('div');
            item.className = 'prize-item';
            item.innerHTML = `
                <div class="prize-text">${index + 1}. ${prize}</div>
                <button class="delete-prize-btn" onclick="SettlementSystem.removePrize(${index})">Ã—</button>
            `;
            listEl.appendChild(item);
        });
    },
    
    // V14æ–°å¢ï¼šæ·»åŠ æ–°å¥–å“
    addNewPrize: function() {
        const input = document.getElementById('newPrizeInput');
        const prize = input.value.trim();
        
        if (!prize) {
            Message.show('è¯·è¾“å…¥å¥–å“åç§°', 'warning');
            return;
        }
        
        this.prizePool.push(prize);
        this.savePrizePool();
        this.renderPrizeList();
        input.value = '';
        Message.show(`å·²æ·»åŠ å¥–å“: ${prize}`, 'success');
    },
    
    // V14æ–°å¢ï¼šç§»é™¤å¥–å“
    removePrize: function(index) {
        if (index >= 0 && index < this.prizePool.length) {
            this.prizePool.splice(index, 1);
            this.savePrizePool();
            this.renderPrizeList();
            Message.show('å¥–å“å·²ç§»é™¤', 'success');
        }
    },
    
    // V14æ–°å¢ï¼šä¿å­˜å¥–å“æ± 
    savePrizePool: function() {
        const prizeText = this.prizePool.join('\n');
        document.getElementById('prizeInput').value = prizeText;
        DataManager.savePrizes();
    },
    
    renderReportTab: function() {
        const data = DataManager.load();
        const students = this.loadData();
        
        // V14ä¿®å¤ï¼šåŒºåˆ†ç»Ÿè®¡é€»è¾‘
        const manualStats = data.stats.filter(s => !s.isAutoScore);
        const autoStats = data.stats.filter(s => s.isAutoScore);
        
        // è®¡ç®—è¯¾å ‚ç»Ÿè®¡
        const totalScoreChanges = manualStats.length;
        const positiveActions = manualStats.filter(s => s.action && s.action.includes('+')).length;
        const negativeActions = manualStats.filter(s => s.action && s.action.includes('-')).length;
        const gamesPlayed = [...new Set(data.stats.filter(s => s.game).map(s => s.game))].length;
        const autoScoreCount = autoStats.length;
        
        // ç”ŸæˆæŠ¥å‘Šæ–‡æœ¬
        const reportDate = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString();
        
        let html = `
            <div class="report-summary">
                <h3 style="margin-top:0;">ğŸ“… è¯¾å ‚æŠ¥å‘Š - ${reportDate}</h3>
                <div class="report-stats">
                    <div class="stat-card">
                        <div class="stat-value">${students.length}</div>
                        <div class="stat-label">å‚ä¸å­¦ç”Ÿ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalScoreChanges}</div>
                        <div class="stat-label">è¯„ä»·æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${gamesPlayed}</div>
                        <div class="stat-label">æ¸¸æˆæ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${positiveActions}/${negativeActions}</div>
                        <div class="stat-label">ğŸ‘/âš ï¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${autoScoreCount}</div>
                        <div class="stat-label">è‡ªåŠ¨å¾—åˆ†</div>
                    </div>
                </div>
            </div>
            
            <div style="background: #f0f4f8; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h4>ğŸ† è¯¾å ‚å‰ä¸‰å</h4>
                <div style="display: flex; gap: 15px; margin: 15px 0;">
                    ${this.top3Students.map((s, i) => `
                        <div style="background: white; padding: 15px; border-radius: 10px; flex: 1; text-align: center;">
                            <div style="font-size: 0.9rem; color: #666;">ç¬¬${i+1}å</div>
                            <div style="font-weight: bold; font-size: 1.2rem;">${s.name}</div>
                            <div style="color: var(--primary-blue); font-weight: bold;">${s.score.toFixed(1)}åˆ†</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div id="reportPreview" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #eee; white-space: pre-line; font-family: monospace; max-height: 300px; overflow-y: auto;">
                ${this.generateReportText()}
            </div>
            <p style="color: #888; font-size: 0.9rem; margin-top: 10px;">
                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶ä»¥ä¸ŠæŠ¥å‘Šå†…å®¹ï¼Œå¯ç²˜è´´åˆ°ç­çº§ç¾¤æˆ–è®°å½•æœ¬ä¸­
            </p>
        `;
        
        return html;
    },
    
    // ä¼˜åŒ–æŠ½å¥–åŠŸèƒ½ï¼šä¾æ¬¡æŠ½å¥–
    startLottery: function() {
        const top3 = this.top3Students;
        if (top3.length === 0) {
            Message.show('æš‚æ— å‰ä¸‰åæ•°æ®ï¼Œè¯·å…ˆæŸ¥çœ‹æ’å', 'warning');
            return;
        }
        
        if (this.prizePool.length === 0) {
            Message.show('å¥–å“æ± ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å¥–å“', 'warning');
            return;
        }
        
        const btn = document.getElementById('startLotteryBtn');
        const display = document.getElementById('lotteryDisplay');
        const studentEl = document.getElementById('lotteryStudent');
        
        btn.disabled = true;
        btn.innerHTML = 'ğŸ° æŠ½å¥–ä¸­...';
        
        // æ¸…ç©ºä¹‹å‰çš„æŠ½å¥–ç»“æœ
        this.lotteryResults = {};
        document.getElementById('lotteryResultsContainer').innerHTML = '';
        
        // ä¾æ¬¡ä¸ºæ¯ä¸ªå­¦ç”ŸæŠ½å¥–
        this.startIndividualLottery(0);
    },
    
    startIndividualLottery: function(studentIndex) {
        const top3 = this.top3Students;
        if (studentIndex >= top3.length) {
            // æ‰€æœ‰å­¦ç”Ÿéƒ½æŠ½å®Œäº†
            document.getElementById('startLotteryBtn').disabled = false;
            document.getElementById('startLotteryBtn').innerHTML = 'ğŸ² é‡æ–°æŠ½å¥–';
            this.showLotteryResults();
            return;
        }
        
        const student = top3[studentIndex];
        const display = document.getElementById('lotteryDisplay');
        const studentEl = document.getElementById('lotteryStudent');
        
        studentEl.innerHTML = `æ­£åœ¨ä¸º <strong style="color:var(--primary-blue)">${student.name}</strong> æŠ½å¥–...`;
        display.textContent = 'å‡†å¤‡ä¸­...';
        display.classList.add('spinning');
        
        // æ’­æ”¾æŠ½å¥–éŸ³æ•ˆ
        SoundManager.shuffle();
        
        // æŠ½å¥–åŠ¨ç”»
        let animationCount = 0;
        const maxAnimations = 30;
        const availablePrizes = [...this.prizePool];
        
        const animationInterval = TimerManager.setInterval(() => {
            const randomPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
            display.textContent = randomPrize;
            animationCount++;
            
            if (animationCount >= maxAnimations) {
                TimerManager.clearInterval(animationInterval);
                display.classList.remove('spinning');
                
                // ç¡®å®šæœ€ç»ˆå¥–å“
                const finalPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
                this.lotteryResults[student.name] = finalPrize;
                
                // æ’­æ”¾ä¸­å¥–éŸ³æ•ˆ
                SoundManager.win();
                
                // æ˜¾ç¤ºå•ä¸ªæŠ½å¥–ç»“æœ
                const resultDiv = document.createElement('div');
                resultDiv.className = 'lottery-result show';
                resultDiv.style.animation = 'slideUp 0.5s ease-out';
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px;">
                        <div style="font-size: 2rem; color: var(--primary-blue);">${studentIndex + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1.2rem;">${student.name}</div>
                            <div style="color: #666;">ç¬¬${studentIndex + 1}å - ${student.score.toFixed(1)}åˆ†</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); 
                                    color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                            ğŸ ${finalPrize}
                        </div>
                    </div>
                `;
                
                document.getElementById('lotteryResultsContainer').appendChild(resultDiv);
                
                // è®°å½•åˆ°ç³»ç»Ÿï¼ˆæ ‡è®°ä¸ºæ‰‹åŠ¨è¯„ä»·ï¼‰
                scoreSys.change(student.name, 2, `æŠ½å¥–è·å¾—: ${finalPrize}`);
                GameStats.record('æŠ½å¥–', `${student.name} æŠ½ä¸­: ${finalPrize}`, false);
                
                // å»¶è¿Ÿåå¼€å§‹ä¸‹ä¸€ä¸ªå­¦ç”Ÿçš„æŠ½å¥–
                setTimeout(() => {
                    this.startIndividualLottery(studentIndex + 1);
                }, 2000);
            }
        }, 100);
    },
    
    showLotteryResults: function() {
        const container = document.getElementById('lotteryResultsContainer');
        let html = '<div class="lottery-result show"><h4>ğŸ‰ æŠ½å¥–ç»“æœ</h4>';
        
        Object.entries(this.lotteryResults).forEach(([name, prize], index) => {
            html += `
                <div style="padding: 10px 0; border-bottom: 1px dashed #ddd;">
                    <strong style="color: var(--primary-blue);">${index + 1}. ${name}</strong>
                    <span style="float: right; background: #e3f2fd; padding: 3px 10px; border-radius: 15px;">
                        ğŸ ${prize}
                    </span>
                </div>
            `;
        });
        
        html += '<p style="margin-top: 10px; color: #666; font-size: 0.9rem;">å¥–å“å·²è‡ªåŠ¨è®°å½•åˆ°å­¦ç”Ÿæ¡£æ¡ˆä¸­</p></div>';
        container.innerHTML = html;
    },
    
    resetLottery: function() {
        this.lotteryResults = {};
        document.getElementById('lotteryResultsContainer').innerHTML = '';
        document.getElementById('lotteryDisplay').textContent = 'ç‚¹å‡»å¼€å§‹';
        document.getElementById('startLotteryBtn').disabled = false;
        document.getElementById('startLotteryBtn').innerHTML = 'ğŸ² å¼€å§‹æŠ½å¥–';
    },
    
    // æŠ¥å‘Šç”Ÿæˆæ–¹æ³•
    generateReportText: function() {
        const data = DataManager.load();
        const students = this.loadData();
        const top3 = this.top3Students;
        const date = new Date();
        
        let report = `ã€å¿«ä¹è¯¾å ‚ - è¯¾å ‚æŠ¥å‘Šã€‘\n`;
        report += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
        report += `ğŸ“… æ—¥æœŸ: ${date.toLocaleDateString()} ${date.toLocaleTimeString().slice(0,5)}\n`;
        report += `ğŸ‘¥ å‚ä¸å­¦ç”Ÿ: ${students.length}äºº\n`;
        report += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
        report += `ğŸ† ã€è¯¾å ‚å‰ä¸‰åã€‘\n`;
        
        top3.forEach((student, index) => {
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            report += `${medals[index]} ${student.name} - ${student.score.toFixed(1)}åˆ†\n`;
        });
        
        report += `\nğŸ“Š ã€åˆ†æ•°ç»Ÿè®¡ã€‘\n`;
        report += `æœ€é«˜åˆ†: ${top3[0]?.score.toFixed(1) || 0}åˆ†\n`;
        report += `å¹³å‡åˆ†: ${(students.reduce((sum, s) => sum + s.score, 0) / students.length).toFixed(1)}åˆ†\n`;
        
        report += `\nğŸ® ã€è¯¾å ‚æ´»åŠ¨ã€‘\n`;
        const games = [...new Set(data.stats.filter(s => s.game).map(s => s.game))];
        games.forEach(game => {
            const count = data.stats.filter(s => s.game === game).length;
            report += `â€¢ ${game}: ${count}æ¬¡\n`;
        });
        
        report += `\nâœ¨ ã€ç‰¹åˆ«è¡¨æ‰¬ã€‘\n`;
        students.filter(s => s.positiveCount > 3).forEach(s => {
            report += `â€¢ ${s.name} (è·å¾—${s.positiveCount}æ¬¡è¡¨æ‰¬)\n`;
        });
        
        report += `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
        report += `è®°å½•ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleTimeString()}\n`;
        report += `æ•™å¸ˆç­¾å: _________\n`;
        
        return report;
    },
    
    // ä¸€é”®å¤åˆ¶åŠŸèƒ½
    copyClassSummary: function() {
        const reportText = this.generateReportText();
        const btn = document.getElementById('copySummaryBtn');
        
        // ä½¿ç”¨Clipboard APIå¤åˆ¶æ–‡æœ¬
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(reportText).then(() => {
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                }, 2000);
            }).catch(err => {
                // é™çº§æ–¹æ¡ˆ
                this.copyUsingExecCommand(reportText, btn);
            });
        } else {
            // é™çº§æ–¹æ¡ˆ
            this.copyUsingExecCommand(reportText, btn);
        }
    },
    
    copyUsingExecCommand: function(text, btn) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
            }, 2000);
            
            Message.show('è¯¾å ‚æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
        } catch (err) {
            Message.show('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        }
        
        document.body.removeChild(textArea);
    },
    
    // æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…
    showStudentDetail: function(name) {
        const data = DataManager.load();
        const studentStats = data.stats.filter(s => s.action && s.action.includes(name));
        
        let detailHtml = `
            <h4>ğŸ‘¤ ${name} - è¯¾å ‚è¡¨ç°è¯¦æƒ…</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between;">
                    <div>å½“å‰åˆ†æ•°: <strong>${(data.scores[name] || 0).toFixed(1)}</strong></div>
                    <div>æ€»è®°å½•æ•°: <strong>${studentStats.length}</strong></div>
                </div>
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
        `;
        
        if (studentStats.length === 0) {
            detailHtml += `<p style="color:#999; text-align:center;">æš‚æ— è®°å½•</p>`;
        } else {
            studentStats.slice(-10).reverse().forEach(stat => {
                const time = stat.time || 'æœªçŸ¥æ—¶é—´';
                const isAuto = stat.isAutoScore ? '<span style="color:#666; font-size:0.8rem;">(è‡ªåŠ¨)</span>' : '';
                detailHtml += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <div style="color:#666; font-size:0.9rem;">${time} ${isAuto}</div>
                        <div>${stat.game || 'ç³»ç»Ÿ'}: ${stat.action || 'æ— æè¿°'}</div>
                    </div>
                `;
            });
        }
        
        detailHtml += `</div>`;
        
        // ä½¿ç”¨ç°æœ‰æ¨¡æ€æ¡†æ˜¾ç¤º
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '3000';
        modal.innerHTML = `
            <div class="modal-card" style="max-width: 500px;">
                <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin:0;">å­¦ç”Ÿè¯¦æƒ…</h4>
                    <button class="btn btn-sm btn-outline" onclick="this.parentElement.parentElement.parentElement.remove()">å…³é—­</button>
                </div>
                <div style="padding: 20px;">
                    ${detailHtml}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // ä¸ºå‰ä¸‰åè‡ªåŠ¨é¢å¥–
    awardTop3: function() {
        const top3 = this.top3Students;
        if (top3.length === 0) return;
        
        const awards = ['ğŸ… è¯¾å ‚å† å†›', 'ğŸ¥ˆ è¯¾å ‚äºšå†›', 'ğŸ¥‰ è¯¾å ‚å­£å†›'];
        let message = 'å·²ä¸ºå‰ä¸‰åè‡ªåŠ¨åŠ åˆ†ï¼š\n\n';
        
        top3.forEach((student, index) => {
            const bonus = 5 - index; // å† å†›5åˆ†ï¼Œäºšå†›4åˆ†ï¼Œå­£å†›3åˆ†
            scoreSys.change(student.name, bonus, awards[index]);
            message += `${awards[index]} ${student.name} +${bonus}åˆ†\n`;
        });
        
        Message.show(message, 'success');
        this.loadData(); // åˆ·æ–°æ•°æ®
        this.renderContent(); // æ›´æ–°æ˜¾ç¤º
    }
};

// V14é‡æ„ï¼šè¯„ä»·ç³»ç»Ÿ
const scoreSys = {
    selected: new Set(),
    tagEditMode: false, // V14æ–°å¢ï¼šæ ‡ç­¾ç¼–è¾‘æ¨¡å¼
    
    initData: function() {
        const data = DataManager.load();
        const names = DataManager.getNames();
        names.forEach(n => { 
            if (data.scores[n] === undefined) data.scores[n] = 0;
            // V14ä¿®å¤ï¼šç¡®ä¿åˆ†æ•°ç²¾åº¦
            data.scores[n] = parseFloat(data.scores[n].toFixed(1));
        });
        DataManager.save(data);
        this.renderGrid();
        this.renderTags(); // V14æ–°å¢ï¼šæ¸²æŸ“åŠ¨æ€æ ‡ç­¾
    },
    
    change: function(name, delta, reason="æ¸¸æˆå¥–åŠ±", isAutoScore = false) {
        if (!name || typeof delta !== 'number') return;
        const data = DataManager.load();
        if (data.scores[name] === undefined) data.scores[name] = 0;
        
        // V14ä¿®å¤ï¼šé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
        const currentScore = parseFloat(data.scores[name].toFixed(1));
        const newScore = parseFloat((currentScore + delta).toFixed(1));
        data.scores[name] = newScore;
        
        DataManager.save(data);
        GameStats.record('Score', `${name} ${delta > 0 ? '+' : ''}${delta} (${reason})`, isAutoScore);
        if(document.getElementById('scoreModal').style.display === 'flex') this.renderGrid();
        
        // æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºçš„åˆ†æ•°
        this.updateAllScoreDisplays();
    },
    
    updateAllScoreDisplays: function() {
        // æ›´æ–°å­¦ç”Ÿåˆ—è¡¨ä¸­çš„åˆ†æ•°æ˜¾ç¤º
        const data = DataManager.load();
        document.querySelectorAll('.student-item .badge').forEach(badge => {
            const name = badge.parentElement.textContent.replace(badge.textContent, '').trim();
            if (data.scores[name] !== undefined) {
                badge.textContent = data.scores[name].toFixed(1);
            }
        });
    },
    
    // V14é‡æ„ï¼šä½¿ç”¨åŠ¨æ€æ ‡ç­¾
    batchChange: function(delta, reason) {
        if (this.selected.size === 0) {
            Message.show('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿï¼', 'warning');
            return;
        }
        const data = DataManager.load();
        let count = 0;
        this.selected.forEach(name => {
            if (data.scores[name] === undefined) data.scores[name] = 0;
            // V14ä¿®å¤ï¼šé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
            const currentScore = parseFloat(data.scores[name].toFixed(1));
            data.scores[name] = parseFloat((currentScore + delta).toFixed(1));
            count++;
        });
        DataManager.save(data);
        SoundManager.win();
        Message.show(`å·²ç»™ ${count} ä½åŒå­¦ ${delta>0?'+':''}${delta} åˆ† (${reason})`, 'success');
        this.close();
        this.updateAllScoreDisplays();
    },
    
    // V14æ–°å¢ï¼šæ”¯æŒè‡ªå®šä¹‰åˆ†å€¼çš„æ‰¹é‡æ“ä½œ
    applyCustom: function() {
        const scoreInput = document.getElementById('customScore');
        const rInput = document.getElementById('customReason');
        
        const score = parseFloat(scoreInput.value);
        const r = sanitizeInput(rInput.value);
        
        if (isNaN(score) || score === 0) {
            Message.show('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†å€¼ï¼ˆéé›¶æ•°å­—ï¼‰', 'warning');
            return;
        }
        
        if (!r) {
            Message.show('è¯·è¾“å…¥ç†ç”±', 'warning');
            return;
        }
        
        this.batchChange(score, r);
        scoreInput.value = '';
        rInput.value = "";
    },
    
    resetAllScores: function() {
        Message.confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿçš„åˆ†æ•°å—ï¼Ÿ').then((confirmed) => {
            if (confirmed) {
                const data = DataManager.load();
                for(let k in data.scores) data.scores[k] = 0;
                DataManager.save(data);
                this.renderGrid();
                Message.show('å·²é‡ç½®æ‰€æœ‰åˆ†æ•°ã€‚', 'success');
                this.updateAllScoreDisplays();
            }
        });
    },
    
    open: function() {
        document.getElementById('scoreModal').classList.add('show');
        document.getElementById('scoreModal').style.display = 'flex';
        this.selected.clear();
        this.tagEditMode = false;
        this.initData();
    },
    
    close: function() {
        document.getElementById('scoreModal').classList.remove('show');
        setTimeout(() => { document.getElementById('scoreModal').style.display = 'none'; }, 300);
    },
    
    renderGrid: function() {
        const grid = document.getElementById('studentGrid');
        grid.innerHTML = '';
        const data = DataManager.load();
        const names = DataManager.getNames();
        if (names.length === 0) {
            grid.innerHTML = '<p style="color:#999; text-align:center; width:100%;">è¯·å…ˆè®¾ç½®åå•</p>';
            return;
        }
        names.forEach(name => {
            const div = document.createElement('div');
            div.className = `student-item ${this.selected.has(name) ? 'selected' : ''}`;
            // V14ä¿®å¤ï¼šæ˜¾ç¤ºä¸€ä½å°æ•°
            div.innerHTML = `${name} <span class="badge">${(data.scores[name] || 0).toFixed(1)}</span>`;
            div.onclick = () => {
                SoundManager.click();
                if (this.selected.has(name)) this.selected.delete(name); else this.selected.add(name);
                this.renderGrid();
            };
            grid.appendChild(div);
        });
    },
    
    selectAll: function() { 
        DataManager.getNames().forEach(n => this.selected.add(n)); 
        this.renderGrid(); 
        Message.show('å·²é€‰æ‹©æ‰€æœ‰å­¦ç”Ÿ', 'info');
    },
    
    deselectAll: function() { 
        this.selected.clear(); 
        this.renderGrid();
        Message.show('å·²å–æ¶ˆé€‰æ‹©æ‰€æœ‰å­¦ç”Ÿ', 'info');
    },
    
    // V14æ–°å¢ï¼šåŠ¨æ€æ ‡ç­¾æ¸²æŸ“
    renderTags: function() {
        const tags = DataManager.loadTags();
        
        // æ¸²æŸ“ç§¯æè¡¨ç°æ ‡ç­¾
        const positiveContainer = document.getElementById('positiveTags');
        positiveContainer.innerHTML = '';
        tags.positive.forEach((tag, index) => {
            this.createTagButton(positiveContainer, tag, 'positive', index);
        });
        
        // æ¸²æŸ“å¾…æ”¹è¿›æ ‡ç­¾
        const negativeContainer = document.getElementById('negativeTags');
        negativeContainer.innerHTML = '';
        tags.negative.forEach((tag, index) => {
            this.createTagButton(negativeContainer, tag, 'negative', index);
        });
        
        // æ¸²æŸ“ç‰¹åˆ«é¼“åŠ±æ ‡ç­¾
        const specialContainer = document.getElementById('specialTags');
        specialContainer.innerHTML = '';
        tags.special.forEach((tag, index) => {
            this.createTagButton(specialContainer, tag, 'special', index);
        });
    },
    
    // V14æ–°å¢ï¼šåˆ›å»ºæ ‡ç­¾æŒ‰é’®
    createTagButton: function(container, tag, category, index) {
        const btn = document.createElement('button');
        btn.className = `tag-btn ${category === 'negative' ? 'neg' : 'pos'}`;
        
        if (this.tagEditMode) {
            btn.classList.add('edit-mode');
            btn.innerHTML = `
                ${tag.text}
                <button class="delete-tag-btn" onclick="scoreSys.deleteTag('${category}', ${index})">Ã—</button>
            `;
        } else {
            btn.textContent = tag.text;
            btn.onclick = () => {
                this.batchChange(tag.value, tag.text.split(' ')[0]);
            };
        }
        
        container.appendChild(btn);
    },
    
    // V14æ–°å¢ï¼šåˆ‡æ¢æ ‡ç­¾ç¼–è¾‘æ¨¡å¼
    toggleTagEditMode: function() {
        this.tagEditMode = !this.tagEditMode;
        const btn = document.getElementById('tagEditModeBtn');
        btn.textContent = this.tagEditMode ? 'å®Œæˆç¼–è¾‘' : 'ç®¡ç†æ ‡ç­¾';
        btn.classList.toggle('btn-warning');
        btn.classList.toggle('btn-success');
        
        this.renderTags();
    },
    
    // V14æ–°å¢ï¼šæ˜¾ç¤ºæ·»åŠ æ ‡ç­¾å¯¹è¯æ¡†
    showAddTagDialog: function(category) {
        const categoryNames = {
            'positive': 'ç§¯æè¡¨ç°',
            'negative': 'å¾…æ”¹è¿›',
            'special': 'ç‰¹åˆ«é¼“åŠ±'
        };
        
        const dialog = document.createElement('div');
        dialog.className = 'tag-manager-dialog';
        dialog.innerHTML = `
            <div class="tag-manager-content">
                <h3 style="margin-top:0;">æ·»åŠ ${categoryNames[category]}æ ‡ç­¾</h3>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px;">æ ‡ç­¾æ–‡æœ¬ï¼ˆåŒ…å«è¡¨æƒ…å’Œåˆ†å€¼ï¼‰</label>
                    <input type="text" id="newTagText" placeholder="ä¾‹å¦‚ï¼šâœ… ä½œä¸šå…¨å¯¹ +1" style="width:100%;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px;">åˆ†å€¼ï¼ˆæ­£æ•°æˆ–è´Ÿæ•°ï¼‰</label>
                    <input type="number" id="newTagValue" step="0.5" placeholder="ä¾‹å¦‚ï¼š1 æˆ– -1" style="width:100%;">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="scoreSys.saveNewTag('${category}')">ä¿å­˜</button>
                    <button class="btn btn-outline" onclick="this.closest('.tag-manager-dialog').remove()">å–æ¶ˆ</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
    },
    
    // V14æ–°å¢ï¼šä¿å­˜æ–°æ ‡ç­¾
    saveNewTag: function(category) {
        const textInput = document.getElementById('newTagText');
        const valueInput = document.getElementById('newTagValue');
        
        const text = textInput.value.trim();
        const value = parseFloat(valueInput.value);
        
        if (!text) {
            Message.show('è¯·è¾“å…¥æ ‡ç­¾æ–‡æœ¬', 'warning');
            return;
        }
        
        if (isNaN(value)) {
            Message.show('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†å€¼', 'warning');
            return;
        }
        
        // æ£€æŸ¥åˆ†å€¼æ˜¯å¦ç¬¦åˆç±»åˆ«
        if (category === 'negative' && value >= 0) {
            Message.show('å¾…æ”¹è¿›æ ‡ç­¾çš„åˆ†å€¼åº”ä¸ºè´Ÿæ•°', 'warning');
            return;
        }
        
        if ((category === 'positive' || category === 'special') && value <= 0) {
            Message.show('ç§¯æè¡¨ç°å’Œç‰¹åˆ«é¼“åŠ±æ ‡ç­¾çš„åˆ†å€¼åº”ä¸ºæ­£æ•°', 'warning');
            return;
        }
        
        // ä¿å­˜æ ‡ç­¾
        const success = DataManager.addTag(category, text, value);
        if (success) {
            Message.show('æ ‡ç­¾å·²æ·»åŠ ', 'success');
            this.renderTags();
            document.querySelector('.tag-manager-dialog').remove();
        } else {
            Message.show('æ ‡ç­¾å·²å­˜åœ¨', 'warning');
        }
    },
    
    // V14æ–°å¢ï¼šåˆ é™¤æ ‡ç­¾
    deleteTag: function(category, index) {
        Message.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡ç­¾å—ï¼Ÿ').then((confirmed) => {
            if (confirmed) {
                const success = DataManager.removeTag(category, index);
                if (success) {
                    Message.show('æ ‡ç­¾å·²åˆ é™¤', 'success');
                    this.renderTags();
                }
            }
        });
    }
};

// V14é‡æ„ï¼šæ¸¸æˆåº”ç”¨ä¸»ç±»
const GameApp = {
    hiddenGames: new Set(), // å­˜å‚¨éšè—çš„æ¸¸æˆ
    
    init: function() {
        const data = DataManager.load();
        document.getElementById('nameInput').value = data.names;
        document.getElementById('prizeInput').value = data.prizes;
        SoundManager.init();
        this.switchTab('games');
        
        // åŠ è½½éšè—çš„æ¸¸æˆè®¾ç½®
        if (data.hiddenGames) {
            this.hiddenGames = new Set(data.hiddenGames);
            this.updateGameVisibility();
        }
        
        SettlementSystem.prizePool = document.getElementById('prizeInput').value
            .split('\n')
            .filter(p => p.trim());
        
        document.body.addEventListener('click', () => SoundManager.init(), {once:true});
        Message.init();
    },
    
    showSettings: function() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = 'flex';
        modal.classList.add('show');
        
        // è®¾ç½®å¤é€‰æ¡†çŠ¶æ€
        document.getElementById('hideRiddleSoup').checked = this.hiddenGames.has('riddleSoup');
        document.getElementById('hideBrainTeaser').checked = this.hiddenGames.has('brainTeaser');
        document.getElementById('hideDrawGuess').checked = this.hiddenGames.has('drawGuess');
        document.getElementById('hideNumberBomb').checked = this.hiddenGames.has('numberBomb');
    },
    
    toggleGameVisibility: function(gameId, hide) {
        const data = DataManager.load();
        if (!data.hiddenGames) data.hiddenGames = [];
        
        if (hide) {
            this.hiddenGames.add(gameId);
            if (!data.hiddenGames.includes(gameId)) {
                data.hiddenGames.push(gameId);
            }
        } else {
            this.hiddenGames.delete(gameId);
            data.hiddenGames = data.hiddenGames.filter(g => g !== gameId);
        }
        
        DataManager.save(data);
        this.updateGameVisibility();
    },
    
    updateGameVisibility: function() {
        // æ›´æ–°æ¸¸æˆå¤§å…ä¸­çš„æ¸¸æˆæ˜¾ç¤º
        const games = {
            'riddleSoup': document.querySelector('.game-card[onclick*="riddleSoup"]'),
            'brainTeaser': document.querySelector('.game-card[onclick*="brainTeaser"]'),
            'drawGuess': document.querySelector('.game-card[onclick*="drawGuess"]'),
            'numberBomb': document.querySelector('.game-card[onclick*="numberBomb"]')
        };
        
        for (const [gameId, element] of Object.entries(games)) {
            if (element) {
                if (this.hiddenGames.has(gameId)) {
                    element.style.display = 'none';
                } else {
                    element.style.display = 'block';
                }
            }
        }
    },
    
    // V14æ–°å¢ï¼šéšæœºé€‰æ‹©æ¸¸æˆ
    selectRandomGame: function() {
        const activeTab = document.querySelector('.nav-tab.active');
        let lobbyId;
        
        if (activeTab.textContent.includes('ç»¼åˆ')) {
            lobbyId = 'games-lobby';
        } else if (activeTab.textContent.includes('å­¦ç§‘')) {
            lobbyId = 'academic-lobby';
        } else {
            lobbyId = 'tools-lobby';
        }
        
        const lobby = document.getElementById(lobbyId);
        if (!lobby) return;
        
        // è·å–æ‰€æœ‰å¯è§çš„æ¸¸æˆå¡ç‰‡
        const visibleCards = Array.from(lobby.querySelectorAll('.game-card')).filter(card => {
            return card.style.display !== 'none';
        });
        
        if (visibleCards.length === 0) {
            Message.show('å½“å‰æ²¡æœ‰å¯ç”¨çš„æ¸¸æˆ', 'warning');
            return;
        }
        
        // éšæœºé€‰æ‹©ä¸€ä¸ªæ¸¸æˆ
        const randomIndex = Math.floor(Math.random() * visibleCards.length);
        const selectedCard = visibleCards[randomIndex];
        
        // æ·»åŠ é«˜äº®åŠ¨ç”»
        visibleCards.forEach(card => card.classList.remove('highlight'));
        selectedCard.classList.add('highlight');
        
        // æ’­æ”¾éŸ³æ•ˆ
        SoundManager.shuffle();
        
        // å»¶è¿Ÿåè‡ªåŠ¨è¿›å…¥æ¸¸æˆ
        setTimeout(() => {
            selectedCard.click();
        }, 1500);
        
        Message.show(`éšæœºé€‰æ‹©äº†: ${selectedCard.querySelector('h3').textContent}`, 'info');
    },
    
    showLobby: function() {
        TimerManager.clearAll();
        VirtualKeyboard.detachAll();
        document.querySelectorAll('.game-screen').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.game-card').forEach(card => card.classList.remove('highlight'));
        const activeTab = document.querySelector('.nav-tab.active');
        if(activeTab) activeTab.click();
    },
    
    switchTab: function(type) {
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.game-grid').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.game-screen').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.game-card').forEach(card => card.classList.remove('highlight'));
        const map = { 'games': { tabIdx: 0, gridId: 'games-lobby' }, 'academic': { tabIdx: 1, gridId: 'academic-lobby' }, 'tools': { tabIdx: 2, gridId: 'tools-lobby' } };
        const target = map[type];
        document.querySelectorAll('.nav-tab')[target.tabIdx].classList.add('active');
        document.getElementById(target.gridId).classList.add('active');
    },
    
    startGame: function(gameId) {
        SoundManager.click();
        TimerManager.clearAll(); // å½»åº•æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
        VirtualKeyboard.detachAll(); // ç§»é™¤æ‰€æœ‰é”®ç›˜
        
        // éšè—ä½ ç”»æˆ‘çŒœå¸¸é©»æç¤ºé¢æ¿
        document.getElementById('drawPermanentHint').style.display = 'none';
        
        document.querySelectorAll('.game-grid').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.game-screen').forEach(el => el.classList.remove('active'));
        const screen = document.getElementById('game-' + gameId);
        if(screen) screen.classList.add('active');
        
        // å»¶è¿ŸåŠ è½½ä»¥ç¡®ä¿DOMå¯è§
        setTimeout(() => {
            if(gameId === 'drawGuess') drawGame.init();
            if(gameId === 'namePicker') namePicker.updateDisplay();
            if(gameId === 'math') mathRace.init();
            if(gameId === 'riddleSoup') riddleSoup.init();
            if(gameId === 'brainTeaser') brainTeaser.init();
            if(gameId === 'spelling') spellingRace.init();
            if(gameId === 'numberBomb') bombGame.init();
            if(gameId === 'reflex') reflexGame.reset();
            
            setTimeout(() => { this.addQuestionButtons(gameId); }, 100);
            GameStats.record('StartGame', gameId, false);
        }, 50);
    },
    
    addQuestionButtons: function(gameId) {
        const header = document.querySelector(`#game-${gameId} .screen-header`);
        if (!header) return;
        const existingBtn = header.querySelector('.add-question-btn');
        if (existingBtn) existingBtn.remove();
        const gameNameMap = { 'drawGuess': 'ä½ ç”»æˆ‘çŒœ', 'riddleSoup': 'æµ·é¾Ÿæ±¤', 'brainTeaser': 'è„‘ç­‹æ€¥è½¬å¼¯', 'math': 'æ•°å­¦é€Ÿç®—', 'spelling': 'å•è¯æ‹¼å†™' };
        const gameName = gameNameMap[gameId];
        if (!gameName) return;
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-sm btn-outline add-question-btn';
        addBtn.innerHTML = '+ é¢˜åº“';
        addBtn.style.marginLeft = '10px';
        if (gameId === 'math' || gameId === 'spelling') {
            addBtn.onclick = () => {
                const levelEl = document.getElementById(`${gameId}Level`);
                QuestionManager.showAddDialog(gameName, levelEl ? levelEl.value : null);
            };
        } else {
            addBtn.onclick = () => QuestionManager.showAddDialog(gameName, null);
        }
        header.appendChild(addBtn);
    }
};

/* ==========================================================================
   æ¸¸æˆæ¨¡å— - V14.0 å¢å¼ºç‰ˆ
   ========================================================================== */

// V14å¢å¼ºï¼šä½ ç”»æˆ‘çŒœæ¸¸æˆ
const drawGame = {
    canvas: null, ctx: null, timer: null, isInit: false,
    currWord: "", currentPainter: null, history: [],
    currentColor: '#000',
    currentWordData: null, // V14æ–°å¢ï¼šå­˜å‚¨å½“å‰é¢˜ç›®æ•°æ®
    hintUnlockTimes: { type: 50, length: 40, randomChar: 30 }, // V14æ–°å¢ï¼šæç¤ºè§£é”æ—¶é—´
    
    init: function() {
        this.canvas = document.getElementById('drawCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.history = [];
        
        // é˜²æ­¢ resize äº‹ä»¶é‡å¤ç»‘å®š
        if (!this.isInit) {
            window.addEventListener('resize', debounce(() => this.resize(), 100));
            this.bindEvents();
            this.renderColors();
            this.isInit = true;
        }
        
        this.resize();
        this.updateWinnerSelect();
        document.getElementById('drawSetup').style.display = 'block';
        document.getElementById('drawPlay').style.display = 'none';
        document.getElementById('painterDisplay').innerText = '???';
        
        // éšè—æç¤ºé¢æ¿
        document.getElementById('drawPermanentHint').style.display = 'none';
        
        // é‡ç½®æç¤ºçŠ¶æ€
        this.resetHints();
        
        // åˆå§‹åŒ–æ—¶æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
        if (this.timer) {
            TimerManager.clearInterval(this.timer);
            this.timer = null;
        }
    },
    
    resetHints: function() {
        // é‡ç½®æ‰€æœ‰æç¤ºä¸ºé”å®šçŠ¶æ€
        const hints = ['hintType', 'hintLength', 'hintRandomChar'];
        hints.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('unlocked');
                el.classList.add('locked');
                el.querySelector('.hint-content').textContent = `å‰©ä½™${this.hintUnlockTimes[id]}ç§’è§£é”`;
            }
        });
    },
    
    resize: function() {
        if(!this.canvas || !this.canvas.parentElement) return;
        const rect = this.canvas.parentElement.getBoundingClientRect();
        this.canvas.width = rect.width;
        this.canvas.height = rect.height;
        if(this.ctx) { 
            this.ctx.lineWidth = 4; 
            this.ctx.lineCap = 'round'; 
            this.ctx.lineJoin = 'round';
            this.ctx.strokeStyle = this.currentColor;
        }
    },
    
    bindEvents: function() {
        if(!this.canvas) return;
        let drawing = false;
        let lastX, lastY;
        
        const start = (e) => { 
            e.preventDefault(); 
            drawing = true; 
            const {x, y} = this.getPos(e); 
            lastX = x;
            lastY = y;
            this.ctx.beginPath();
            this.ctx.moveTo(x, y);
            this.ctx.lineTo(x, y);
            this.ctx.stroke();
            
            // è®°å½•ç»˜åˆ¶å†å²
            this.history.push({
                type: 'start',
                x: x,
                y: y,
                color: this.ctx.strokeStyle,
                lineWidth: this.ctx.lineWidth
            });
        };
        
        const move = (e) => { 
            e.preventDefault(); 
            if(!drawing) return; 
            const {x, y} = this.getPos(e); 
            this.ctx.lineTo(x, y); 
            this.ctx.stroke();
            
            // è®°å½•ç»˜åˆ¶å†å²
            this.history.push({
                type: 'move',
                x: x,
                y: y
            });
            
            lastX = x;
            lastY = y;
        };
        
        const end = () => {
            if (drawing) {
                this.history.push({
                    type: 'end'
                });
            }
            drawing = false;
        };
        
        this.canvas.onmousedown = start; 
        this.canvas.onmousemove = move; 
        this.canvas.onmouseup = end;
        this.canvas.ontouchstart = start; 
        this.canvas.ontouchmove = move; 
        this.canvas.ontouchend = end;
    },
    
    getPos: function(e) {
        const rect = this.canvas.getBoundingClientRect();
        return { 
            x: (e.touches?e.touches[0].clientX:e.clientX) - rect.left, 
            y: (e.touches?e.touches[0].clientY:e.clientY) - rect.top 
        };
    },
    
    // V14æ–°å¢ï¼šåŒ…å«æ©¡çš®æ“¦çš„é¢œè‰²åˆ—è¡¨
    renderColors: function() {
        const container = document.getElementById('drawColors'); 
        container.innerHTML = '';
        const colors = [
            {color: '#000', name: 'é»‘è‰²', icon: 'â¬›'},
            {color: '#ff4757', name: 'çº¢è‰²', icon: 'ğŸŸ¥'},
            {color: '#2ed573', name: 'ç»¿è‰²', icon: 'ğŸŸ©'},
            {color: '#1e90ff', name: 'è“è‰²', icon: 'ğŸŸ¦'},
            {color: '#ffa502', name: 'æ©™è‰²', icon: 'ğŸŸ§'},
            {color: '#a55eea', name: 'ç´«è‰²', icon: 'ğŸŸª'},
            {color: '#ffffff', name: 'æ©¡çš®æ“¦', icon: 'ğŸ§¹', isEraser: true}
        ];
        
        colors.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'color-btn';
            if (c.isEraser) {
                btn.classList.add('eraser');
                btn.textContent = c.icon;
            } else {
                btn.style.background = c.color;
            }
            btn.title = c.name;
            btn.onclick = () => { 
                if (c.isEraser) {
                    this.ctx.strokeStyle = '#ffffff';
                    this.ctx.lineWidth = 10; // æ©¡çš®æ“¦åŠ ç²—
                } else {
                    this.ctx.strokeStyle = c.color;
                    this.ctx.lineWidth = 4;
                }
                this.currentColor = c.isEraser ? '#ffffff' : c.color;
                
                // æ·»åŠ åé¦ˆï¼šæ”¹å˜é€‰ä¸­çŠ¶æ€
                container.querySelectorAll('.color-btn').forEach(d => {
                    d.classList.remove('active');
                    if (d.classList.contains('eraser')) {
                        d.classList.remove('active');
                    }
                });
                btn.classList.add('active');
                SoundManager.click();
            };
            container.appendChild(btn);
        });
        
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªé¢œè‰²
        if(container.firstChild) {
            container.firstChild.classList.add('active');
        }
    },
    
    // V14ä¼˜åŒ–ï¼šå¢å¼ºç”»å®¶é€‰æ‹©åŠ¨ç”»
    enhancedSelectPainter: function() {
        // --- å…³é”®ä¿®æ”¹ï¼šç‚¹å‡»æŠ½å–ç”»å®¶æ—¶ï¼Œç«‹å³é‡ç½®æ¸¸æˆçŠ¶æ€ ---
        TimerManager.clearInterval(this.timer); // åœæ­¢å¯èƒ½æ­£åœ¨è¿›è¡Œçš„è®¡æ—¶å™¨
        this.timer = null;
        this.resetHints(); // ç«‹å³é‡ç½®æç¤ºä¸ºé”å®šçŠ¶æ€
        // ---------------------------------------------

        const names = DataManager.getNames();
        if(names.length === 0) {
            Message.show('è¯·å…ˆè®¾ç½®å­¦ç”Ÿåå•', 'error');
            return;
        }
        
        // åˆ›å»ºåŠ¨ç”»å®¹å™¨
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        `;
        
        const container = document.createElement('div');
        container.style.cssText = `
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        `;
        
        container.innerHTML = `
            <h3 style="margin-top:0;">ğŸ² æ­£åœ¨æŠ½å–ç”»å®¶...</h3>
            <div id="selectorAnimation" style="font-size: 2.5rem; margin: 30px 0; height: 60px; color: var(--primary-blue);"></div>
        `;
        
        overlay.appendChild(container);
        document.body.appendChild(overlay);
        
        const animationEl = document.getElementById('selectorAnimation');
        
        // å¼€å§‹åŠ¨ç”»
        let animationCount = 0;
        const maxAnimations = 25;
        
        const startAnimation = () => {
            const animationInterval = TimerManager.setInterval(() => {
                const randomName = names[Math.floor(Math.random() * names.length)];
                animationEl.textContent = randomName;
                animationEl.style.transform = `scale(${1 + Math.sin(animationCount * 0.2) * 0.1})`;
                
                animationCount++;
                if (animationCount >= maxAnimations) {
                    TimerManager.clearInterval(animationInterval);
                    this.finalizePainterSelection(names, animationEl, overlay);
                }
            }, 80);
        };
        
        setTimeout(startAnimation, 100);
    },
    
    finalizePainterSelection: function(names, animationEl, overlay) {
        const selected = names[Math.floor(Math.random() * names.length)];
        this.currentPainter = selected;
        
        // æœ€ç»ˆæ˜¾ç¤º
        animationEl.style.cssText = `
            font-size: 2.5rem;
            color: var(--primary-blue);
            font-weight: bold;
            animation: pulse 1s infinite;
        `;
        animationEl.textContent = selected;
        
        setTimeout(() => {
            overlay.remove();
            document.getElementById('currentPainter').innerText = this.currentPainter;
            document.getElementById('painterDisplay').innerText = selected;
            Message.show(`ç”»å®¶å·²é€‰å‡ºï¼š${selected}ï¼Œè¯·ä¸Šå°ï¼`, 'success');
        }, 1000);
    },
    
    showWordToPainter: function() {
        if(!this.currentPainter) {
            Message.show('è¯·å…ˆæŠ½å–ç”»å®¶', 'warning');
            return;
        }
        document.getElementById('drawSetup').style.display = 'none';
        document.getElementById('drawPlay').style.display = 'block';
        this.resize();
        this.startRound();
        Message.show(`${this.currentPainter}åŒå­¦ï¼Œè¯·çœ‹é¢˜ç›®ï¼å…¶ä»–åŒå­¦è¯·ç»§ç»­é—­çœ¼ã€‚`, 'info');
    },
    
    startRound: function() {
        // --- å…³é”®ä¿®æ”¹ï¼šå¼€å§‹æ–°å›åˆå‰å†æ¬¡ç¡®ä¿è®¡æ—¶å™¨æ¸…é™¤ ---
        TimerManager.clearInterval(this.timer);
        this.timer = null;
        // ----------------------------------------
        
        this.clear();
        this.history = [];
        
        // è·å–é¢˜ç›®ï¼ˆV14æ–°å¢ï¼šæ”¯æŒæ–°æ•°æ®ç»“æ„ï¼‰
        this.currentWordData = QuestionManager.getDrawGuessWord();
        this.currWord = this.currentWordData.word || this.currentWordData;
        const wordType = this.currentWordData.type || "å…¶ä»–";
        
        document.getElementById('drawWordText').innerText = this.currWord;
        this.toggleWord(true);
        
        // é‡ç½®æç¤ºé¢æ¿
        this.resetHints();
        
        // æ˜¾ç¤ºæç¤ºé¢æ¿ï¼ˆä½†å†…å®¹é”å®šï¼‰
        const hintPanel = document.getElementById('drawPermanentHint');
        hintPanel.style.display = 'block';
        
        // è®¾ç½®åˆå§‹æç¤ºå†…å®¹ï¼ˆä½†é”å®šï¼‰
        document.getElementById('hintType').querySelector('.hint-content').textContent = wordType;
        document.getElementById('hintLength').querySelector('.hint-content').textContent = `${this.currWord.length}ä¸ªå­—`;
        
        // éšæœºé€‰æ‹©ä¸€ä¸ªå­—ä½œä¸ºæç¤º
        const randomIndex = Math.floor(Math.random() * this.currWord.length);
        const randomChar = this.currWord[randomIndex];
        document.getElementById('hintRandomChar').querySelector('.hint-content').textContent = randomChar;
    },
    
    // V14æ–°å¢ï¼šè§£é”æç¤º
    unlockHint: function(hintId) {
        const hintEl = document.getElementById(hintId);
        if (hintEl && hintEl.classList.contains('locked')) {
            hintEl.classList.remove('locked');
            hintEl.classList.add('unlocked');
            SoundManager.playTone(800, 'sine', 0.2);
        }
    },
    
    startTimer: function() {
        // --- å…³é”®ä¿®æ”¹ï¼šé˜²æ­¢é‡å¤ç‚¹å‡»å¯¼è‡´è®¡æ—¶å™¨å åŠ  ---
        TimerManager.clearInterval(this.timer);
        this.timer = null;
        // -------------------------------------
        
        Message.show('åŒå­¦ä»¬å¯ä»¥ççœ¼äº†ï¼å¼€å§‹çŒœç”»ï¼', 'info');
        let t = GameConfigs.TIMERS.DRAW_GUESS;
        const el = document.getElementById('drawTimer');
        const hintTimer = document.getElementById('drawPermanentTimer');
        
        // æ˜¾ç¤ºæç¤ºé¢æ¿
        const panel = document.getElementById('drawPermanentHint');
        if (panel) {
            panel.style.display = 'block';
        }
        
        // ç«‹å³æ›´æ–°ä¸€æ¬¡ UI
        el.innerText = t + 's';
        if (hintTimer) hintTimer.innerText = t;

        this.timer = TimerManager.setInterval(() => {
            t--; 
            el.innerText = t + 's';
            
            // æ›´æ–°æç¤ºé¢æ¿è®¡æ—¶å™¨
            if (hintTimer) {
                hintTimer.innerText = t;
            }
            
            // V14æ–°å¢ï¼šæŒ‰æ—¶é—´èŠ‚ç‚¹è§£é”æç¤º
            if (t === this.hintUnlockTimes.type) {
                this.unlockHint('hintType');
                Message.show('ğŸ’¡ æç¤ºå·²è§£é”ï¼šè¯è¯­ç±»å‹', 'info');
            } else if (t === this.hintUnlockTimes.length) {
                this.unlockHint('hintLength');
                Message.show('ğŸ’¡ æç¤ºå·²è§£é”ï¼šè¯è¯­å­—æ•°', 'info');
            } else if (t === this.hintUnlockTimes.randomChar) {
                this.unlockHint('hintRandomChar');
                Message.show('ğŸ’¡ æç¤ºå·²è§£é”ï¼šåŒ…å«çš„å­—', 'info');
            } else if (t === 10) {
                Message.show('â° æœ€å10ç§’ï¼', 'warning');
            }
            
            if(t <= 10) SoundManager.tick();
            if(t <= 0) { 
                TimerManager.clearInterval(this.timer); 
                this.timer = null;
                SoundManager.error(); 
                Message.show('æ—¶é—´åˆ°ï¼', 'warning'); 
                // éšè—æç¤ºé¢æ¿
                document.getElementById('drawPermanentHint').style.display = 'none';
            }
        }, 1000);
    },
    
    toggleWord: function(forceHide=false) {
        const el = document.getElementById('drawWordText');
        if(forceHide || el.innerText !== '***') { 
            el.dataset.val = this.currWord; 
            el.innerText = '***'; 
        } else { 
            el.innerText = el.dataset.val; 
        }
    },
    
    clear: function() { 
        if(this.ctx) {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); 
        }
        this.history = [];
    },
    
    undo: function() {
        if (this.history.length === 0) return;
        
        // æ¸…é™¤ç”»å¸ƒ
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // é‡ç»˜å†å²ï¼ˆé™¤äº†æœ€åä¸€æ®µï¼‰
        this.history.pop(); // ç§»é™¤æœ€åä¸€æ®µ
        
        // é‡ç»˜æ‰€æœ‰å†å²è®°å½•
        this.ctx.beginPath();
        for (let i = 0; i < this.history.length; i++) {
            const action = this.history[i];
            if (action.type === 'start') {
                this.ctx.strokeStyle = action.color;
                this.ctx.lineWidth = action.lineWidth;
                this.ctx.beginPath();
                this.ctx.moveTo(action.x, action.y);
            } else if (action.type === 'move') {
                this.ctx.lineTo(action.x, action.y);
                this.ctx.stroke();
            } else if (action.type === 'end') {
                this.ctx.beginPath();
            }
        }
        
        SoundManager.click();
    },
    
    updateWinnerSelect: function() {
        const sel = document.getElementById('drawWinnerSelect'); 
        sel.innerHTML = '<option value="">é€‰æ‹©çŒœå¯¹çš„å­¦ç”Ÿ...</option>';
        DataManager.getNames().forEach(n => { 
            const opt = document.createElement('option'); 
            opt.value = n; 
            opt.innerText = n; 
            sel.appendChild(opt); 
        });
    },
    
    confirmWin: function() {
        const winner = document.getElementById('drawWinnerSelect').value;
        if(!winner) {
            Message.show('è¯·é€‰æ‹©å­¦ç”Ÿ', 'warning');
            return;
        }
        scoreSys.change(winner, 1, "ä½ ç”»æˆ‘çŒœ-çŒœå¯¹", false);
        if(this.currentPainter) scoreSys.change(this.currentPainter, 1, "ä½ ç”»æˆ‘çŒœ-ç»˜ç”»", false);
        SoundManager.win();
        Message.show(`${winner} å’Œç”»å®¶ ${this.currentPainter} å„åŠ  1 åˆ†ï¼`, 'success');
        TimerManager.clearInterval(this.timer);
        this.timer = null;
        // éšè—æç¤ºé¢æ¿
        document.getElementById('drawPermanentHint').style.display = 'none';
    }
};

// V14é‡æ„ï¼šæµ·é¾Ÿæ±¤æ¸¸æˆ
const riddleSoup = {
    currentQuestion: null,
    questions: [],
    questionCount: 0,
    
    init: function() {
        this.currentQuestion = QuestionManager.getRiddleSoupQuestion();
        this.questions = [];
        this.questionCount = 0;
        
        document.getElementById('storyText').innerText = this.currentQuestion.q || "åŠ è½½ä¸­...";
        document.getElementById('soupQuestions').innerHTML = '<h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">æé—®è®°å½•ï¼š</h4>';
        document.getElementById('soupQuestionCount').innerText = `æé—®: 0`;
        
        // é‡ç½®çº¿ç´¢æ˜¾ç¤º
        document.getElementById('clue1').classList.remove('unlocked');
        document.getElementById('clue2').classList.remove('unlocked');
        
        // è®¾ç½®çº¿ç´¢æ–‡æœ¬
        document.getElementById('clue1Text').innerText = this.currentQuestion.clue1 || "æé—®2ä¸ªé—®é¢˜åè§£é”";
        document.getElementById('clue2Text').innerText = this.currentQuestion.clue2 || "æé—®5ä¸ªé—®é¢˜åè§£é”";
        
        // æ›´æ–°çº¿ç´¢åŒºåŸŸæ˜¾ç¤º
        if (this.currentQuestion.clue1 || this.currentQuestion.clue2) {
            document.getElementById('soupCluesArea').style.display = 'block';
        } else {
            document.getElementById('soupCluesArea').style.display = 'none';
        }
    },
    
    // V14é‡æ„ï¼šç§»é™¤confirmå¼¹çª—ï¼Œç›´æ¥æ ‡è®°é—®é¢˜çŠ¶æ€
    markQuestion: function(status) {
        const questionInput = document.getElementById('soupQuestionInput');
        const questionText = questionInput.value.trim();
        
        if (!questionText) {
            Message.show('è¯·è¾“å…¥é—®é¢˜', 'warning');
            return;
        }
        
        // è®°å½•é—®é¢˜
        this.questions.push({
            text: questionText,
            status: status,
            time: new Date().toLocaleTimeString()
        });
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateQuestionList();
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        questionInput.value = '';
        
        // æ›´æ–°é—®é¢˜è®¡æ•°
        this.questionCount++;
        document.getElementById('soupQuestionCount').innerText = `æé—®: ${this.questionCount}`;
        
        // V14æ–°å¢ï¼šæ ¹æ®æé—®æ•°è§£é”çº¿ç´¢
        this.unlockClues();
        
        SoundManager.click();
        Message.show(`é—®é¢˜æ ‡è®°ä¸º: ${status}`, 'info');
    },
    
    submitQuestion: function() {
        const questionInput = document.getElementById('soupQuestionInput');
        const questionText = questionInput.value.trim();
        
        if (!questionText) {
            Message.show('è¯·è¾“å…¥é—®é¢˜', 'warning');
            return;
        }
        
        // è®°å½•é—®é¢˜ï¼ˆåˆå§‹çŠ¶æ€ä¸º"å¾…åˆ¤æ–­"ï¼‰
        this.questions.push({
            text: questionText,
            status: "å¾…åˆ¤æ–­",
            time: new Date().toLocaleTimeString()
        });
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateQuestionList();
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        questionInput.value = '';
        
        // æ›´æ–°é—®é¢˜è®¡æ•°
        this.questionCount++;
        document.getElementById('soupQuestionCount').innerText = `æé—®: ${this.questionCount}`;
        
        // V14æ–°å¢ï¼šæ ¹æ®æé—®æ•°è§£é”çº¿ç´¢
        this.unlockClues();
        
        SoundManager.click();
        Message.show('é—®é¢˜å·²è®°å½•', 'info');
    },
    
    // V14æ–°å¢ï¼šè§£é”çº¿ç´¢é€»è¾‘
    unlockClues: function() {
        if (this.questionCount >= 2) {
            document.getElementById('clue1').classList.add('unlocked');
        }
        
        if (this.questionCount >= 5) {
            document.getElementById('clue2').classList.add('unlocked');
        }
    },
    
    updateQuestionList: function() {
        const container = document.getElementById('soupQuestions');
        container.innerHTML = '<h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">æé—®è®°å½•ï¼š</h4>';
        
        this.questions.forEach((q, index) => {
            const item = document.createElement('div');
            item.className = 'soup-question-item';
            item.style.cssText = 'padding: 8px 12px; margin-bottom: 5px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ddd;';
            
            // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
            let borderColor = '#ddd';
            if (q.status === 'æ˜¯') borderColor = '#2ecc71';
            if (q.status === 'å¦') borderColor = '#ff7675';
            if (q.status === 'ä¸æ¡ˆæƒ…æ— å…³') borderColor = '#95a5a6';
            
            item.style.borderLeftColor = borderColor;
            
            item.innerHTML = `
                <div style="font-weight:bold;">${q.text}</div>
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#666; margin-top:3px;">
                    <span>${q.time}</span>
                    <span style="color:${borderColor}; font-weight:bold;">${q.status}</span>
                </div>
            `;
            
            container.appendChild(item);
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
    },
    
    showHint: function() {
        Message.show('æç¤ºï¼šå¼•å¯¼å­¦ç”Ÿæå‡º"æ˜¯/å¦"é—®é¢˜æ¥ç¼©å°çœŸç›¸èŒƒå›´', 'info');
    },
    
    revealAnswer: function() {
        if (!this.currentQuestion || !this.currentQuestion.a) {
            Message.show('é¢˜ç›®åŠ è½½ä¸­...', 'warning');
            return;
        }
        
        const answerText = this.currentQuestion.a;
        
        // åˆ›å»ºç­”æ¡ˆæ˜¾ç¤ºå¼¹çª—
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay show';
        overlay.style.zIndex = '3000';
        overlay.innerHTML = `
            <div class="modal-card" style="max-width: 600px;">
                <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin:0;">ğŸ” çœŸç›¸æ­æ™“</h3>
                    <button class="btn btn-sm btn-outline" onclick="this.parentElement.parentElement.parentElement.remove()">å…³é—­</button>
                </div>
                <div style="padding: 30px;">
                    <div style="font-size: 1.2rem; line-height: 1.6; color: #444; margin-bottom: 20px;">
                        ${this.currentQuestion.q}
                    </div>
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border-left: 5px solid #2ecc71;">
                        <h4 style="margin-top:0; color:#2ecc71;">çœŸç›¸ï¼š</h4>
                        <div style="font-size: 1.1rem;">${answerText}</div>
                    </div>
                    ${this.questions.length > 0 ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                            <h4>ğŸ“ æé—®è®°å½•ç»Ÿè®¡</h4>
                            <div style="color:#666;">å…± ${this.questions.length} ä¸ªé—®é¢˜</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        SoundManager.reveal();
    }
};

// è„‘ç­‹æ€¥è½¬å¼¯æ¸¸æˆ
const brainTeaser = {
    currentQuestion: null,
    timer: null,
    timeLeft: 30,
    
    init: function() {
        // é‡ç½®çŠ¶æ€
        this.stopTimer();
        this.timeLeft = GameConfigs.TIMERS.BRAIN_TEASER;
        
        // è·å–éšæœºé¢˜ç›®
        this.loadRandomQuestion();
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateDisplay();
        
        // æ›´æ–°å­¦ç”Ÿé€‰æ‹©åˆ—è¡¨
        this.updateWinnerSelect();
        
        // é‡ç½®è®¡æ—¶å™¨æ˜¾ç¤º
        const timerEl = document.getElementById('teaserTimer');
        if (timerEl) {
            timerEl.innerText = `${this.timeLeft}s`;
            timerEl.style.color = 'red';
            timerEl.style.animation = '';
        }
        
        // é‡ç½®ç­”æ¡ˆåŒºåŸŸ
        const answerEl = document.getElementById('teaserAnswer');
        if (answerEl) {
            answerEl.style.display = 'none';
            answerEl.innerHTML = '<strong>ç­”æ¡ˆï¼š</strong>...';
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        SoundManager.click();
        
        // è‡ªåŠ¨å¯åŠ¨è®¡æ—¶å™¨
        this.startTimer();
    },
    
    loadRandomQuestion: function() {
        try {
            this.currentQuestion = QuestionManager.getRandom('brainTeaser');
            
            // ç¡®ä¿é¢˜ç›®æ ¼å¼æ­£ç¡®
            if (!this.currentQuestion) {
                this.currentQuestion = { q: "é¢˜ç›®åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•", a: "æœªçŸ¥" };
            } else if (typeof this.currentQuestion === 'string') {
                this.currentQuestion = { q: this.currentQuestion, a: "è¯·æŸ¥çœ‹ç­”æ¡ˆ" };
            }
        } catch (error) {
            console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
            this.currentQuestion = { 
                q: "ğŸ› ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•", 
                a: "è¯·è”ç³»ç®¡ç†å‘˜" 
            };
        }
    },
    
    updateDisplay: function() {
        if (!this.currentQuestion || !document.getElementById('teaserQuestion')) return;
        
        const questionText = typeof this.currentQuestion === 'object' 
            ? this.currentQuestion.q 
            : this.currentQuestion;
        
        document.getElementById('teaserQuestion').innerText = questionText || "åŠ è½½ä¸­...";
    },
    
    updateWinnerSelect: function() {
        const select = document.getElementById('teaserWinner');
        if (!select) return;
        
        const names = DataManager.getNames();
        select.innerHTML = '<option value="">é€‰æ‹©ç­”å¯¹çš„å­¦ç”Ÿ...</option>';
        names.forEach(name => {
            select.add(new Option(name, name));
        });
    },
    
    startTimer: function() {
        this.stopTimer(); // ç¡®ä¿æ²¡æœ‰é‡å¤çš„è®¡æ—¶å™¨
        
        const timerEl = document.getElementById('teaserTimer');
        if (!timerEl) return;
        
        this.timer = TimerManager.setInterval(() => {
            this.timeLeft--;
            timerEl.innerText = `${this.timeLeft}s`;
            
            // é¢œè‰²å˜åŒ–
            if (this.timeLeft <= 10) {
                timerEl.style.color = '#ff6b6b';
                timerEl.style.animation = 'pulse 0.5s infinite';
            } else if (this.timeLeft <= 20) {
                timerEl.style.color = '#ffa502';
            }
            
            // éŸ³æ•ˆæç¤º
            if (this.timeLeft <= 5 && this.timeLeft > 0) {
                SoundManager.tick();
            }
            
            // æ—¶é—´åˆ°
            if (this.timeLeft <= 0) {
                this.stopTimer();
                SoundManager.error();
                Message.show('æ—¶é—´åˆ°ï¼å³å°†æ˜¾ç¤ºç­”æ¡ˆ', 'warning');
                
                // è‡ªåŠ¨æ˜¾ç¤ºç­”æ¡ˆ
                setTimeout(() => {
                    this.showAnswer();
                }, 1000);
            }
        }, 1000);
    },
    
    stopTimer: function() {
        if (this.timer) {
            TimerManager.clearInterval(this.timer);
            this.timer = null;
        }
        
        // é‡ç½®è®¡æ—¶å™¨æ ·å¼
        const timerEl = document.getElementById('teaserTimer');
        if (timerEl) {
            timerEl.style.animation = '';
        }
    },
    
    showAnswer: function() {
        if (!this.currentQuestion) return;
        
        this.stopTimer();
        
        const answer = typeof this.currentQuestion === 'object' 
            ? this.currentQuestion.a 
            : "æœªçŸ¥ç­”æ¡ˆ";
        
        const answerEl = document.getElementById('teaserAnswer');
        if (answerEl) {
            answerEl.innerHTML = `<strong>ç­”æ¡ˆï¼š</strong>${answer}`;
            answerEl.style.display = 'block';
            answerEl.style.animation = 'slideUp 0.5s ease-out';
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        SoundManager.reveal();
    },
    
    next: function() {
        // åœæ­¢å½“å‰è®¡æ—¶å™¨
        this.stopTimer();
        
        // åŠ è½½æ–°é¢˜ç›®
        this.loadRandomQuestion();
        this.timeLeft = GameConfigs.TIMERS.BRAIN_TEASER;
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateDisplay();
        
        // é‡ç½®è®¡æ—¶å™¨æ˜¾ç¤º
        const timerEl = document.getElementById('teaserTimer');
        if (timerEl) {
            timerEl.innerText = `${this.timeLeft}s`;
            timerEl.style.color = 'red';
            timerEl.style.animation = '';
        }
        
        // éšè—ç­”æ¡ˆ
        const answerEl = document.getElementById('teaserAnswer');
        if (answerEl) {
            answerEl.style.display = 'none';
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        SoundManager.click();
        
        // è‡ªåŠ¨å¼€å§‹è®¡æ—¶å™¨
        this.startTimer();
    },
    
    awardPoints: function() {
        const winnerSelect = document.getElementById('teaserWinner');
        const winner = winnerSelect ? winnerSelect.value : '';
        
        if (!winner) {
            Message.show('è¯·é€‰æ‹©ç­”å¯¹çš„å­¦ç”Ÿ', 'warning');
            return;
        }
        
        // åŠ åˆ†
        scoreSys.change(winner, 2, "è„‘ç­‹æ€¥è½¬å¼¯ç­”å¯¹", false);
        
        // æ’­æ”¾éŸ³æ•ˆ
        SoundManager.win();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        Message.show(`${winner} ç­”å¯¹äº†ï¼+2åˆ†`, 'success');
        
        // è‡ªåŠ¨ä¸‹ä¸€é¢˜
        setTimeout(() => {
            this.next();
        }, 2000);
    }
};

// V14ä¼˜åŒ–ï¼šçœ¼ç–¾æ‰‹å¿«æ¸¸æˆ
const reflexGame = {
    players: [], results: [], state: 0,
    
    reset: function() {
        document.getElementById('reflexSetup').style.display = 'block';
        document.getElementById('reflexPlay').style.display = 'none';
        document.getElementById('reflexResult').style.display = 'none';
        this.players = []; this.results = [];
    },
    
    // V13æ–°å¢ï¼šå¸¦éšæœºæŠ½å–çš„å‡†å¤‡å‡½æ•°
    prepareWithSelection: function() {
        const cnt = parseInt(document.getElementById('reflexCount').value);
        const all = DataManager.getNames();
        
        if(cnt > all.length) {
            Message.show('äººæ•°ä¸è¶³', 'warning');
            return;
        }
        
        // ä½¿ç”¨AutoSelectorè¿›è¡ŒéšæœºæŠ½å–
        AutoSelector.enhancedSelect(cnt, [], null, (selected) => {
            this.players = selected;
            this.idx = 0;
            
            // æ˜¾ç¤ºç©å®¶åå•
            this.displayPlayerList();
            
            this.startPlayer();
            document.getElementById('reflexSetup').style.display = 'none';
            document.getElementById('reflexPlay').style.display = 'block';
            Message.show(`å·²éšæœºæŠ½å– ${cnt} åé€‰æ‰‹`, 'success');
        });
    },
    
    // æ˜¾ç¤ºç©å®¶åå•çš„å‡½æ•°
    displayPlayerList: function() {
        const statusEl = document.getElementById('reflexStatus');
        if (!statusEl) return;
        
        // åˆ›å»ºç©å®¶åå•HTML
        let playersHtml = `
            <div style="margin-bottom: 20px; padding: 15px; background: #f0f4f8; border-radius: 12px; text-align: left;">
                <div style="font-weight: bold; color: var(--primary-blue); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ‘¥ å‚èµ›é€‰æ‰‹åå•</span>
                    <span style="font-size: 0.9rem; color: #666;">å…± ${this.players.length} äºº</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        `;
        
        // æ·»åŠ æ¯ä¸ªé€‰æ‰‹çš„å¡ç‰‡
        this.players.forEach((player, index) => {
            playersHtml += `
                <div class="player-tag" id="playerTag${index}" 
                     style="padding: 8px 15px; background: white; border-radius: 20px; 
                            border: 2px solid #eee; display: inline-flex; align-items: center; gap: 8px;
                            transition: all 0.3s; font-weight: normal;">
                    <span style="color: #666; font-size: 0.9rem;">${index + 1}</span>
                    <span>${player}</span>
                </div>
            `;
        });
        
        playersHtml += `
                </div>
            </div>
        `;
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç©å®¶åå•å®¹å™¨ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»º
        let playersContainer = document.getElementById('reflexPlayersContainer');
        if (!playersContainer) {
            playersContainer = document.createElement('div');
            playersContainer.id = 'reflexPlayersContainer';
            // æ’å…¥åˆ°çŠ¶æ€æ˜¾ç¤ºä¹‹å‰
            statusEl.parentNode.insertBefore(playersContainer, statusEl);
        }
        
        playersContainer.innerHTML = playersHtml;
    },
    
    // é«˜äº®å½“å‰é€‰æ‰‹
    highlightCurrentPlayer: function() {
        if (this.idx < this.players.length) {
            // ç§»é™¤æ‰€æœ‰é€‰æ‰‹çš„é«˜äº®
            document.querySelectorAll('.player-tag').forEach(tag => {
                tag.style.background = 'white';
                tag.style.borderColor = '#eee';
                tag.style.fontWeight = 'normal';
                tag.style.color = '#333';
                tag.style.boxShadow = 'none';
            });
            
            // é«˜äº®å½“å‰é€‰æ‰‹
            const currentTag = document.getElementById(`playerTag${this.idx}`);
            if (currentTag) {
                currentTag.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                currentTag.style.borderColor = 'var(--primary-blue)';
                currentTag.style.fontWeight = 'bold';
                currentTag.style.color = 'white';
                currentTag.style.boxShadow = '0 4px 15px rgba(79, 172, 254, 0.3)';
            }
        }
    },
    
    // ä¿ç•™åŸæœ‰å‡½æ•°ç”¨äºå…¼å®¹
    prepare: function() {
        const cnt = parseInt(document.getElementById('reflexCount').value);
        const all = DataManager.getNames();
        if(cnt > all.length) {
            Message.show('äººæ•°ä¸è¶³', 'warning');
            return;
        }
        this.players = [...all].sort(()=>0.5-Math.random()).slice(0, cnt);
        this.idx = 0;
        
        // æ˜¾ç¤ºç©å®¶åå•
        this.displayPlayerList();
        
        this.startPlayer();
        document.getElementById('reflexSetup').style.display = 'none';
        document.getElementById('reflexPlay').style.display = 'block';
    },
    
    startPlayer: function() {
        if(this.idx >= this.players.length) { 
            this.showRes(); 
            return; 
        }
        this.curr = this.players[this.idx];
        document.getElementById('reflexPlayerName').innerText = this.curr;
        document.getElementById('reflexStatus').innerText = `${this.idx+1}/${this.players.length}`;
        
        // é«˜äº®å½“å‰é€‰æ‰‹
        this.highlightCurrentPlayer();
        
        this.resetBox();
    },
    
    resetBox: function() {
        const b = document.getElementById('reflexBox'); 
        b.style.background='#e0e0e0'; 
        b.innerText='ç‚¹æˆ‘å¼€å§‹'; 
        this.state='idle';
    },
    
    handleClick: function() {
        const b = document.getElementById('reflexBox');
        if(this.state==='idle') {
            this.state='wait'; 
            b.innerText='ç­‰å¾…å˜ç»¿...'; 
            b.style.background='#ff7675';
            this.tm = setTimeout(() => {
                this.state='ready'; 
                b.style.background='#55efc4'; 
                b.innerText='ç‚¹æˆ‘!!!'; 
                this.st = Date.now(); 
                SoundManager.click();
            }, 1000+Math.random()*2000);
        } else if(this.state==='wait') {
            clearTimeout(this.tm); 
            b.innerText='å¤ªæ—©äº†!'; 
            SoundManager.error(); 
            this.state='idle'; 
            setTimeout(()=>this.resetBox(), 1000);
        } else if(this.state==='ready') {
            const t = Date.now() - this.st;
            b.innerText = t + 'ms'; 
            SoundManager.win();
            this.results.push({name:this.curr, time:t});
            this.state='done';
            
            // æ ‡è®°å½“å‰é€‰æ‰‹å·²å®Œæˆ
            this.markPlayerComplete();
            
            setTimeout(() => { 
                this.idx++; 
                this.startPlayer(); 
            }, 1500);
        }
    },
    
    // æ ‡è®°é€‰æ‰‹å·²å®Œæˆ
    markPlayerComplete: function() {
        const currentTag = document.getElementById(`playerTag${this.idx}`);
        if (currentTag) {
            currentTag.style.background = '#f0f4f8';
            currentTag.style.borderColor = '#d1d5db';
            currentTag.style.color = '#666';
            currentTag.style.opacity = '0.8';
            currentTag.innerHTML += ' âœ…';
        }
    },
    
    showRes: function() {
        document.getElementById('reflexPlay').style.display = 'none';
        document.getElementById('reflexResult').style.display = 'block';
        
        // åœ¨ç»“æœé¡µé¢ä¹Ÿæ˜¾ç¤ºç©å®¶åå•å’Œæˆç»©
        const tb = document.getElementById('reflexRankBody'); 
        tb.innerHTML='';
        this.results.sort((a,b)=>a.time-b.time);
        
        let resultsHtml = `
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                <div style="font-weight: bold; color: var(--primary-blue); margin-bottom: 10px;">
                    ğŸ æ¯”èµ›ç»“æœ - å…± ${this.players.length} åé€‰æ‰‹
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
        `;
        
        // æ˜¾ç¤ºæ‰€æœ‰é€‰æ‰‹çš„ç»“æœæ ‡ç­¾
        this.results.forEach((r,i) => {
            const bonus = i===0?3:(i===1?2:(i===2?1:0));
            r.bonus = bonus;
            
            let badgeColor = '#e0e0e0';
            let badgeText = `${i+1}å`;
            if (i === 0) { badgeColor = '#ffd700'; badgeText = 'ğŸ¥‡ å† å†›'; }
            else if (i === 1) { badgeColor = '#c0c0c0'; badgeText = 'ğŸ¥ˆ äºšå†›'; }
            else if (i === 2) { badgeColor = '#cd7f32'; badgeText = 'ğŸ¥‰ å­£å†›'; }
            
            resultsHtml += `
                <div style="padding: 10px 15px; background: white; border-radius: 10px; border-left: 4px solid ${badgeColor};
                           display: flex; align-items: center; justify-content: space-between; min-width: 180px;">
                    <div>
                        <div style="font-weight: bold; color: #333;">${r.name}</div>
                        <div style="font-size: 0.9rem; color: #666;">${r.time}ms</div>
                    </div>
                    <div style="background: ${badgeColor}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">
                        ${badgeText}
                    </div>
                </div>
            `;
        });
        
        resultsHtml += `
                </div>
            </div>
        `;
        
        // åœ¨ç»“æœè¡¨æ ¼ä¹‹å‰æ’å…¥ç»“æœæ‘˜è¦
        const resultContainer = document.getElementById('reflexResult');
        const existingSummary = document.getElementById('reflexResultSummary');
        if (existingSummary) {
            existingSummary.remove();
        }
        
        const summaryDiv = document.createElement('div');
        summaryDiv.id = 'reflexResultSummary';
        summaryDiv.innerHTML = resultsHtml;
        resultContainer.insertBefore(summaryDiv, tb.parentNode);
        
        // å¡«å……è¡¨æ ¼æ•°æ®
        this.results.forEach((r,i) => {
            const bonus = r.bonus;
            tb.innerHTML += `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.time}ms</td><td style="color:${bonus?'red':'#999'}">+${bonus}</td></tr>`;
        });
    },
    
    settleScores: function() {
        this.results.forEach(r => { 
            if(r.bonus) scoreSys.change(r.name, r.bonus, "çœ¼ç–¾æ‰‹å¿«", false); 
        });
        Message.show('å·²å¥–åŠ±å‰ä¸‰åï¼', 'success');
    }
};

// æ•°å­¦é€Ÿç®—æ¸¸æˆ
const mathRace = {
    players: [], scores: [0, 0], currentRound: 0, totalRounds: 5, currentQuestion: null, 
    level: 'easy', timer: null, nextTimer: null, isPlaying: false,
    
    init: function() {
        this.updatePlayerSelects();
        document.getElementById('mathSetup').style.display = 'block';
        document.getElementById('mathRace').style.display = 'none';
        document.getElementById('mathResult').style.display = 'none';
        this.isPlaying = false;
        
        // V14ä¼˜åŒ–ï¼šä½¿ç”¨é‡æ„çš„è™šæ‹Ÿé”®ç›˜
        setTimeout(() => {
            VirtualKeyboard.attachToGame('math', ['mathInput1', 'mathInput2']);
        }, 100);
    },
    
    updatePlayerSelects: function() {
        const names = DataManager.getNames();
        const s1 = document.getElementById('mathPlayer1'), s2 = document.getElementById('mathPlayer2');
        s1.innerHTML = s2.innerHTML = '<option value="">é€‰æ‹©é€‰æ‰‹</option>';
        names.forEach(n => { 
            s1.add(new Option(n, n)); 
            s2.add(new Option(n, n)); 
        });
    },
    
    start: function() {
        const p1 = document.getElementById('mathPlayer1').value, p2 = document.getElementById('mathPlayer2').value;
        if (!p1 || !p2 || p1 === p2) {
            Message.show('è¯·é€‰æ‹©ä¸¤åä¸åŒçš„é€‰æ‰‹ï¼', 'warning');
            return;
        }
        this.players = [p1, p2]; 
        this.scores = [0, 0]; 
        this.currentRound = 0;
        this.totalRounds = parseInt(document.getElementById('mathRounds').value) || 5;
        this.level = document.getElementById('mathLevel').value;
        document.getElementById('player1Name').innerText = p1; 
        document.getElementById('player2Name').innerText = p2;
        document.getElementById('player1Score').innerText = '0.0'; 
        document.getElementById('player2Score').innerText = '0.0';
        document.getElementById('mathSetup').style.display = 'none';
        document.getElementById('mathRace').style.display = 'block';
        this.nextQuestion(); 
        this.isPlaying = true;
    },
    
    generateQuestion: function() {
        const qStr = QuestionManager.getRandom('math', this.level);
        let q, a;
        if (typeof qStr === 'string') {
            try { 
                q = qStr; 
                // V14ä¿®å¤ï¼šé¿å…evalå®‰å…¨é—®é¢˜ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„è®¡ç®—
                a = this.safeEval(qStr.replace('Ã—', '*').replace('Ã·', '/')); 
            } catch { 
                q="1+1"; 
                a=2; 
            }
        } else { 
            q = qStr.q; 
            a = qStr.a; 
        }
        return { question: q, answer: a };
    },
    
    // V14æ–°å¢ï¼šå®‰å…¨çš„è¡¨è¾¾å¼æ±‚å€¼
    safeEval: function(expr) {
        // ç®€å•çš„å®‰å…¨æ±‚å€¼ï¼Œä»…æ”¯æŒåŸºæœ¬ç®—æœ¯
        try {
            // ä½¿ç”¨Functionæ„é€ å™¨åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­æ±‚å€¼
            return new Function('return ' + expr)();
        } catch (e) {
            console.error('è¡¨è¾¾å¼æ±‚å€¼é”™è¯¯:', expr, e);
            return 0;
        }
    },
    
    nextQuestion: function() {
        this.currentRound++;
        if (this.currentRound > this.totalRounds) { 
            this.endGame(); 
            return; 
        }
        document.getElementById('currentRound').innerText = this.currentRound;
        document.getElementById('mathAnswer').innerText = '';
        this.currentQuestion = this.generateQuestion();
        document.getElementById('mathQuestion').innerText = `${this.currentQuestion.question} = ?`;
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('mathInput1').value = '';
        document.getElementById('mathInput2').value = '';
        
        document.getElementById('player1Card').classList.remove('active');
        document.getElementById('player2Card').classList.remove('active');
        
        // å–æ¶ˆå€’è®¡æ—¶ï¼Œæ”¹ä¸ºä¸é™åˆ¶æ—¶é—´
        this.startTimer();
    },
    
    startTimer: function() {
        const el = document.getElementById('mathTimer');
        el.innerText = 'ä¸é™æ—¶';
        el.style.color = 'var(--primary-blue)';
        // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
        if (this.timer) {
            TimerManager.clearInterval(this.timer);
            this.timer = null;
        }
    },
    
    submitAnswer: function(playerNum) {
        if (!this.isPlaying) return;
        
        const input = document.getElementById(`mathInput${playerNum}`);
        const userAnswer = input ? input.value.trim() : '';
        const correctAnswer = this.currentQuestion.answer.toString();
        
        // V14ä¿®å¤ï¼šå¤„ç†å°æ•°ç²¾åº¦
        let isCorrect = false;
        try {
            // å°è¯•å°†ç”¨æˆ·ç­”æ¡ˆè½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
            const userNum = parseFloat(userAnswer);
            const correctNum = parseFloat(correctAnswer);
            
            // å…è®¸ä¸€å®šçš„æµ®ç‚¹æ•°è¯¯å·®
            isCorrect = Math.abs(userNum - correctNum) < 0.0001;
        } catch (e) {
            // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒ
            isCorrect = userAnswer === correctAnswer;
        }
        
        if (isCorrect) {
            TimerManager.clearAll();
            const pIdx = playerNum - 1;
            
            document.getElementById(`player${playerNum}Card`).classList.add('active');
            
            // V14ä¿®å¤ï¼šä½¿ç”¨ç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—
            this.scores[pIdx] = parseFloat((this.scores[pIdx] + GameConfigs.SCORES.MATH_CORRECT).toFixed(1));
            
            // V14ä¿®å¤ï¼šæ ‡è®°ä¸ºè‡ªåŠ¨å¾—åˆ†
            scoreSys.change(this.players[pIdx], GameConfigs.SCORES.MATH_CORRECT, `é€Ÿç®—-èƒœ`, true);
            
            SoundManager.win();
            Message.show(`${this.players[pIdx]} å›ç­”æ­£ç¡®ï¼+0.2åˆ†`, 'success');
            
            // è‡ªåŠ¨è·³åˆ°ä¸‹ä¸€é¢˜
            setTimeout(() => {
                this.nextQuestion();
            }, 1500);
        } else {
            Message.show('ç­”æ¡ˆé”™è¯¯ï¼Œè¯·ç»§ç»­å°è¯•', 'warning');
            return;
        }
        
        // æ˜¾ç¤ºåˆ†æ•°ï¼ˆä¿ç•™ä¸€ä½å°æ•°ï¼‰
        document.getElementById(`player1Score`).innerText = this.scores[0].toFixed(1); 
        document.getElementById(`player2Score`).innerText = this.scores[1].toFixed(1);
        document.getElementById('mathAnswer').innerText = `ç­”æ¡ˆ: ${correctAnswer}`;
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('mathInput1').value = '';
        document.getElementById('mathInput2').value = '';
    },
    
    endGame: function() {
        this.isPlaying = false; 
        TimerManager.clearAll();
        document.getElementById('mathRace').style.display = 'none';
        document.getElementById('mathResult').style.display = 'block';
        
        // æ˜¾ç¤ºæœ€ç»ˆåˆ†æ•°ï¼ˆä¿ç•™ä¸€ä½å°æ•°ï¼‰
        const winIdx = this.scores[0] > this.scores[1] ? 0 : (this.scores[1] > this.scores[0] ? 1 : -1);
        let html = `<div style="display:flex; justify-content:center; gap:30px;">`;
        this.players.forEach((p, i) => {
            html += `<div style="background:${i===winIdx?'#e3f2fd':'#fff'}; padding:20px; border-radius:15px; border:2px solid ${i===winIdx?'var(--primary-blue)':'#eee'}">
                <h4>${i===winIdx?'ğŸ¥‡ å† å†›':'ğŸ¥ˆ äºšå†›'}</h4><h2>${p}</h2><h3>${this.scores[i].toFixed(1)}åˆ†</h3></div>`;
        });
        html += `</div>`;
        document.getElementById('mathResultContent').innerHTML = html;
        if(winIdx !== -1) scoreSys.change(this.players[winIdx], 1, "é€Ÿç®—ç«é€Ÿ-å† å†›", false);
    },
    
    restart: function() { this.init(); }
};

// V14ä¼˜åŒ–ï¼šå•è¯æ‹¼å†™æ¸¸æˆ
const spellingRace = {
    players: [], scores: [0, 0], currentRound: 0, totalRounds: 5, currentWord: null, 
    level: 'easy', timer: null, nextTimer: null, isPlaying: false,
    usedLetters: [[], []], // æ¯ä¸ªé€‰æ‰‹å·²ä½¿ç”¨çš„å­—æ¯
    
    init: function() {
        this.updatePlayerSelects();
        document.getElementById('spellingSetup').style.display = 'block';
        document.getElementById('spellingRace').style.display = 'none';
        document.getElementById('spellingResult').style.display = 'none';
        this.isPlaying = false;
        this.usedLetters = [[], []];
        
        // V14ä¼˜åŒ–ï¼šé™„åŠ é‡æ„çš„è™šæ‹Ÿé”®ç›˜ï¼ˆæ”¯æŒå¤šç‚¹è§¦æ§ï¼‰
        setTimeout(() => {
            if (typeof VirtualKeyboard !== 'undefined') {
                VirtualKeyboard.attachToGame('spelling', ['spellingInput1', 'spellingInput2']);
            }
        }, 100);
    },
    
    updatePlayerSelects: function() {
        const names = DataManager.getNames();
        const s1 = document.getElementById('spellingPlayer1'), s2 = document.getElementById('spellingPlayer2');
        s1.innerHTML = s2.innerHTML = '<option value="">é€‰æ‹©é€‰æ‰‹</option>';
        names.forEach(n => { 
            s1.add(new Option(n, n)); 
            s2.add(new Option(n, n)); 
        });
    },
    
    start: function() {
        const p1 = document.getElementById('spellingPlayer1').value, p2 = document.getElementById('spellingPlayer2').value;
        if (!p1 || !p2 || p1 === p2) {
            Message.show('è¯·é€‰æ‹©ä¸¤åä¸åŒçš„é€‰æ‰‹ï¼', 'warning');
            return;
        }
        this.players = [p1, p2]; 
        this.scores = [0, 0]; 
        this.currentRound = 0;
        this.usedLetters = [[], []];
        this.totalRounds = parseInt(document.getElementById('spellingRounds').value) || 5;
        this.level = document.getElementById('spellingLevel').value;
        document.getElementById('spellingPlayer1Name').innerText = p1; 
        document.getElementById('spellingPlayer2Name').innerText = p2;
        document.getElementById('spellingPlayer1Score').innerText = '0.0'; 
        document.getElementById('spellingPlayer2Score').innerText = '0.0';
        document.getElementById('spellingSetup').style.display = 'none'; 
        document.getElementById('spellingRace').style.display = 'block';
        this.nextWord(); 
        this.isPlaying = true;
    },
    
    nextWord: function() {
        this.currentRound++;
        if (this.currentRound > this.totalRounds) { 
            this.endGame(); 
            return; 
        }
        document.getElementById('spellingCurrentRound').innerText = this.currentRound;
        document.getElementById('spellingAnswer').innerText = '';
        this.usedLetters = [[], []];
        
        const wData = QuestionManager.getRandom('spelling', this.level);
        const w = (typeof wData === 'string') ? wData : wData.q || wData.word;
        // V14æ–°å¢ï¼šè·å–ä¸­æ–‡é‡Šä¹‰
        // å°è¯•ä»å¯¹è±¡çš„ a (answer), cn, meaning å±æ€§è·å–ï¼Œé€‚é…å¸¸è§æ•°æ®ç»“æ„
        const cn = (typeof wData === 'object') ? (wData.a || wData.cn || wData.meaning || '') : '';
        
        // ä½¿ç”¨æŒ–ç©ºæ¨¡å¼ç”Ÿæˆé¢˜ç›®
        this.currentWord = QuestionManager.generateWordBlank(w.toLowerCase(), this.level);
        
        // æ˜¾ç¤ºæŒ–ç©ºå•è¯
        const wordDisplay = document.getElementById('spellingWord');
        wordDisplay.innerHTML = this.currentWord.display
            .split('')
            .map((char, idx) => {
                if (char === '_') {
                    return `<span class="blank-char" data-index="${idx}" data-letter="${this.currentWord.answerMap.find(b => b.position === idx)?.letter || ''}">_</span>`;
                }
                return `<span style="display:inline-block; width:35px; text-align:center;">${char.toUpperCase()}</span>`;
            })
            .join('');
        
        // V14æ–°å¢ï¼šåœ¨æç¤ºæ ä¸­æ˜¾ç¤ºä¸­æ–‡é‡Šä¹‰
        let hintInfo = `å•è¯é•¿åº¦: ${this.currentWord.length} ä¸ªå­—æ¯, æŒ–ç©ºäº† ${this.currentWord.blanks.length} ä¸ªå­—æ¯`;
        if (cn) {
            // å¦‚æœæœ‰ä¸­æ–‡é‡Šä¹‰ï¼ŒåŠ ç²—å¹¶æ˜¾ç¤ºåœ¨æœ€å‰é¢
            hintInfo = `<span style="color: var(--primary-blue); font-weight: bold; margin-right: 15px; font-size: 1.1em;">ä¸­æ–‡: ${cn}</span> <span style="color: #666;">| ${hintInfo}</span>`;
        }
        
        document.getElementById('spellingHint').innerHTML = hintInfo;
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('spellingInput1').value = '';
        document.getElementById('spellingInput2').value = '';
        
        document.getElementById('spellingPlayer1Card').classList.remove('active');
        document.getElementById('spellingPlayer2Card').classList.remove('active');
        
        // å–æ¶ˆå€’è®¡æ—¶
        this.startTimer();
    },
    
    startTimer: function() {
        const el = document.getElementById('spellingTimer');
        el.innerText = 'ä¸é™æ—¶';
        el.style.color = 'var(--primary-blue)';
        // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
        if (this.timer) {
            TimerManager.clearInterval(this.timer);
            this.timer = null;
        }
    },
    
    // V14ä¼˜åŒ–ï¼šå¤„ç†å­—æ¯è¾“å…¥ï¼Œæ”¯æŒå¤šç‚¹è§¦æ§
    handleBlankInput: function(playerNum, letter) {
        if (!this.isPlaying) return;
        
        const playerIdx = playerNum - 1;
        letter = letter.toLowerCase();
        
        // æ£€æŸ¥å­—æ¯æ˜¯å¦å·²ç»ä½¿ç”¨è¿‡
        if (this.usedLetters[playerIdx].includes(letter)) {
            Message.show(`å­—æ¯ ${letter.toUpperCase()} å·²ç»ä½¿ç”¨è¿‡äº†ï¼`, 'warning');
            return;
        }
        
        // æ·»åŠ åˆ°å·²ä½¿ç”¨å­—æ¯åˆ—è¡¨
        this.usedLetters[playerIdx].push(letter);
        
        // æ£€æŸ¥æ˜¯å¦å¡«å¯¹äº†æŸä¸ªç©ºç™½
        const blankToFill = this.currentWord.answerMap.find(blank => 
            !blank.filled && blank.letter === letter
        );
        
        if (blankToFill) {
            blankToFill.filled = true;
            // æ›´æ–°æ˜¾ç¤º
            const blankEl = document.querySelector(`.blank-char[data-index="${blankToFill.position}"]`);
            if (blankEl) {
                blankEl.textContent = letter.toUpperCase();
                blankEl.classList.add('filled');
            }
            
            SoundManager.playTone(800, 'sine', 0.2);
            
            // V14ä¿®å¤ï¼šä½¿ç”¨ç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—
            this.scores[playerIdx] = parseFloat((this.scores[playerIdx] + GameConfigs.SCORES.SPELLING_CORRECT).toFixed(1));
            
            document.getElementById(`spellingPlayer${playerNum}Score`).innerText = this.scores[playerIdx].toFixed(1);
            
            // V14ä¿®å¤ï¼šæ ‡è®°ä¸ºè‡ªåŠ¨å¾—åˆ†
            scoreSys.change(this.players[playerIdx], GameConfigs.SCORES.SPELLING_CORRECT, `æ‹¼å†™-æ­£ç¡®`, true);
            
            Message.show(`é€‰æ‰‹${playerNum} å¡«å¯¹äº†å­—æ¯ ${letter.toUpperCase()}ï¼+0.2åˆ†`, 'success');
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰ç©ºç™½
            if (this.currentWord.answerMap.every(blank => blank.filled)) {
                Message.show(`å•è¯ ${this.currentWord.original.toUpperCase()} å®Œæˆï¼`, 'success');
                setTimeout(() => {
                    this.nextWord();
                }, 1500);
            }
        } else {
            SoundManager.error();
            
            // V14ä¿®å¤ï¼šä½¿ç”¨ç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—
            this.scores[playerIdx] = parseFloat((this.scores[playerIdx] + GameConfigs.SCORES.SPELLING_WRONG).toFixed(1));
            
            document.getElementById(`spellingPlayer${playerNum}Score`).innerText = this.scores[playerIdx].toFixed(1);
            
            // V14ä¿®å¤ï¼šæ ‡è®°ä¸ºè‡ªåŠ¨å¾—åˆ†
            scoreSys.change(this.players[playerIdx], GameConfigs.SCORES.SPELLING_WRONG, `æ‹¼å†™-é”™è¯¯`, true);
            
            Message.show(`å­—æ¯ ${letter.toUpperCase()} ä¸åœ¨ç©ºç¼ºä¸­ï¼Œ-0.1åˆ†`, 'warning');
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById(`spellingInput${playerNum}`).value = '';
    },
    
    // V14ä¼˜åŒ–ï¼šæäº¤ç­”æ¡ˆå‡½æ•°
    submitAnswer: function(playerNum) {
        const playerIdx = playerNum - 1;
        const completedCount = this.currentWord.answerMap.filter(blank => blank.filled).length;
        const totalBlanks = this.currentWord.blanks.length;
        
        if (completedCount === totalBlanks) {
            Message.show(`å•è¯ ${this.currentWord.original.toUpperCase()} å®Œæˆï¼`, 'success');
            setTimeout(() => {
                this.nextWord();
            }, 1500);
        } else {
            Message.show(`è¿˜æœ‰ ${totalBlanks - completedCount} ä¸ªç©ºç¼ºæœªå¡«`, 'warning');
        }
    },
    
    giveUp: function() {
        TimerManager.clearAll();
        document.getElementById('spellingAnswer').innerText = `æ­£ç¡®ç­”æ¡ˆ: ${this.currentWord.original}`;
        SoundManager.error();
        Message.show('è·³è¿‡å½“å‰å•è¯', 'info');
        
        // è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€é¢˜
        setTimeout(() => {
            this.nextWord();
        }, 2000);
    },
    
    endGame: function() {
        this.isPlaying = false; 
        TimerManager.clearAll();
        document.getElementById('spellingRace').style.display = 'none'; 
        document.getElementById('spellingResult').style.display = 'block';
        const winIdx = this.scores[0] > this.scores[1] ? 0 : (this.scores[1] > this.scores[0] ? 1 : -1);
        let html = `<div style="display:flex; justify-content:center; gap:30px;">`;
        this.players.forEach((p, i) => {
            html += `<div style="background:${i===winIdx?'#e3f2fd':'#fff'}; padding:20px; border-radius:15px; border:2px solid ${i===winIdx?'var(--primary-blue)':'#eee'}">
                <h4>${i===winIdx?'ğŸ¥‡ å† å†›':'ğŸ¥ˆ äºšå†›'}</h4><h2>${p}</h2><h3>${this.scores[i].toFixed(1)}åˆ†</h3></div>`;
        });
        html += `</div>`;
        document.getElementById('spellingResultContent').innerHTML = html;
        if(winIdx !== -1) scoreSys.change(this.players[winIdx], 1, "æ‹¼å†™ç«èµ›-å† å†›", false);
    },
    
    restart: function() { this.init(); }
};

// å…¶ä»–æ¸¸æˆæ¨¡å—ï¼ˆç®€åŒ–ç‰ˆï¼‰
const bombGame = {
    min: 0, max: 100, target: 0, players: [], currentPlayer: null, playerIndex: 0, punishments: ["å”±æ­Œ", "å­¦çŒ«å«", "æ·±è¹²", "å¤¸å¥–åŒæ¡Œ", "è®²ç¬‘è¯"], isActive: false,
    
    init: function() {
        this.min = 0; this.max = 100; this.target = Math.floor(Math.random() * 99) + 1; this.isActive = false; this.players = [];
        this.renderSetup();
    },
    
    renderSetup: function() {
        const names = DataManager.getNames();
        let html = `<div style="text-align:center; padding:20px;"><h3>ğŸ® é€‰æ‹©é€‰æ‰‹ (2äººä»¥ä¸Š)</h3>`;
        
        // V13æ–°å¢ï¼šéšæœºæŠ½å–é€‰æ‰‹æŒ‰é’®
        html += `<div style="margin-bottom:20px;">
            <button class="btn btn-primary" onclick="bombGame.randomSelectPlayers()">ğŸ² éšæœºæŠ½å–é€‰æ‰‹</button>
        </div>`;
        
        html += `<div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:20px 0;">`;
        names.forEach(n => html += `<div class="bomb-player-select" onclick="bombGame.togglePlayer('${n}', this)" style="padding:10px 15px; background:#f5f5f5; border-radius:10px; cursor:pointer;">${n}</div>`);
        html += `</div><button class="btn btn-primary" onclick="bombGame.start()">å¼€å§‹æ¸¸æˆ</button></div>`;
        document.getElementById('game-numberBomb').innerHTML = `<div class="screen-header"><h2>ğŸ’£ æ•°å­—ç‚¸å¼¹</h2><button class="btn btn-outline" onclick="bombGame.init()">é‡ç½®</button></div>` + html;
    },
    
    // V13æ–°å¢ï¼šéšæœºæŠ½å–é€‰æ‰‹
    randomSelectPlayers: function() {
        const names = DataManager.getNames();
        if (names.length < 2) {
            Message.show('å­¦ç”Ÿäººæ•°ä¸è¶³ï¼Œè¯·å…ˆæ·»åŠ å­¦ç”Ÿ', 'warning');
            return;
        }
        
        // éšæœºé€‰æ‹©2-5åé€‰æ‰‹
        const count = Math.min(5, Math.max(2, Math.floor(Math.random() * 4) + 2));
        AutoSelector.enhancedSelect(count, [], null, (selected) => {
            this.players = selected;
            this.renderSetup();
            
            // é«˜äº®æ˜¾ç¤ºè¢«é€‰ä¸­çš„é€‰æ‰‹
            selected.forEach(name => {
                const elements = document.querySelectorAll(`.bomb-player-select`);
                elements.forEach(el => {
                    if (el.textContent === name) {
                        el.style.background = '#e3f2fd';
                        el.style.border = '2px solid var(--primary-blue)';
                    }
                });
            });
            
            Message.show(`å·²éšæœºæŠ½å– ${count} åé€‰æ‰‹`, 'success');
        });
    },
    
    togglePlayer: function(n, el) {
        if(this.players.includes(n)) { 
            this.players = this.players.filter(p=>p!==n); 
            el.style.background='#f5f5f5'; 
            el.style.border='none'; 
        } else { 
            this.players.push(n); 
            el.style.background='#e3f2fd'; 
            el.style.border='2px solid var(--primary-blue)'; 
        }
    },
    
    start: function() {
        if(this.players.length < 2) {
            Message.show('è¯·è‡³å°‘é€‰æ‹©2åé€‰æ‰‹', 'warning');
            return;
        }
        this.playerIndex = 0; 
        this.currentPlayer = this.players[0]; 
        this.isActive = true;
        this.renderGame();
    },
    
    renderGame: function() {
        const html = `<div style="text-align:center; max-width:400px; margin:0 auto;">
            <div style="font-size:1.2rem; color:#666;">å½“å‰è½®åˆ°</div><div style="font-size:2rem; font-weight:bold; color:var(--primary-blue); margin:10px 0;" id="bombPlayer">${this.currentPlayer}</div>
            <div style="font-size:3rem; font-weight:bold; color:var(--primary-blue); margin:10px 0;" id="bombRange">${this.min} ~ ${this.max}</div>
            <input type="number" id="bombInput" style="font-size:2.5rem; text-align:center; width:100%; margin-bottom:20px;" placeholder="?" readonly>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;">
                ${[1,2,3,4,5,6,7,8,9].map(i => `<button class="btn btn-outline" onclick="bombGame.input(${i})">${i}</button>`).join('')}
                <button class="btn btn-danger" onclick="bombGame.clear()">C</button>
                <button class="btn btn-outline" onclick="bombGame.input(0)">0</button>
                <button class="btn btn-success" onclick="bombGame.guess()">ğŸ’¥</button>
            </div>
            <div id="bombPunish" style="margin-top:20px; padding:20px; background:#ffeaea; border-radius:10px; display:none;">
                <h3 style="color:#ff7675;">ğŸ’¥ çˆ†ç‚¸å•¦ï¼</h3><p id="bombPunishText" style="font-size:1.2rem; font-weight:bold;"></p>
                <button class="btn btn-warning" onclick="scoreSys.open()">â– æ‰£åˆ†</button>
                <button class="btn btn-primary" onclick="bombGame.init()">ğŸ”„ æ–°æ¸¸æˆ</button>
            </div>
        </div>`;
        document.getElementById('game-numberBomb').innerHTML = `<div class="screen-header"><h2>ğŸ’£ æ•°å­—ç‚¸å¼¹</h2><button class="btn btn-outline" onclick="bombGame.init()">é‡ç½®</button></div>` + html;
    },
    
    input: function(n) { if(!this.isActive) return; document.getElementById('bombInput').value += n; },
    clear: function() { if(!this.isActive) return; document.getElementById('bombInput').value = ''; },
    
    guess: function() {
        if(!this.isActive) return;
        const val = parseInt(document.getElementById('bombInput').value);
        if(isNaN(val)) return;
        if(val <= this.min || val >= this.max) { 
            Message.show(`è¯·è¾“å…¥ ${this.min} ~ ${this.max} ä¹‹é—´çš„æ•°å­—`, 'warning'); 
            this.clear(); 
            return; 
        }
        if(val === this.target) {
            SoundManager.error();
            document.getElementById('bombRange').innerText = "ğŸ’¥ çˆ†ç‚¸äº†!";
            const p = this.punishments[Math.floor(Math.random()*this.punishments.length)];
            document.getElementById('bombPunishText').innerText = `${this.currentPlayer} ä¸­æ‹›ï¼æƒ©ç½šï¼š${p}`;
            document.getElementById('bombPunish').style.display = 'block';
            scoreSys.change(this.currentPlayer, -2, "æ•°å­—ç‚¸å¼¹-çˆ†ç‚¸", false);
            this.players.forEach(p => { if(p!==this.currentPlayer) scoreSys.change(p, 1, "æ•°å­—ç‚¸å¼¹-å¹¸å­˜", false); });
            this.isActive = false;
        } else {
            SoundManager.click();
            if(val > this.target) this.max = val; else this.min = val;
            document.getElementById('bombRange').innerText = `${this.min} ~ ${this.max}`;
            this.clear();
            this.playerIndex = (this.playerIndex + 1) % this.players.length;
            this.currentPlayer = this.players[this.playerIndex];
            document.getElementById('bombPlayer').innerText = this.currentPlayer;
        }
    }
};

const namePicker = {
    timer: null,
    updateDisplay: function() {},
    toggle: function() {
        const names = DataManager.getNames();
        if(names.length === 0) {
            Message.show('è¯·å…ˆè®¾ç½®åå•', 'warning');
            return;
        }
        const el = document.getElementById('pickerDisplay'), btn = document.getElementById('pickerBtn');
        if(this.timer) {
            TimerManager.clearInterval(this.timer); 
            this.timer = null;
            btn.innerText = "ğŸ² å¼€å§‹ç‚¹å"; 
            btn.className = "btn btn-primary btn-lg";
            SoundManager.win();
        } else {
            btn.innerText = "ğŸ›‘ åœï¼"; 
            btn.className = "btn btn-danger btn-lg";
            this.timer = TimerManager.setInterval(() => { 
                el.innerText = names[Math.floor(Math.random()*names.length)]; 
                SoundManager.tick(); 
            }, 50);
        }
    }
};

const lotteryGame = {
    timer: null,
    toggle: function() {
        const list = document.getElementById('prizeInput').value.split('\n').filter(s=>s.trim());
        if(list.length === 0) {
            Message.show('å¥–æ± ä¸ºç©º', 'warning');
            return;
        }
        const el = document.getElementById('lotteryDisplay'), btn = document.getElementById('lotteryBtn');
        if(this.timer) {
            TimerManager.clearInterval(this.timer); 
            this.timer = null;
            btn.innerText = "ğŸ•¹ï¸ æ»šåŠ¨"; 
            SoundManager.win();
        } else {
            btn.innerText = "ğŸ›‘ åœ";
            this.timer = TimerManager.setInterval(() => { 
                el.innerText = list[Math.floor(Math.random()*list.length)]; 
                SoundManager.tick(); 
            }, 50);
        }
    }
};

const reverseGame = {
    timer: null, cmds: ["ä¸¾å·¦æ‰‹", "ä¸¾å³æ‰‹", "èµ·ç«‹", "åä¸‹", "æŠ¬å¤´", "ä½å¤´", "é—­çœ¼", "å¼ å˜´", "æ‘¸è€³æœµ"],
    next: function() {
        TimerManager.clearInterval(this.timer);
        const el = document.getElementById('reverseWord'); 
        let count = 0;
        this.timer = TimerManager.setInterval(() => {
            el.innerText = this.cmds[Math.floor(Math.random() * this.cmds.length)];
            count++; 
            SoundManager.tick();
            if(count > 15) { 
                TimerManager.clearInterval(this.timer); 
                SoundManager.win(); 
                el.style.color = '#ff7675'; 
            } else {
                el.style.color = '#a18cd1'; 
            }
        }, 80);
    }
};

/* ==========================================================================
   åˆå§‹åŒ–åº”ç”¨
   ========================================================================== */

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
    GameApp.init();
    Message.show('å¿«ä¹è¯¾å ‚ V14.0 å·²åŠ è½½å®Œæ¯•ï¼', 'success');
});

// é˜²æ­¢é¡µé¢æ»šåŠ¨
document.addEventListener('touchmove', function(e) {
    if(e.target.tagName === 'CANVAS') {
        e.preventDefault();
    }
}, { passive: false });
</script>
</body>
</html>